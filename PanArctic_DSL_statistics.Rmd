---
title: "PanArctic DSL - Statistics"
author: "[Pierre Priou](mailto:pierre.priou@mi.mun.ca)"
date: "`r format(Sys.time(), '%Y/%m/%d at %H:%M')`"
output: 
  html_document:
    keep_md: yes
  github_document:
    always_allow_html: true
---

# Goals

The goal of the statistics are to investigate the potential effects of primary production and advection on mesopelagic backscatter for each Arctic region. Therefore, I gathered remote sensing data of sea ice concentration and ocean colour, and modelled advection from Copernicus.

Since remote sensing of primary production (chlorophyll *a*) can be biased by high concentration of CDOM (chromophoric dissolved organic matter) and the photoadptation of Arctic phytoplankton (Lewis et al. 2016), I use to variables as proxy for primary production. First, I use the satellite-derived monthly averaged chlrophyll *a* concentration from CMEMS (doi: [10.48670/moi-00066](https://doi.org/10.48670/moi-00066)), and I calculate the open water days from sea ice concentration from the EUMETSAT OSI SAF remote sensing dataset (doi: [10.24381/cds.3cd8b812](https://doi.org/10.24381/cds.3cd8b812)) which I use as a proxy for primary production. For advection I use data from the Copernicus Marine Environmental Monitoring Service Arctic Ocean Physics Reanalysis product which gives monthly average of current velocity in the Arctic Ocean.

# Package loading

```{r package-loading, message=FALSE, warning=FALSE}
# Load packages
library(tidyverse)    # Tidy code
library(cowplot)      # Plots on a grid
library(raster)       # Data gridding
library(sf)           # Spatial data
library(rgdal)        # Read shapefiles
library(ggpubr)       # Deal with stats
library(ggfortify)    # Plotting glm
library(RColorBrewer) # Diverging colour palettes
library(cmocean)      # Oceanographic colour palettes
library(moments)      # Overlay distributions
library(ggcorrplot)   # Correlation plots
library(kableExtra)   # Pretty tables
library(mgcv)         # Fit GAM
library(gratia)       # Visualise GAM
library(visreg)       # Visualise GAM
library(tidymv)       # Predict GAM
library(MuMIn)        # AIC weights
library(DT)           # Interactive table
library(rstatix)      # Pipe-friendly stats
# Custom figure theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size = 9),
             axis.title = element_text(size = 9),
             strip.text.x = element_text(size = 9, face = "plain", hjust = 0.5),
             strip.background = element_rect(colour = "transparent",
                                             fill = "transparent"),
             legend.title = element_text(size = 9),
             legend.margin = margin(0, 0, 0, 0),
             legend.box.margin = margin(0, 0, -8, 0),
             panel.grid = element_blank(), 
             plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "in"))
options(dplyr.summarise.inform = F) # Suppress summarise() warning
```

```{r data-loading, message=FALSE}
# Laea projection
cell_res <- 25 # Cell resolution in km
arctic_laea <- raster(extent(-2700, 2700, -2700, 2700), crs = "EPSG:6931")
projection(arctic_laea) <- gsub("units=m", "units=km", 
                                projection(arctic_laea)) # Convert from m to km
res(arctic_laea) <- c(cell_res, cell_res) # Define the 100 km cell resolution

# Coastline shapefiles reprojected to laea
coast_10m_laea <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% 
  spTransform(CRSobj = crs("EPSG:4326")) %>% # Verify that the shapefile proj is the right one
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to a dataframe for ggplot
  rename(xc = long, yc = lat)

# Gridded acoustic, CTD, and sea ice data
load("data/acoustics/SA_grids.RData") # Acoustic data
load("data/remote_sensing/physics_grids.RData") # Modelled physics data 
load("data/remote_sensing/seaice_grids.RData") # Remote sensing sea ice data
load("data/remote_sensing/chl_grid.RData") # Remote sensing sea ice data
```

# Data preparation

I combine backscatter and environmental data which were gridded on the Lambert Azimuthal Equal Area grid (EPSG:6931). Since I do not have a lot of samples from the the Beaufort Sea and West Arctic Ocean, I combine those two regions due to their geographical proximity.

```{r combine-data}
# Prepare datasets
SA_laea <- SA_grid_laea %>%  # Gridded SA
  dplyr::select(-lat, -lon) 
phy_laea <- phy_grid_laea %>% # Remote sensing: physics reanalysis
  dplyr::select(year, area, xc, yc, cell_res, depth, thetao, velocity, so)
seaice_laea <- seaice_grid_laea %>% # Remote sensing: seaice concentration
  dplyr::select(year, area, xc, yc, cell_res, openwater_duration, mean_ice_conc)
chl_laea <- chl_grid_laea %>% # Remote sensing: chlorophyll a
  dplyr::select(-lat, -lon)

stat_laea <- SA_laea %>%
  left_join(., phy_laea, by = c("year", "xc", "yc", "area", "cell_res")) %>% 
  left_join(., seaice_laea, by = c("year", "xc", "yc", "area", "cell_res")) %>%
  left_join(., chl_laea, by = c("year", "xc", "yc", "area", "cell_res")) %>%
  filter(depth == 222) # Select physics at 222 m depth
```

There are NAs in the remote sensing dataset.

```{r map-NA, fig.width=8, fig.height=6}
plot_grid(stat_laea %>% 
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = chl)) +
            scale_colour_cmocean(name = "algae", na.value = "red") + 
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(), 
                  axis.title = element_blank()),
          stat_laea %>% 
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = openwater_duration)) +
            scale_colour_viridis_c("ow", na.value = "red") + 
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(), 
                  axis.title = element_blank()),
          ncol = 1, align = "hv", axis = "tblr")
```

This is because the coverage of acoustic data and remote sensing products slightly differ close to the coasts. For sea ice concentration (and open water duration) the NAs are close to land while for ocean colour they are in ice covered areas. I use the average value of neighbouring cells (8 cells around the pixel of interest) to fill missing values.

```{r fill-NAs}
stat_laea <- stat_laea %>%
  rowwise() %>%
  mutate( 
    # Physics
    xc_phy = if_else(is.na(openwater_duration) == T, xc, NaN),
    yc_phy = if_else(is.na(openwater_duration) == T, yc, NaN),
    year_phy = if_else(is.na(openwater_duration) == T, year, NaN), 
    openwater_duration = if_else(
      is.na(openwater_duration) == T,
      mean(pull(subset(seaice_grid_laea, 
                       xc >= xc_phy - cell_res & xc <= xc_phy + cell_res & 
                         yc >= yc_phy - cell_res & yc <= yc_phy + cell_res & 
                         year == year_phy,
                       select = openwater_duration),
                openwater_duration),
           na.rm = T),
      openwater_duration),
    mean_ice_conc = if_else(
      is.na(mean_ice_conc) == T, 
      mean(pull(subset(seaice_grid_laea,
                       xc >= xc_phy - cell_res & xc <= xc_phy + cell_res & 
                         yc >= yc_phy - cell_res & yc <= yc_phy + cell_res & 
                         year == year_phy,
                       select = mean_ice_conc),
                mean_ice_conc),
           na.rm = T),
      mean_ice_conc),
    # Ocean colour
    xc_chl = if_else(is.na(chl) == T, xc, NaN),
    yc_chl = if_else(is.na(chl) == T, yc, NaN),
    year_chl = if_else(is.na(chl) == T, year, NaN), 
    chl = if_else(
      is.na(chl) == T,
      mean(pull(subset(chl_grid_laea, 
                       xc >= xc_chl - cell_res & xc <= xc_chl + cell_res & 
                         yc >= yc_chl - cell_res & yc <= yc_chl + cell_res & 
                         year == year_chl,
                       select = chl),
                chl),
           na.rm = T),
      chl),
    # Convert veloctity to cm/s
    velocity = velocity * 100, 
    IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                IHO_area == "The Northwestern Passages" ~ "CAA",
                                IHO_area == "Baffin Bay" ~ "BB",
                                IHO_area == "Davis Strait" ~ "DS"),
                      levels = c("WAO_BF", "BF", "CAA", "BB", "DS", "EAO"))) %>%
  filter(depth == 222) %>% # Select physics at 222 m depth
  ungroup() %>%
  dplyr::select(-xc_phy, -yc_phy, -year_phy, -xc_chl, -yc_chl, -year_chl)
```

Check if I replace NAs correctly.

```{r map-NA-fix, fig.width=8, fig.height=6}
plot_grid(stat_laea %>% 
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = chl)) +
            scale_colour_cmocean(name = "algae", na.value = "red") + 
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(), 
                  axis.title = element_blank()),
          stat_laea %>%
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = openwater_duration)) +
            scale_colour_viridis_c("ow", na.value = "red") +
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(),
                  axis.title = element_blank()),
          ncol = 1, align = "hv", axis = "tblr")
```

NA replacement worked well for ice concentration. Since the missing chl values are for areas with at least 76 % ice concentration and less than 8 days of open water, I use the median chl value in those conditions, which is 0.2600639mg m-3.

```{r median-chl}
stat_laea %>%
  filter(mean_ice_conc > 76) %>%
  summarise(median_chl = median(chl, na.rm = T))
```

```{r fill-NA-chl}
stat_laea <- stat_laea %>%
  rowwise() %>%
  mutate(chl = if_else(is.na(chl) == T, 0.2600639, chl)) %>% 
  ungroup()
```

```{r map-chl-NA}
stat_laea %>% 
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  geom_point(aes(col = chl)) +
  scale_colour_cmocean(name = "algae", na.value = "red") + 
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

Check the total number of observations per group.

```{r sample-numbers}
test <- stat_laea %>%
  group_by(IHO_area) %>% 
  summarise(n = n())
```

# Data exploration

Maps of all variables.

```{r map-SA-int, fig.height=3, fig.width=7}
stat_laea %>% 
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  geom_point(aes(col = IHO_area)) +
  ggtitle("regions") +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

```{r map-ow, fig.height=3, fig.width=7}
stat_laea %>% # Openwater duration
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
  geom_tile(aes(fill = openwater_duration)) +
  scale_fill_viridis_c("Day", option = "plasma", na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("Openwater duration") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

```{r map-ice-week, fig.height=3, fig.width=7}
stat_laea %>% # Openwater duration
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
  geom_tile(aes(fill = ice_week)) +
  scale_fill_viridis_c("Week", option = "viridis", na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("Week ice breakup") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

```{r map-thetao, fig.height=3, fig.width=7}
stat_laea %>% # Temperature
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
  geom_tile(aes(fill = thetao)) +
  scale_fill_cmocean("Temp (dC)", name = "thermal", na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("Temperature at 222 m depth") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

```{r map-velocity, fig.height=3, fig.width=7}
stat_laea %>% # Ice concentration
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
  geom_tile(aes(fill = velocity)) +
  scale_fill_cmocean("velo (cm/s)", name = "speed", na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("Current velocity at 222 m depth") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

# Spatial and interannual variability

```{r prep-diff}
SA_diff <- SA_grid_laea %>%
  filter(empty_clean == F) %>%
  dplyr::select(year, IHO_area, NASC_int, SA_int, NASC_int, CM) %>%
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                     IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                     IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                     IHO_area == "The Northwestern Passages" ~ "CAA",
                                     IHO_area == "Baffin Bay" ~ "BB",
                                     IHO_area == "Davis Strait" ~ "DS"),
                           levels = c("WAO_BF", "CAA", "BB", "DS", "EAO")),
         year = factor(year))
```

## All areas

I check whether there are inter-annual and spatial variability in S\~A\~ and the centre of mass across years and areas.

```{r all-interannual-spatial-prep}
# Visualize data
plot_grid(SA_diff %>% 
            ggplot() +
            geom_boxplot(aes(x = year, y = NASC_int)),
          SA_diff %>% 
            ggplot() +
            geom_boxplot(aes(x = year, y = CM)))

# Check assumptions
## Outliers
SA_diff %>%
  group_by(year) %>%
  identify_outliers(NASC_int) 
SA_diff %>%
  group_by(year) %>%
  identify_outliers(CM) 
SA_diff %>%
  group_by(IHO_area) %>%
  identify_outliers(NASC_int) 
SA_diff %>%
  group_by(IHO_area) %>%
  identify_outliers(CM) 

## Normality: Checked by looking at the anova residuals with QQ plot
ggqqplot(SA_diff, "NASC_int", facet.by = "year")
ggqqplot(SA_diff, "CM", facet.by = "year")
ggqqplot(SA_diff, "NASC_int", facet.by = "IHO_area")
ggqqplot(SA_diff, "CM", facet.by = "IHO_area")

## Homogeneity of variance
plot(lm(NASC_int ~ year, data = SA_diff), 1)
plot(lm(CM ~ year, data = SA_diff), 1)
plot(lm(NASC_int ~ IHO_area, data = SA_diff), 1)
plot(lm(CM ~ IHO_area, data = SA_diff), 1)
```

I used a non parametric Kruskal-Wallis test to test for interannual and spatial variability because the variance is not homogenous and not very normal.

```{r all-kruskal-wallis}
SA_diff %>% # Kruskal wallis interannual difference SA
  kruskal_test(NASC_int ~ year)
SA_diff %>% # Kruskal wallis interannual difference CM
  kruskal_test(CM ~ year)
SA_diff %>% # Kruskal wallis interannual difference SA
  kruskal_test(NASC_int ~ IHO_area)
SA_diff %>% # Kruskal wallis interannual difference CM
  kruskal_test(CM ~ IHO_area)
```

The center of mass did not vary significantly between years (H = 1.652899, p = 0.438) but varied significantly among areas (*H* = 57.8495, *p* \< 0.001). Mesopelagic backscatter S\~A\~ varied significantly between areas (*H* = 26.19394, *p* \< 0.001) but not years (*H* = 8.6464, *p* = 0.013). Thus, in the S\~A\~ HGAM a random effect for change in S\~A\~ per area is likely needed.

## Within areas

I check whether there are inter-annual variability in S\~A\~ across years within areas. This will be used to decide whether a random effect is needed in the GAM. I used a non parametric Kruskal-Wallis test to test for interannual variability within areas.

```{r area-kruskal-wallis}
SA_diff %>% # Kruskal wallis interannual difference SA within group
  group_by(IHO_area) %>%
  kruskal_test(NASC_int ~ year)
```

There was no interannual differences in SA within each region (WAO_BF - H = 4.8395483, *p* = 0.0889; CAA - H = 6.9278752, *p* = 0.0313; BB - H = 0.0968, *p* = 0.0889; DS - H = 0.9470, *p* = 0.0889; EAO - H = 5.0263899, *p* = 0.0810). Therefore, there seems to be no need for a random effect for interannual variability within years.

# HGAM - Tweedie NASC

## Data preparation

```{r GAM-prep}
SA_df <- stat_laea %>%
  dplyr::select(year, xc, yc, IHO_area, NASC_int, SA_int, velocity, thetao, so, openwater_duration, mean_ice_conc) %>%
  group_by(IHO_area) %>%
  mutate(year = factor(year),
         NASC_int_n = (NASC_int - min(NASC_int)) / (max(NASC_int) - min(NASC_int)),
         SA_int_n = (SA_int - min(SA_int)) / (max(SA_int) - min(SA_int))) %>%
  ungroup() %>%
  rename(IHO = IHO_area, 
         v = velocity,
         t = thetao,
         o = openwater_duration,
         si = mean_ice_conc,
         s = so)
```

Plot data.

```{r plot-data-area}
SA_df %>%
  ggplot(aes(x = v, y = SA_int, col = IHO)) +
  geom_point() +
  geom_smooth(method = "gam", se = F, col = "grey20") +
  facet_wrap(~ IHO) +
  theme(legend.position = "none")

SA_df %>%
  ggplot(aes(x = o, y = SA_int, col = IHO)) +
  geom_point() +
  geom_smooth(method = "gam", se = F, col = "grey20") +
  facet_wrap(~ IHO) +
  theme(legend.position = "none")
```

```{r plot-distribution, fig.height=8, fig.width=10, message=FALSE}
plot_grid(SA_df %>%
            ggplot(aes(x = v, fill = IHO)) +
            geom_histogram() +
            facet_grid(~ IHO) +
            theme(legend.position = "none"),
          SA_df %>%
            ggplot(aes(x = t, fill = IHO)) +
            geom_histogram() +
            facet_grid(~ IHO) +
            theme(legend.position = "none"),
          SA_df %>%
            ggplot(aes(x = o, fill = IHO)) +
            geom_histogram() +
            facet_grid(~ IHO) +
            theme(legend.position = "none"),
          SA_df %>%
            ggplot(aes(x = s, fill = IHO)) +
            geom_histogram() +
            facet_grid(~ IHO) +
            theme(legend.position = "none"),
          ncol = 1)
```

Check correlations.

```{r corr-area}
corr <- SA_df %>% # Compute Spearman correlation matrix
  dplyr::select(-year, -xc, -yc, -IHO, -NASC_int_n, -SA_int_n) %>%
  cor(., method = "spearman") %>%
  round(., 2)
ggcorrplot(corr, type = "lower", lab = T, title = "corr")
```

# Velocity

I decided to fit hierarchical generalized additive model due to their flexibility in modelling non linear relationships. I am interested in the effect of velocity and primary production on mesopelagic density. I fit separate GAMs for each covariate. I follow the model structure from Pedersen et al. 2019.

## Model fitting

```{r velo-HGAM-fit}
# Model G
velo_G <- gam(NASC_int ~ s(v, k = 5, bs = "tp") + # Global smoothers
                 s(IHO, bs = "re") + # Random intercept
                 s(IHO, year, bs = "re"), # Random effect 
            data = SA_df, family = tw(link = "log"), method = "REML")
# Model GS
velo_GS <- gam(NASC_int ~ s(v, k = 5, bs = "tp") + # Global smoothers
                 s(v, IHO, bs = "fs", k = 5) + # Group-level smoothers (random intercept already included)
                 s(IHO, year, bs = "re"), # Random effect 
            data = SA_df, family = tw(link = "log"), method = "REML")
# Model GI
velo_GI <- gam(NASC_int ~ s(v, k = 5, bs = "tp") + # Global smoothers
                 s(IHO, bs = "re") + # Random intercept
                 s(v, by = IHO, k = 5, bs = "tp") + # Group-level smoother
                 s(year, IHO, bs = "re"), # Random effect
               data = SA_df, family = tw(link = "log"), method = "REML")

# Summary metrics
velo_AIC <- AIC(velo_G, velo_GS, velo_GI) %>% 
  rownames_to_column() %>%
  rename(model = rowname)
# Metrics data frame
data.frame(model = c("velo_G", "velo_GS", "velo_GI"),
                       reml = round(c(velo_G$gcv.ubre, velo_GS$gcv.ubre, velo_GI$gcv.ubre), 2), 
                       dev_expl = round(c((1 - (velo_G$deviance / velo_G$null.deviance)) * 100,
                                          (1 - (velo_GS$deviance / velo_GS$null.deviance)) * 100,
                                          (1 - (velo_GI$deviance / velo_GI$null.deviance)) * 100), 2),
                       r2 = round(c(summary(velo_G)$r.sq, summary(velo_GS)$r.sq, summary(velo_GI)$r.sq), 2)) %>%
  full_join(., velo_AIC, by = "model") %>%
  mutate(df = round(df, 3),
         AIC = round(AIC, 3),
         dAIC = round(AIC - min(AIC), 2),
         w_AIC = round(Weights(AIC), 10)) %>%
  dplyr::select(model, df, dev_expl, r2, reml, AIC, dAIC, w_AIC) %>%
  arrange(dAIC) %>% 
  datatable(class = "cell-border stribe", rownames = F)
```

```{r veloG-summary}
summary(velo_G)
```

```{r veloGS-summary}
summary(velo_GS)
```

```{r veloGI-summary}
summary(velo_GI)
```

## Model checking

### Basis size and residual distribution

First I check the basis size k. `k-indexes` are \> 1 or close to 1 so the basis size is large enough. The residual plot look good too.

```{r veloG-basis-size-residuals}
appraise(velo_G)
k.check(velo_G)
```

```{r veloGS-basis-size-residuals}
appraise(velo_GS)
k.check(velo_GS)
```

```{r veloGI-basis-size-residuals}
appraise(velo_GI)
k.check(velo_GI)
```

### Resiudals against covariates

```{r veloGS-residuals-covariates, message=FALSE}
velo_GS_resid <- bind_cols(SA_df, residuals.gam(velo_GS)) %>%
  rename(resid = "...14")
plot_grid(velo_GS_resid %>%
            ggplot(aes(x = v, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "velocity") +
            geom_point(), 
           velo_GS_resid %>%
            ggplot(aes(x = IHO, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "area") +
            geom_boxplot(fill = NA), 
          velo_GS_resid %>%
            ggplot(aes(x = year, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "year") +
            geom_boxplot(fill = NA))
```

```{r veloGI-residuals-covariates, message=FALSE}
velo_GI_resid <- bind_cols(SA_df, residuals.gam(velo_GI)) %>%
  rename(resid = "...14")
plot_grid(velo_GI_resid %>%
            ggplot(aes(x = v, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "velocity") +
            geom_point(), 
           velo_GI_resid %>%
            ggplot(aes(x = IHO, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "area") +
            geom_boxplot(fill = NA), 
          velo_GI_resid %>%
            ggplot(aes(x = year, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "year") +
            geom_boxplot(fill = NA))
```

## Model selection

I turn on the double penalty (`select = TRUE`) and check the covariates that has been shrunk.

```{r GAM-selection}
# Model GI
GAMgi_p <- gam(SA_int_n ~ s(IHO, bs = "re") + #s(year, IHO, bs = "re") + # Random effects and intercepts
               s(v, k = 5, bs = "tp", m = 2) + s(o, k = 5, bs = "tp", m = 2) + # Global smoothers
               s(v, by = IHO, k = 5, bs = "tp", m = 1) + s(o, by = IHO, k = 5, bs = "tp", m = 1), # Group-level smoothers
            data = SA_df, family = "gaussian", method = "REML", select = TRUE)
summary(GAMgi_p)
```

## Model visualization

Quick partial effects plot with `gratia::draw`.

```{r draw-GAM}
draw(GAMgs, residuals = TRUE, scales = "free")
```

I predict the data and then use that dataframe to plot it in a "clean" way with `ggplot`.

```{r predict-GAM}
# Fitted GAMs
pred_v <- fitted_values(GAMgi, terms = c("s(v)", "s(v):IHOWAO", "s(v):IHOBF", "s(v):IHOCAA", "s(v):IHOBB", "s(v):IHODS", "s(v):IHOEAO")) %>% # Fit velocity
  rename(v_fit = fitted, 
         v_se = se,
         v_lower = lower,
         v_upper = upper) 
pred_o <- fitted_values(GAMgi, terms = c("s(o)", "s(o):IHOWAO", "s(o):IHOBF", "s(o):IHOCAA", "s(o):IHOBB", "s(o):IHODS", "s(o):IHOEAO")) %>% # Fit open water
  rename(o_fit = fitted, 
         o_se = se,
         o_lower = lower,
         o_upper = upper)
pred_GAM <- left_join(SA_df, pred_v, by = c("IHO", "v", "o")) %>%
  left_join(., pred_o, by = c("IHO", "v", "o")) 

# Partial effects
part_eff_GAM <- smooth_estimates(GAMgi) %>% # Evaluate smooths
  add_confint()
part_res_SA <- SA_df %>% # add partial residuals to data
  add_partial_residuals(GAMgi)

# Save predictions
save(pred_GAM, GAMgi, file = "data/statistics/GAM_results.RData")

rm(pred_v, pred_o)
```

```{r predict-GAM}
# Fitted GAMs
pred_v <- fitted_values(GAM4, terms = c("s(v)", "s(v,IHO)"), scale = "linear") %>% # Fit velocity
  rename(v_fit = fitted, 
         v_se = se,
         v_lower = lower,
         v_upper = upper) 
pred_t <- fitted_values(GAM4, terms = c("s(t)", "s(t,IHO)")) %>% # Fit temperature
  rename(t_fit = fitted, 
         t_se = se,
         t_lower = lower,
         t_upper = upper)
pred_o <- fitted_values(GAM4, terms = c("s(o)", "s(o,IHO)")) %>% # Fit open water
  rename(o_fit = fitted, 
         o_se = se,
         o_lower = lower,
         o_upper = upper)
pred_GAM <- left_join(SA_df, pred_v, by = c("IHO", "year", "v", "o")) %>%
  left_join(., pred_o, by = c("IHO", "year", "v", "o")) 

# Partial effects
part_eff_GAM <- smooth_estimates(GAM4) %>% # Evaluate smooths
  add_confint()
part_res_SA <- SA_df %>% # add partial residuals to data
  add_partial_residuals(GAM4)

# Save predictions
save(pred_GAM, GAM4, file = "data/statistics/GAM_results.RData")

rm(pred_v, pred_t, pred_o)
```

Plot fitted GAM with `ggplot`.

```{r ggplot-GAM, warning=FALSE}
# col_pal <- c("#5BBCD6", "#00A08A", "#F2AD00", "#F98400", "#FF0000")# wesanderson::wes_palette("Darjeeling1", type = "discrete")
# col_pal <- c("#5BBCD6",  "#00A08A", "#F98400", "#FF0000")# wesanderson::wes_palette("Darjeeling1", type = "discrete") 

GAM_plot <- plot_grid(get_legend(ggplot(data = pred_GAM, aes(x = v, y = v_fit, fill = IHO, col = IHO)) + 
                                   geom_point() +
                                   # scale_colour_manual(values = col_pal) + 
                                   # scale_fill_manual(values = col_pal) + 
                                   theme(legend.position = "top", legend.title = element_blank())),
          plot_grid(
            pred_GAM %>% # velocity
              ggplot(aes(x = v)) +
              # geom_ribbon(aes(ymin = v_lower, ymax = v_upper, fill = IHO), alpha = 0.1) +
              geom_line(aes(y = 10*log10(v_fit), col = IHO), size = 1) +
              # scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.5)) +
              # scale_colour_manual(values = col_pal) +
              # scale_fill_manual(values = col_pal) +
              labs(x = expression("Velocity at 222 m (cm s"^-1*")"), 
                   y = expression("S"[A]*"")) + 
              theme(legend.position = "none"),
            pred_GAM %>% # open water
              ggplot(aes(x = o)) +
              # geom_ribbon(aes(ymin = o_lower, ymax = o_upper, fill = IHO), alpha = 0.1) +
              geom_line(aes(y = 10*log10(o_fit), col = IHO), size = 1) +
              # scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.5)) +
              # scale_colour_manual(values = col_pal) + 
              # scale_fill_manual(values = col_pal) + 
              labs(x = "Open water (days)", 
                   y = expression("S"[A]*"")) + 
              theme(legend.position = "none")), 
          nrow = 2, rel_heights = c(0.1, 1))
GAM_plot
```

```{r}
pred_GAM %>% # velocity
  ggplot(aes(x = v)) +
  # geom_ribbon(aes(ymin = v_lower, ymax = v_upper, fill = IHO), alpha = 0.1) +
  geom_point(aes(y = SA_int_n)) +
  geom_line(aes(y = v_fit, col = IHO), size = 1) +
  # scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.5)) +
  facet_wrap(~ IHO, scales = "fixed") + 
  # scale_colour_manual(values = col_pal) + 
  # scale_fill_manual(values = col_pal) + 
  labs(x = expression("Velocity at 222 m (cm s"^-1*")"), 
       y = expression("S"[A]*"")) + 
  theme(legend.position = "none")
pred_GAM %>% # velocity
  ggplot(aes(x = t)) +
  # geom_ribbon(aes(ymin = t_lower, ymax = t_upper, fill = IHO), alpha = 0.1) +
  geom_point(aes(y = NASC_int)) + 
  geom_line(aes(y = t_fit, col = IHO), size = 1) +
  # scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.5)) +
  facet_wrap(~ IHO, scales = "free") + 
  scale_colour_manual(values = col_pal) + 
  scale_fill_manual(values = col_pal) + 
  labs(x = "Temp at 222 m (dc)", 
       y = expression("S"[A]*"")) + 
  theme(legend.position = "none")
pred_GAM %>% # velocity
  ggplot(aes(x = o)) +
  # geom_ribbon(aes(ymin =o_lower, ymax = o_upper, fill = IHO), alpha = 0.1) +
  geom_point(aes(y = NASC_int)) + 
  geom_line(aes(y = o_fit, col = IHO), size = 1) +
  # scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.5)) +
  facet_wrap(~ IHO, scales = "free") + 
  scale_colour_manual(values = col_pal) + 
  scale_fill_manual(values = col_pal) + 
  labs(x = "Open water length (days)", 
       y = expression("S"[A]*"")) + 
  theme(legend.position = "none")
```

Plot partial effects.

```{r partial-effect-plots}
plot_grid(part_eff_GAM %>%
            filter(smooth == "s(v)") %>%
            ggplot() +
            geom_rug(data = part_res_SA, aes(x = v), sides = "b", length = grid::unit(0.02, "npc")) +
            geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = v), alpha = 0.2) +
            geom_point(data = part_res_SA, aes(x = v, y = `s(v)`), col = "steelblue3", cex = 1.5) +
            geom_line(aes(x = v, y = est), lwd = 1.2) +
            labs(y = "Partial effect"),
          part_eff_GAM %>%
            filter(smooth == "s(t)") %>%
            ggplot() +
            geom_rug(data = part_res_SA, aes(x = t), sides = "b", length = grid::unit(0.02, "npc")) +
            geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = t), alpha = 0.2) +
            geom_point(data = part_res_SA, aes(x = t, y = `s(t)`), col = "steelblue3", cex = 1.5) +
            geom_line(aes(x = t, y = est), lwd = 1.2) +
            labs(y = "Partial effect"),
          part_eff_GAM %>%
            filter(smooth == "s(o)") %>%
            ggplot() +
            geom_rug(data = part_res_SA, aes(x = o), sides = "b", length = grid::unit(0.02, "npc")) +
            geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, x = o), alpha = 0.2) +
            geom_point(data = part_res_SA, aes(x = o, y = `s(o)`), col = "steelblue3", cex = 1.5) +
            geom_line(aes(x = o, y = est), lwd = 1.2) +
            labs(y = "Partial effect"))
```

'
