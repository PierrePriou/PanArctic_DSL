---
title: "PanArctic DSL - Statistics"
author: "[Pierre Priou](mailto:pierre.priou@mi.mun.ca)"
date: "`r format(Sys.time(), '%Y/%m/%d at %H:%M')`"
output: 
  html_document:
    keep_md: yes
  github_document:
    always_allow_html: true
---

# Goals

The goal of the statistics are to investigate the potential effects of primary production and advection on mesopelagic backscatter for each Arctic region. Therefore, I gathered remote sensing data of sea ice concentration and ocean colour, and modelled advection from Copernicus.

Since remote sensing of primary production (chlorophyll *a*) can be biased by high concentration of CDOM (chromophoric dissolved organic matter) and the photoadptation of Arctic phytoplankton (Lewis et al. 2016), I use to variables as proxy for primary production. First, I use the satellite-derived monthly averaged chlrophyll *a* concentration from CMEMS (doi: [10.48670/moi-00066](https://doi.org/10.48670/moi-00066)), and I calculate the open water days from sea ice concentration from the EUMETSAT OSI SAF remote sensing dataset (doi: [10.24381/cds.3cd8b812](https://doi.org/10.24381/cds.3cd8b812)) which I use as a proxy for primary production. For advection I use data from the Copernicus Marine Environmental Monitoring Service Arctic Ocean Physics Reanalysis product which gives monthly average of current velocity in the Arctic Ocean.

# Package loading

```{r package-loading, message=FALSE, warning=FALSE}
# Load packages
library(tidyverse)    # Tidy code
library(cowplot)      # Plots on a grid
library(raster)       # Data gridding
library(sf)           # Spatial data
library(rgdal)        # Read shapefiles
library(ggpubr)       # Deal with stats
library(ggfortify)    # Plotting glm
library(RColorBrewer) # Diverging colour palettes
library(cmocean)      # Oceanographic colour palettes
library(moments)      # Overlay distributions
library(ggcorrplot)   # Correlation plots
library(kableExtra)   # Pretty tables
library(mgcv)         # Fit GAM
library(gratia)       # Visualise GAM
library(visreg)       # Visualise GAM
library(itsadug)      # Predict GAM
library(MetBrewer)    # Pretty colour palettes
library(MuMIn)        # AIC weights
library(DT)           # Interactive table
library(rstatix)      # Pipe-friendly stats
# Custom figure theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size = 9),
             axis.title = element_text(size = 9),
             strip.text.x = element_text(size = 9, face = "plain", hjust = 0.5),
             strip.background = element_rect(colour = "transparent",
                                             fill = "transparent"),
             legend.title = element_text(size = 9),
             legend.margin = margin(0, 0, 0, 0),
             legend.box.margin = margin(0, 0, -8, 0),
             panel.grid = element_blank(), 
             plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "in"))
options(dplyr.summarise.inform = F) # Suppress summarise() warning
```

```{r data-loading, message=FALSE}
# Laea projection
cell_res <- 25 # Cell resolution in km
arctic_laea <- raster(extent(-2700, 2700, -2700, 2700), crs = "EPSG:6931")
projection(arctic_laea) <- gsub("units=m", "units=km", 
                                projection(arctic_laea)) # Convert from m to km
res(arctic_laea) <- c(cell_res, cell_res) # Define the 100 km cell resolution

# Coastline shapefiles reprojected to laea
coast_10m_laea <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% 
  spTransform(CRSobj = crs("EPSG:4326")) %>% # Verify that the shapefile proj is the right one
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to a dataframe for ggplot
  rename(xc = long, yc = lat)

# Gridded acoustic, CTD, and sea ice data
load("data/acoustics/SA_grids.RData") # Acoustic data
load("data/remote_sensing/physics_grids.RData") # Modelled physics data 
load("data/remote_sensing/seaice_grids.RData") # Remote sensing sea ice data
load("data/remote_sensing/chl_grid.RData") # Remote sensing sea ice data
```

# Data preparation

I combine backscatter and environmental data which were gridded on the Lambert Azimuthal Equal Area grid (EPSG:6931). Since I do not have a lot of samples from the the Beaufort Sea and West Arctic Ocean, I combine those two regions due to their geographical proximity.

```{r combine-data}
# Prepare datasets
SA_laea <- SA_grid_laea %>%  # Gridded SA
  dplyr::select(-lat, -lon) 
phy_laea <- phy_grid_laea %>% # Remote sensing: physics reanalysis
  dplyr::select(year, area, xc, yc, cell_res, depth, thetao, velocity, so)
seaice_laea <- seaice_grid_laea %>% # Remote sensing: seaice concentration
  dplyr::select(year, area, xc, yc, cell_res, openwater_duration, mean_ice_conc)

stat_laea <- SA_laea %>%
  left_join(., phy_laea, by = c("year", "xc", "yc", "area", "cell_res")) %>% 
  left_join(., seaice_laea, by = c("year", "xc", "yc", "area", "cell_res")) %>%
  left_join(., chl_grid_laea, by = c("year", "xc", "yc", "area", "cell_res")) %>%
  filter(depth == 222) # Select physics at 222 m depth
```

There are NAs in the remote sensing dataset.

```{r map-NA, fig.width=8, fig.height=6}
plot_grid(stat_laea %>% 
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = chl)) +
            scale_colour_cmocean(name = "algae", na.value = "red") + 
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(), 
                  axis.title = element_blank()),
          stat_laea %>% 
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = openwater_duration)) +
            scale_colour_viridis_c("ow", na.value = "red") + 
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(), 
                  axis.title = element_blank()),
          ncol = 1, align = "hv", axis = "tblr")
```

This is because the coverage of acoustic data and remote sensing products slightly differ close to the coasts. For sea ice concentration (and open water duration) the NAs are close to land while for ocean colour they are in ice covered areas. I use the average value of neighbouring cells (8 cells around the pixel of interest) to fill missing values.

```{r fill-NAs}
stat_laea <- stat_laea %>%
  rowwise() %>%
  mutate( 
    # Physics
    xc_phy = if_else(is.na(openwater_duration) == T, xc, NaN),
    yc_phy = if_else(is.na(openwater_duration) == T, yc, NaN),
    year_phy = if_else(is.na(openwater_duration) == T, year, NaN), 
    openwater_duration = if_else(
      is.na(openwater_duration) == T,
      mean(pull(subset(seaice_grid_laea, 
                       xc >= xc_phy - cell_res & xc <= xc_phy + cell_res & 
                         yc >= yc_phy - cell_res & yc <= yc_phy + cell_res & 
                         year == year_phy,
                       select = openwater_duration),
                openwater_duration),
           na.rm = T),
      openwater_duration),
    mean_ice_conc = if_else(
      is.na(mean_ice_conc) == T, 
      mean(pull(subset(seaice_grid_laea,
                       xc >= xc_phy - cell_res & xc <= xc_phy + cell_res & 
                         yc >= yc_phy - cell_res & yc <= yc_phy + cell_res & 
                         year == year_phy,
                       select = mean_ice_conc),
                mean_ice_conc),
           na.rm = T),
      mean_ice_conc),
    # Ocean colour
    xc_chl = if_else(is.na(chl) == T, xc, NaN),
    yc_chl = if_else(is.na(chl) == T, yc, NaN),
    year_chl = if_else(is.na(chl) == T, year, NaN), 
    chl = if_else(
      is.na(chl) == T,
      mean(pull(subset(chl_grid_laea, 
                       xc >= xc_chl - cell_res & xc <= xc_chl + cell_res & 
                         yc >= yc_chl - cell_res & yc <= yc_chl + cell_res & 
                         year == year_chl,
                       select = chl),
                chl),
           na.rm = T),
      chl),
    # Convert veloctity to cm/s
    velocity = velocity * 100, 
    IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                IHO_area == "The Northwestern Passages" ~ "CAA",
                                IHO_area == "Baffin Bay" ~ "BB",
                                IHO_area == "Davis Strait" ~ "DS"),
                      levels = c("WAO_BF", "CAA", "BB", "DS", "EAO"))) %>%
  filter(depth == 222) %>% # Select physics at 222 m depth
  ungroup() %>%
  dplyr::select(-xc_phy, -yc_phy, -year_phy, -xc_chl, -yc_chl, -year_chl)
```

Check if I replace NAs correctly.

```{r map-NA-fix, fig.width=8, fig.height=6}
plot_grid(stat_laea %>% 
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = chl)) +
            scale_colour_cmocean(name = "algae", na.value = "red") + 
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(), 
                  axis.title = element_blank()),
          stat_laea %>%
            ggplot(aes(x = xc,  y = yc)) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
                         fill = "grey80") +
            geom_point(aes(col = openwater_duration)) +
            scale_colour_viridis_c("ow", na.value = "red") +
            facet_wrap(~ year) +
            coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
            theme(axis.text = element_blank(), axis.ticks = element_blank(),
                  axis.title = element_blank()),
          ncol = 1, align = "hv", axis = "tblr")
```

NA replacement worked well for ice concentration. There are still missing chl values, so these cells are excluded from further analyses.

```{r exclude-NA-chl}
stat_laea <- stat_laea %>%
  filter(is.na(chl) == F) 
```

```{r map-chl-NA}
stat_laea %>% 
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  geom_point(aes(col = chl)) +
  scale_colour_cmocean(name = "algae", na.value = "red") + 
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

Check the total number of observations per group.

```{r sample-numbers}
stat_laea %>%
  group_by(IHO_area) %>% 
  summarise(n = n())
```

# Data exploration

Maps of all variables.

```{r map-SA-int, fig.height=3, fig.width=7}
stat_laea %>% 
  ggplot(aes(x = xc,  y = yc)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  geom_point(aes(col = IHO_area)) +
  ggtitle("regions") +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

```{r map-ow, fig.height=3, fig.width=7}
seaice_grid_laea %>% # Openwater duration
  ggplot(aes(x = xc,  y = yc)) +
  geom_tile(aes(fill = openwater_duration)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  scale_fill_viridis_c("Day", option = "plasma", na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("Openwater duration") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(),
        axis.title = element_blank())
```

```{r map-chl, fig.height=3, fig.width=7}
chl_grid_laea %>% # Temperature
  ggplot(aes(x = xc,  y = yc)) +
  geom_tile(aes(fill = chl)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  scale_fill_cmocean("chl (mg m-3)", name = "algae", limits = c(0,5),
                     na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("chlorophyll") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

```{r map-velocity, fig.height=3, fig.width=7}
phy_grid_laea %>% # Ice concentration
  ggplot(aes(x = xc,  y = yc)) +
  geom_tile(aes(fill = velocity*100)) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey80") +
  scale_fill_cmocean("velo (cm/s)", name = "speed", limits = c(0,8),
                     na.value = "red") +
  facet_wrap(~ year, ncol = 3) +
  ggtitle("Current velocity at 222 m depth") +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        axis.title = element_blank())
```

# Spatial and interannual variability

```{r prep-diff}
SA_diff <- SA_grid_laea %>%
  dplyr::select(year, IHO_area, NASC_int, SA_int, NASC_int, CM) %>%
  mutate(IHO_area = 
           factor(
             case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                       IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                       IHO_area == "Beaufort Sea" ~ "WAO_BF",
                       IHO_area == "The Northwestern Passages" ~ "CAA",
                       IHO_area == "Baffin Bay" ~ "BB",
                       IHO_area == "Davis Strait" ~ "DS"),
             levels = c("WAO_BF", "CAA", "BB", "DS", "EAO")),
         year = factor(year))
```

## All areas

I check whether there are inter-annual and spatial variability in S\~A\~ and the centre of mass across years and areas.

```{r all-interannual-spatial-prep}
# Visualize data
plot_grid(SA_diff %>% 
            ggplot() +
            geom_boxplot(aes(x = year, y = NASC_int)),
          SA_diff %>% 
            ggplot() +
            geom_boxplot(aes(x = year, y = CM)))

# Check assumptions
## Outliers
SA_diff %>%
  group_by(year) %>%
  identify_outliers(NASC_int) 
SA_diff %>%
  group_by(year) %>%
  identify_outliers(CM) 
SA_diff %>%
  group_by(IHO_area) %>%
  identify_outliers(NASC_int) 
SA_diff %>%
  group_by(IHO_area) %>%
  identify_outliers(CM) 

## Normality: Checked by looking at the anova residuals with QQ plot
ggqqplot(SA_diff, "NASC_int", facet.by = "year")
ggqqplot(SA_diff, "CM", facet.by = "year")
ggqqplot(SA_diff, "NASC_int", facet.by = "IHO_area")
ggqqplot(SA_diff, "CM", facet.by = "IHO_area")

## Homogeneity of variance
plot(lm(NASC_int ~ year, data = SA_diff), 1)
plot(lm(CM ~ year, data = SA_diff), 1)
plot(lm(NASC_int ~ IHO_area, data = SA_diff), 1)
plot(lm(CM ~ IHO_area, data = SA_diff), 1)
```

I used a non parametric Kruskal-Wallis test to test for interannual and spatial variability because the variance is not homogenous and not very normal.

```{r all-kruskal-wallis}
SA_diff %>% # Kruskal wallis interannual difference SA
  kruskal_test(NASC_int ~ year)
SA_diff %>% # Kruskal wallis interannual difference CM
  kruskal_test(CM ~ year)
SA_diff %>% # Kruskal wallis interannual difference SA
  kruskal_test(NASC_int ~ IHO_area)
SA_diff %>% # Kruskal wallis interannual difference CM
  kruskal_test(CM ~ IHO_area)
```

The center of mass did not vary significantly between years (H = 1.652899, p = 0.438) but varied significantly among areas (*H* = 57.8495, *p* \< 0.001). Mesopelagic backscatter S\~A\~ varied significantly between areas (*H* = 26.19394, *p* \< 0.001) but not years (*H* = 8.6464, *p* = 0.013). Thus, in the S\~A\~ HGAM a random effect for change in S\~A\~ per area is likely needed.

## Within areas

I check whether there are inter-annual variability in S\~A\~ across years within areas. This will be used to decide whether a random effect is needed in the GAM. I used a non parametric Kruskal-Wallis test to test for interannual variability within areas.

```{r area-kruskal-wallis}
SA_diff %>% # Kruskal wallis interannual difference SA within group
  group_by(IHO_area) %>%
  kruskal_test(NASC_int ~ year)
```

There was no interannual differences in SA within each region (WAO_BF - H = 4.8395483, *p* = 0.0889; CAA - H = 6.9278752, *p* = 0.0313; BB - H = 0.0968, *p* = 0.0889; DS - H = 0.9470, *p* = 0.0889; EAO - H = 5.0263899, *p* = 0.0810). Therefore, there seems to be no need for a random effect for interannual variability within years.

# HGAM - Gamma NASC

## Data preparation

```{r GAM-prep}
SA_df <- stat_laea %>%
  dplyr::select(year, xc, yc, IHO_area, NASC_int, SA_int, velocity, thetao, so, openwater_duration, mean_ice_conc, chl) %>%
  group_by(IHO_area) %>%
  mutate(year = factor(year),
         NASC_int_n = (NASC_int - min(NASC_int)) / (max(NASC_int) - min(NASC_int)),
         SA_int_n = (SA_int - min(SA_int)) / (max(SA_int) - min(SA_int))) %>%
  ungroup() %>%
  rename(IHO = IHO_area, 
         v = velocity,
         t = thetao,
         o = openwater_duration,
         si = mean_ice_conc,
         s = so)
```

Plot data.

```{r plot-data-area}
SA_df %>%
  ggplot(aes(x = v, y = NASC_int, col = IHO)) +
  geom_point() +
  geom_smooth(method = "gam", se = F, col = "grey20") +
  facet_wrap(~ IHO, scales = "free") +
  theme(legend.position = "none")

SA_df %>%
  ggplot(aes(x = o, y = NASC_int, col = IHO)) +
  geom_point() +
  geom_smooth(method = "gam", se = F, col = "grey20") +
  facet_wrap(~ IHO, scales = "free") +
  theme(legend.position = "none")

SA_df %>%
  ggplot(aes(x = chl, y = NASC_int, col = IHO)) +
  geom_point() +
  geom_smooth(method = "gam", se = F, col = "grey20") +
  facet_wrap(~ IHO, scales = "free") +
  theme(legend.position = "none")
```

Check correlations.

```{r corr-area}
corr <- SA_df %>% # Compute Spearman correlation matrix
  dplyr::select(-year, -xc, -yc, -IHO, -NASC_int_n, -SA_int_n) %>%
  cor(., method = "spearman") %>%
  round(., 2)
ggcorrplot(corr, type = "lower", lab = T, title = "corr")
```

# Velocity and chlorophyll

## Model fitting

In model GS the random intercept is already included in the `s(bs = "fs")` term.

```{r HGAM-fit}
# Model G
GAM_G <- gam(NASC_int ~ 
               # First order effects
               s(v, k = 5, bs = "tp") + # Global smoothers
               s(chl, k = 5, bs = "tp") + # Global smoothers
               s(IHO, bs = "re") + # Random intercept
               # Second order effects
               s(IHO, year, bs = "re"), # Random effect
            data = SA_df, family = Gamma(link = "log"), method = "REML")
# Model GS
GAM_GS <- gam(NASC_int ~ 
                # First order effects
                s(v, k = 5, bs = "tp") + # Global smoothers
                s(chl, k = 5, bs = "tp") + # Global smoothers
                s(IHO, bs = "re") + # Random intercept
                # Second order effects
                s(v, IHO, bs = "fs", k = 5) + # Group-level smoothers
                s(chl, IHO, bs = "fs", k = 5) + # Group-level smoothers
                s(IHO, year, bs = "re"), # Random effect
              data = SA_df, family = Gamma(link = "log"), method = "REML")
# Model GI
GAM_GI <- gam(NASC_int ~
                # First order effects
                s(v, k = 5, bs = "tp") + # Global smoothers
                s(chl, k = 5, bs = "tp") + # Global smoothers
                s(IHO, bs = "re") + # Random intercept
                # Secnd order effects
                s(v, by = IHO, k = 5, bs = "tp") + # Group-level smoother
                s(chl, by = IHO, k = 5, bs = "tp") + # Group-level smoother
                s(year, IHO, bs = "re"), # Random effect
               data = SA_df, family = Gamma(link = "log"), method = "REML")

# Summary metrics
GAM_AIC <- AIC(GAM_G, GAM_GS, GAM_GI) %>% 
  rownames_to_column() %>%
  rename(model = rowname)
# Metrics data frame
data.frame(model = c("GAM_G", "GAM_GS", "GAM_GI"),
           reml = round(c(GAM_G$gcv.ubre,
                          GAM_GS$gcv.ubre, 
                          GAM_GI$gcv.ubre), 
                        2), 
           dev_expl = round(c(
             (1 - (GAM_G$deviance / GAM_G$null.deviance)) * 100,
             (1 - (GAM_GS$deviance / GAM_GS$null.deviance)) * 100,
             (1 - (GAM_GI$deviance / GAM_GI$null.deviance)) * 100),
             2),
           r2 = round(c(summary(GAM_G)$r.sq,
                        summary(GAM_GS)$r.sq, 
                        summary(GAM_GI)$r.sq),
                      2)) %>%
  full_join(., GAM_AIC, by = "model") %>%
  mutate(df = round(df, 3),
         AIC = round(AIC, 3),
         dAIC = round(AIC - min(AIC), 2),
         w_AIC = round(Weights(AIC), 10)) %>%
  dplyr::select(model, df, dev_expl, r2, reml, AIC, dAIC, w_AIC) %>%
  arrange(dAIC) %>% 
  datatable(class = "cell-border stribe", rownames = F)
```

```{r GAMG-summary}
summary(GAM_G)
```

```{r GAMGS-summary}
summary(GAM_GS)
```

```{r GAMGI-summary}
summary(GAM_GI)
```

## Model checking

### Basis size and residual distribution

First I check the basis size k. `k-indexes` are \> 1 or close to 1 so the basis size is large enough. The residual plot look good too.

```{r GAMGS-basis-size-residuals}
appraise(GAM_GS)
k.check(GAM_GS)
```

```{r GAMGI-basis-size-residuals}
appraise(GAM_GI)
k.check(GAM_GI)
```

### Resiudals against covariates

```{r GAMGS-residuals-covariates, message=FALSE}
GAM_GS_resid <- bind_cols(SA_df, residuals.gam(GAM_GS)) %>%
  rename(resid = "...15")
plot_grid(GAM_GS_resid %>%
            ggplot(aes(x = v, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "velocity") +
            geom_point(), 
          GAM_GS_resid %>%
            ggplot(aes(x = chl, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "chlorophyll") +
            geom_point(), 
          GAM_GS_resid %>%
            ggplot(aes(x = IHO, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "area") +
            geom_boxplot(fill = NA), 
          GAM_GS_resid %>%
            ggplot(aes(x = year, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "year") +
            geom_boxplot(fill = NA))
```

```{r veloGI-residuals-covariates, message=FALSE}
GAM_GI_resid <- bind_cols(SA_df, residuals.gam(GAM_GI)) %>%
  rename(resid = "...15")
plot_grid(GAM_GI_resid %>%
            ggplot(aes(x = v, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "velocity") +
            geom_point(), 
          GAM_GI_resid %>%
            ggplot(aes(x = chl, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "chlorophyll") +
            geom_point(), 
          GAM_GI_resid %>%
            ggplot(aes(x = IHO, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "area") +
            geom_boxplot(fill = NA), 
          GAM_GI_resid %>%
            ggplot(aes(x = year, y = resid)) + 
            geom_hline(yintercept = 0, col = "red") +
            labs(x = "year") +
            geom_boxplot(fill = NA))
```

I select `model GI` because it explains the most deviance, has the best metrics and the better residuals.

## Term selection

I turn on the double penalty (`select = TRUE`) and check the covariates that has been shrunk.

```{r GAM-selection}
# Model GI
GAM_GI_p <- gam(NASC_int ~
                # First order effects
                s(v, k = 5, bs = "tp") + # Global smoothers
                s(chl, k = 5, bs = "tp") + # Global smoothers
                s(IHO, bs = "re") + # Random intercept
                # Second order effects
                s(v, by = IHO, k = 5, bs = "tp") + # Group-level smoother
                s(chl, by = IHO, k = 5, bs = "tp") + # Group-level smoother
                s(year, IHO, bs = "re"), # Random effect
               data = SA_df, family = Gamma(link = "log"), method = "REML",
               select = T)
summary(GAM_GI_p)
```

All covariates are important.

## Model predictions

I predict the model to get the smooths in the response scale (NASC). I need to create a specific data frame for this with the factors of interest `IHO` and `year`, and covariates `v` and `chl`.

```{r summary-SA-df}
SA_df %>%
  dplyr::select(IHO, year, v, chl) %>%
  # group_by(IHO, year) %>%
  group_by(IHO) %>%
  get_summary_stats(type = "common")
```

```{r data-frame-pred}
res = 20 # resolution for predictions
# WAO and BF
SA_WAO_BF <- data.frame(
  IHO = factor(rep(rep(rep("WAO_BF", res), 3), 2)),
  year = factor(rep(c(rep(2015, res), rep(2016, res), rep(2017, res)), 2)),
  var = c(rep("v", res * 3), rep("chl", res * 3)),
  v = c(rep(seq(0.801, 7.554, length.out = res), 3), # Velocity
        rep(3.032, res * 3)), # Dummy
  chl = c(rep(0.245, res * 3), # Dummy
          rep(seq(0.111, 0.857, length.out = res), 3))) # Chlorophyll
# CAA
SA_CAA <- data.frame(
  IHO = factor(rep(rep(rep("CAA", res), 3), 2)),
  year = factor(rep(c(rep(2015, res), rep(2016, res), rep(2017, res)), 2)),
  var = c(rep("v", res * 3), rep("chl", res * 3)),
  v = c(rep(seq(0.564, 2.097, length.out = res), 3), # Velocity
        rep(1.218, res * 3)), # Dummy
  chl = c(rep(0.405, res * 3), # Dummy
          rep(seq(0.234, 0.806, length.out = res), 3))) # Chlorophyll
# BB
SA_BB <- data.frame(
  IHO = factor(rep(rep(rep("BB", res), 3), 2)),
  year = factor(rep(c(rep(2015, res), rep(2016, res), rep(2017, res)), 2)),
  var = c(rep("v", res * 3), rep("chl", res * 3)),
  v = c(rep(seq(0.167, 6.357, length.out = res), 3), # Velocity
        rep(1.807, res * 3)), # Dummy
  chl = c(rep(1.005, res * 3), # Dummy
          rep(seq(0.283, 2.539, length.out = res), 3))) # Chlorophyll
# DS
SA_DS <- data.frame(
  IHO = factor(rep(rep(rep("DS", res), 3), 2)),
  year = factor(rep(c(rep(2015, res), rep(2016, res), rep(2017, res)), 2)),
  var = c(rep("v", res * 3), rep("chl", res * 3)),
  v = c(rep(seq(0.513, 4.205, length.out = res), 3), # Velocity
        rep(2.159, res * 3)), # Dummy
  chl = c(rep(0.413, res * 3), # Dummy
          rep(seq(0.319, 0.685, length.out = res), 3))) # Chlorophyll
# EAO
SA_EAO <- data.frame(
  IHO = factor(rep(rep(rep("EAO", res), 3), 2)),
  year = factor(rep(c(rep(2015, res), rep(2016, res), rep(2017, res)), 2)),
  var = c(rep("v", res * 3), rep("chl", res * 3)),
  v = c(rep(seq(0.525, 5.997, length.out = res), 3), # Velocity
        rep(2.209, res * 3)), # Dummy
  chl = c(rep(1.355, res * 3), # Dummy
          rep(seq(0.089, 4.063, length.out = res), 3))) # Chlorophyll
# Combine datasets
SA_new <- bind_rows(SA_WAO_BF, SA_CAA, SA_BB, SA_DS, SA_EAO)
```

Get GAM predictions for the new data. I then calculate the average functional response for all years.

```{r GAMGI-pred}
ilink <- family(GAM_GI)$linkinv # Get link function
pred <- predict(GAM_GI, SA_new, type = "link", se.fit = TRUE) %>% # Predict data
  bind_cols(., SA_new) %>%
  transform(lwr_ci = ilink(fit - (2 * se.fit)), # Calculate lower CI
            upr_ci = ilink(fit + (2 * se.fit)), # Calculate upper CI
            fitted = ilink(fit)) %>% # Calculate fit
  group_by(IHO, var, v, chl) %>%
  summarise(NASC_fit = mean(fitted), # Calculate average functional response
            NASC_lwr_ci = mean(lwr_ci),
            NASC_upr_ci = mean(upr_ci)) %>%
  mutate(SA_fit = 10 * log10(NASC_fit), # Convert to SA
         SA_lwr_ci = 10 * log10(NASC_lwr_ci),
         SA_upr_ci = 10 * log10(NASC_upr_ci))
# Save data
save(pred, GAM_GI, file = "data/statistics/GAM_results.RData")
```

## Model visualization

Quick partial effects plot with `gratia::draw`.

```{r draw-GAMGI}
draw(GAM_GS, residuals = TRUE, scales = "free")
```

Plot to see if predictions worked well.

```{r GAMGI-ggplot, fig.height=8, fig.width=8}
plot_grid(
  pred %>%
    filter(var == "v") %>%
    ggplot() +
    geom_line(aes(x = v, y = NASC_fit)) +
    geom_ribbon(aes(x = v, ymin = NASC_lwr_ci, ymax = NASC_upr_ci), alpha = 0.1) +
    geom_point(data = SA_df, aes(x = v, y = NASC_int, group = IHO)) + 
    facet_wrap(~ IHO, scales = "free"),
  pred %>%
    filter(var == "chl") %>%
    ggplot() +
    geom_line(aes(x = chl, y = NASC_fit)) +
    geom_ribbon(aes(x = chl, ymin = NASC_lwr_ci, ymax = NASC_upr_ci), alpha = 0.1) +
    geom_point(data = SA_df, aes(x = chl, y = NASC_int, group = IHO)) + 
    facet_wrap(~ IHO, scales = "free"),
  ncol = 1)
```

Pretty plot.

```{r GAMGI-pretty-ggplot, fig.height=8, fig.width=7}
pred_plot <- pred %>%
  mutate(IHO = factor(
    case_when(IHO == "EAO" ~ "East Arctic\nOcean",
              IHO == "WAO_BF" ~ "West Arctic Ocean\n&Beaufort Sea",
              IHO == "CAA" ~ "Can. Arctic\nArchipelago",
              IHO == "BB" ~ "Baffin Bay",
              IHO == "DS" ~ "Davis Strait"),
    levels = c("West Arctic Ocean\n&Beaufort Sea", "Can. Arctic\nArchipelago",
               "Baffin Bay", "Davis Strait", "East Arctic\nOcean")))
GAM_velo <- pred_plot %>%
  filter(var == "v") %>%
  ggplot() +
  geom_line(aes(x = v, y = SA_fit, col = IHO), size = 0.8) +
  geom_ribbon(aes(x = v, ymin = SA_lwr_ci, ymax = SA_upr_ci, fill = IHO), alpha = 0.1) +
  scale_colour_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  scale_fill_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  coord_cartesian(ylim = c(-2, 50), expand = T) +
  scale_x_continuous(breaks = seq(0, 10, 1)) +
  labs(x = expression("Current velocity at 222 m (cm s"^-1*")"),
       y = expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(), 
        legend.position = "top")
GAM_chl <- pred_plot %>%
  filter(var == "chl") %>%
  ggplot() +
  geom_line(aes(x = chl, y = SA_fit, col = IHO), size = 0.8) +
  geom_ribbon(aes(x = chl, ymin = SA_lwr_ci, ymax = SA_upr_ci, fill = IHO), alpha = 0.1) +
  scale_colour_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  scale_fill_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  coord_cartesian(ylim = c(-2, 50), expand = T) +
  scale_x_continuous(breaks = seq(0, 10, 0.5)) +
  labs(x = expression("Chlorophyll (mg m"^-3*")"),
       y = expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(), 
        legend.position = "none")
# Combine plots
plot_grid(GAM_velo, GAM_chl, ncol = 1, rel_heights = c(1,0.8))
```
