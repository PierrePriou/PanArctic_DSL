---
title: "PanArctic DSL - Figures"
author: "[Pierre Priou](mailto:pierre.priou@mi.mun.ca)"
date: "`r format(Sys.time(), '%Y/%m/%d at %H:%M')`"
output: 
  html_document:
    keep_md: yes
  github_document:
    always_allow_html: true
---

# Package and data loading

```{r package-loading, message=FALSE}
# Load packages
library(tidyverse)  # Tidy code
library(lubridate)  # Deal with dates
library(kableExtra) # Pretty tables
library(cowplot)    # Plots on a grid
library(raster)     # Data gridding
library(rgdal)      # Read shapefiles
library(rworldxtra) # Higher resolution coastline data
library(marmap)     # Bathymetry data of the Arctic Ocean
library(ggforce)    # Draw polygons
library(cmocean)    # Pretty color palettes
library(ggpubr)     # Display stats with ggplot
library(RColorBrewer) # Diverging color palette
library(ggnewscale) # Multiple color scales on a single plot
library(lemon)      # Repeated axis on facets
library(DT)         # Interactive tables
library(ragg)       # Fix issues with plotting alpha and coord_cartesian
library(MetBrewer)  # Color palette
library(sf)         # Spatial data
library(fs)         # List files
source("R/getNOAA.ice.bathy.R") # Load bathy data from NOAA
source("R/rounder.R")
# Custom figure theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size = 9),
             axis.title = element_text(size = 9),
             strip.text.x = element_text(size = 9, face = "plain", hjust = 0.5),
             strip.background = element_rect(colour = "transparent", 
                                             fill = "transparent"),
             legend.title = element_text(size = 9),
             legend.margin = margin(0, 0, 0, 0),
             legend.box.margin = margin(0, 0, -8, 0),
             panel.grid = element_blank(), 
             plot.margin = unit(c(0, 0, 0, 0), "in"))
options(dplyr.summarise.inform = F) # Suppress summarise() warning
```

```{r data-loading, message=FALSE}
# Map projection
arctic_latlon <- raster(extent(-155, 35, 66, 85), crs = "EPSG:4326")
# Coastline shapefiles
coast_10m_latlon <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% 
  spTransform(CRSobj = crs(arctic_latlon)) %>% # Verify shapefile proj.
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  fortify() %>% # Convert to a dataframe for ggplot
  rename(lon = long)
# Bathy data
bathy_df <- getNOAA.ice.bathy(lon1 = -180, lon2 = 180, lat1 = 50, lat2 = 90,
                              resolution = 2, keep = T, path = "data/bathy/") %>%
  fortify.bathy() %>%
  rename(lon = x, lat = y, depth = z)

# Arctic circle and areas of interest
arctic_circle_latlon <- data.frame(lon = seq(-180, 180, 0.1)) %>%
  mutate(lat = 66.5)
area_BF_CAA_latlon <- data.frame(lon = c(-158, -158, -93, -93, -158), 
                                 lat = c(79, 68.5, 68.5, 79, 79))
area_BB_latlon <- data.frame(lon = c(-86, -65, -51.5, -51.5, -86), 
                             lat = c(72, 65.5, 65.5, 83, 83))
area_SV_latlon <- data.frame(lon = c(46, 46, 0, 0, 46),
                             lat = c(85, 76, 76, 85, 85))

# Acoustic data
load("data/acoustics/MVBS_2015_2017.RData")
load("data/acoustics/SA_grids.RData")
load("data/acoustics/Sv_grids.RData")
MVBS_latlon <- MVBS %>% # Location of acoustic data
  mutate(lat = round(lat, 1),
         lon = round(lon, 1)) %>%
  group_by(lat,lon) %>%
  summarise(lat = mean(lat), 
            lon = mean(lon)) %>%
  ungroup() 

# CTD data
load("data/CTD/CTD_2015_2019.RData")
load("data/CTD/CTD_grids.RData")

# Trawl data
load("data/nets/trawl_mwt_2015_2017.RData")
trawl_latlon <- trawl_station %>% # Location of trawls
  group_by(date) %>%
  summarise(lat = mean(lat),
            lon = mean(lon))

# Remote sensing data
load("data/remote_sensing/remote_sensing_chl.RData")
load("data/remote_sensing/seaice_grids.RData")
```

I re-project data from the WGS84 projection to the EASE-Grid 2.0 North projection.

```{r data-laea-projection, cache=TRUE}
# Laea projection for bathy and all other files
cell_res <- 50 # Cell resolution in km
arctic_laea <- raster(extent(-2700, 2700, -2700, 2700), crs = "EPSG:6931") 
projection(arctic_laea) <- gsub("units=m", "units=km", # Convert from m to km
                                projection(arctic_laea)) 
res(arctic_laea) <- c(cell_res, cell_res) # Define cell resolution

proj_bathy_laea <- raster(extent(-2700, 2700, -2700, 2700), 
                          crs = "EPSG:6931", res = c(5, 5)) # Seaice projection
projection(proj_bathy_laea) <- gsub("units=m", "units=km", # Convert from m to km
                                    projection(arctic_laea)) 

# Project bathymetric data 
bathy_laea <- SpatialPointsDataFrame(SpatialPoints(cbind(bathy_df$lon,
                                                         bathy_df$lat),
                                                   proj4string = CRS("EPSG:4326")),
                                     data.frame(depth = bathy_df$depth)) %>%
  spTransform(., CRSobj = crs(proj_bathy_laea)) %>% # Change projection to laea
  rasterize(., proj_bathy_laea, fun = mean, na.rm = T) %>% # Rasterize data
  dropLayer(1) %>% # Remove ID layer
  rasterToPoints() %>% # Convert raster to data frame
  as.data.frame() %>%
  rename(xc = x, yc = y) %>%
  ungroup() %>%
  mutate(depth_d = factor(
    case_when(between(depth, -100, Inf) ~ "0-100",
              between(depth, -200, -100) ~ "100-200",
              between(depth, -500, -200) ~ "200-500",
              between(depth, -1000, -500) ~ "500-1000",
              between(depth, -2000, -1000) ~ "1000-2000",
              between(depth, -3000, -2000) ~ "2000-3000",
              between(depth, -4000, -3000) ~ "3000-4000",
              between(depth, -Inf, -4000) ~ "4000-5500"),
    levels = c(">0", "0-100", "100-200", "200-500", "500-1000",
               "1000-2000", "2000-3000", "3000-4000", "4000-5500")))

# Coastline shapefile
coast_10m_laea <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% 
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to a dataframe for ggplot
  rename(xc = long, yc = lat)

# Location of trawls
trawl_laea <- SpatialPoints(cbind(trawl_latlon$lon, trawl_latlon$lat), 
                            proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2)

# Location of acoustic data
MVBS_laea <- SpatialPoints(cbind(MVBS_latlon$lon, MVBS_latlon$lat), 
                           proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2) # Rename variables

# Arctic circle and areas of interest
arctic_circle_laea <- SpatialPoints(cbind(arctic_circle_latlon$lon,
                                          arctic_circle_latlon$lat), 
                                    proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2) # Rename variables
area_BF_CAA_laea <- SpatialPoints(cbind(c(-152, -152, -140, -122.5, -93, -93),
                                        c(78, 73, 68, 68, 68, 78)), 
                                  proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2)
area_BB_laea <- SpatialPoints(cbind(area_BB_latlon$lon, area_BB_latlon$lat), 
                              proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2)
area_SV_laea <- SpatialPoints(cbind(c(40, 40, 0, 0), c(85, 78, 78, 85)), 
                              proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2)

# IHO regions
IHO_EAO <- readOGR("data/arctic_regions/iho_eastern_arctic_ocean.shp",
                   verbose = F) %>% # Eastern Arctic Ocean
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)
IHO_WAO <- readOGR("data/arctic_regions/iho_western_arctic_ocean.shp",
                   verbose = F) %>% # Western Arctic Ocean
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)
IHO_BF <- readOGR("data/arctic_regions/iho_beaufort_sea.shp",
                  verbose = F) %>% # Beaufort Sea
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)
IHO_CAA <- readOGR("data/arctic_regions/iho_northwestern_passages.shp",
                   verbose = F) %>% # Canadian Arctic Archipelago
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)
IHO_BB <- readOGR("data/arctic_regions/iho_baffin_bay.shp",
                  verbose = F) %>% # Baffin Bay
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)
IHO_DS <- readOGR("data/arctic_regions/iho_davis_strait.shp", 
                  verbose = F) %>% # Davis Strait
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)
# Combine IHO areas
IHO_regions <- bind_rows(IHO_EAO, IHO_WAO, IHO_BF, IHO_CAA, IHO_BB, IHO_DS) 
rm(IHO_EAO, IHO_WAO, IHO_BF, IHO_CAA, IHO_BB, IHO_DS)
# IHO areas
IHO_sf_latlon <- dir_ls("data/arctic_regions/", glob = "*.shp") %>% 
  tibble(fname = .) %>%
  mutate(data = map(fname, read_sf)) %>%
  unnest(data) %>%
  st_as_sf() %>%
  st_transform(crs = crs(arctic_latlon)) %>%
  st_make_valid()
```

# Summary statistics

```{r summary-region}
# Calculate median and mean SA across all areas
SA_all_area <- SA_grid_laea %>%
  # filter(empty_clean == F) %>%
  group_by(year) %>% # per year
  summarise(n = n(),
            NASC_median = median(NASC_int, na.rm = T),
            NASC_mad = mad(NASC_int, na.rm = T), 
            NASC_mean = mean(NASC_int, na.rm = T),
            NASC_sd = sd(NASC_int, na.rm = T), 
            CM_median = median(CM, na.rm = T),
            CM_mad = mad(CM, na.rm = T),
            CM_mean = mean(CM, na.rm = T),
            CM_sd = sd(CM, na.rm = T)) %>%
  ungroup() %>%
  summarise(n = sum(n), # Mean across all areas and years
            NASC_median = round(mean(NASC_median, na.rm = T), 1),
            NASC_mad = round(mean(NASC_mad, na.rm = T), 1),
            NASC_mean = round(mean(NASC_mean, na.rm = T), 1),
            NASC_sd = round(mean(NASC_sd, na.rm = T), 1),
            CM_median = round(mean(CM_median, na.rm = T)),
            CM_mad = round(mean(CM_mad, na.rm = T)),
            CM_mean = round(mean(CM_mean, na.rm = T)),
            CM_sd = round(mean(CM_sd, na.rm = T))) %>%
  mutate(IHO_area = "All areas")

# Calculate median SA within each area
SA_grid_laea %>%
  # filter(empty_clean == F) %>%
  mutate(IHO_area == as.character(IHO_area)) %>%
  group_by(IHO_area, year) %>%  # median per year
  summarise(n = n(),
            NASC_median = median(NASC_int, na.rm = T),
            NASC_mad = mad(NASC_int, na.rm = T), 
            NASC_mean = mean(NASC_int, na.rm = T),
            NASC_sd = sd(NASC_int, na.rm = T), 
            CM_median = median(CM, na.rm = T),
            CM_mad = mad(CM, na.rm = T),
            CM_mean = mean(CM, na.rm = T),
            CM_sd = sd(CM, na.rm = T)) %>%
  ungroup() %>%
  group_by(IHO_area) %>% # Mean per area
 summarise(n = sum(n), # Mean across all areas and years
            NASC_median = round(mean(NASC_median, na.rm = T), 1),
            NASC_mad = round(mean(NASC_mad, na.rm = T), 1),
            NASC_mean = round(mean(NASC_mean, na.rm = T), 1),
            NASC_sd = round(mean(NASC_sd, na.rm = T), 1),
            CM_median = round(mean(CM_median, na.rm = T)),
            CM_mad = round(mean(CM_mad, na.rm = T)),
            CM_mean = round(mean(CM_mean, na.rm = T)),
            CM_sd = round(mean(CM_sd, na.rm = T))) %>%
  ungroup() %>% 
  bind_rows(., SA_all_area) %>%
  mutate(IHO_area = factor(
    case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic\nOcean",
              IHO_area == "West Arctic Ocean" ~ "West Arctic\nOcean",
              IHO_area == "Beaufort Sea" ~ "Beaufort Sea",
              IHO_area == "The Northwestern Passages" ~ "Can. Arctic\nArchipelago",
              IHO_area == "Baffin Bay" ~ "Baffin Bay",
              IHO_area == "Davis Strait" ~ "Davis Strait",
              IHO_area == "All areas" ~ "All areas"),
    levels = c("West Arctic\nOcean", "Beaufort Sea", "Can. Arctic\nArchipelago",
               "Baffin Bay", "Davis Strait", "East Arctic\nOcean", 
               "All areas"))) %>%
  # dplyr::select(-CM_median, -CM_mad) %>%
  kbl() %>%
  kable_classic()
```

# Plots

## Base map with IHO areas reprojcted

```{r map-areas, fig.height=4, fig.width=6}
# Bathymetric map of the Arctic with location of acoustic and trawl
p_map_laea <- bathy_laea %>%
  ggplot(aes(x = xc, y = yc)) +
  # Plot bathy
  geom_raster(aes(fill = depth_d)) +
  scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.3) +
  # Areas of interest
  geom_polygon(data = IHO_WAO, aes(x = xc, y = yc, group = group), fill = NA, col = "red", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_BF, aes(x = xc, y = yc, group = group), fill = NA, col = "purple", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_CAA, aes(x = xc, y = yc, group = group), fill = NA, col = "orange", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_BB, aes(x = xc, y = yc, group = group), fill = NA, col = "blue", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_DS, aes(x = xc, y = yc, group = group), fill = NA, col = "green", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_EAO, aes(x = xc, y = yc, group = group), fill = NA, col = "yellow", lwd = 0.3, lty = 1) +
  # Plot coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey30") +
  # Arctic circle
  geom_path(data = arctic_circle_laea, aes(x = xc, y = yc), col = "grey10", lty = 2, size = 0.3) +
  coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", panel.border = element_rect(fill = NA), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank())
ggsave("plots/base_map_laeamap_stations.png", p_map_laea, height = 3, width = 6, dpi = 600, units = "in")
p_map_laea
```

## Figure 1. Bathy map with sampling locations

Careful this map takes forever to compute (\> 18 h) when bathy has to be drawn.

```{r fig1-map-station-original, eval=FALSE, fig.align='center', fig.height=3.25, fig.width=6}
MVBS %>%
  mutate(lat = round(lat, 1),
         lon = round(lon, 1)) %>%
  group_by(lat,lon) %>%
  summarise(lat = mean(lat), 
            lon = mean(lon)) %>%
  ungroup() %>%
  ggplot(aes(x = lon, y = lat)) +
  # Plot bathy
  # geom_tile(data = bathy_df, aes(x = lon, y = lat, fill = depth_d)) +
  # scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.6) +
  # Plot coastlines
  geom_polygon(data = coast_10m_latlon, aes(x = lon, y = lat, group = group), fill = "grey70") +
  # Arctic circle
  geom_segment(aes(x = -180, xend = 0, y = 66.5, yend = 66.5), col = "grey40", lty = 2, size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 66.5, yend = 66.5), col = "grey40", lty = 2, size = 0.3) +
  # Areas of interest
  geom_shape(data = area_BF_CAA_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_BB_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_SV_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  # Acoustic data
  geom_point(size = 0.7, shape = 4, color = "black") +
  # Trawl locations
  geom_point(data = trawl_latlon, aes(x = lon, y = lat), shape = 23, size = 1.4, color = "black", fill = "orange") +
  # Change projection
  coord_map("azequalarea", ylim = c(66, 90), xlim = c(-160, 70), orientation = c(90,0,-60)) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", panel.border = element_rect(fill = NA), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank())
```

To overcome that, I project the bathy data on the EASE-Grid 2.0 North, prior to plotting. This results in a much quicker plotting time.

```{r fig1-map-station-laea, fig.align='center', fig.height=4, fig.width=6}
# Bathymetric map of the Arctic with location of acoustic and trawl
p_MVBS_laea <- MVBS_laea %>%
  ggplot(aes(x = xc, y = yc)) +
  # Plot bathy
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d)) +
  scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.6) +
  # Areas of interest
  geom_polygon(data = IHO_WAO, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_BF, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_CAA, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_BB, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_DS, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_EAO, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  # Plot coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey30") +
  # Arctic circle
  geom_path(data = arctic_circle_laea, aes(x = xc, y = yc), col = "grey10", lty = 2, size = 0.3) +
  # Acoustic data
  geom_point(size = 0.7, shape = 4, color = "black") +
  # Trawl locations
  geom_point(data = trawl_laea, aes(x = xc, y = yc), shape = 23, size = 1.4, color = "black", fill = "orange") +
  coord_fixed(xlim = c(-2700, 1500), ylim = c(-1900, 2000), expand = F) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", panel.border = element_rect(fill = NA), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank())
# ggsave("plots/Fig1_map_stations.png", p_MVBS_laea, height = 4, width = 6.5, dpi = 600, units = "in")
p_MVBS_laea
```

## Figure 2. Vertical S\~V\~ profiles

### Old plot

```{r fig2-Sv-profiles-area-year, fig.align='center', fig.width=6.5, fig.height=3}
col_pal <- c("#80CBB1", "#347BA5", "#302346") # Custom colour palette

Sv_prof_mean <- Sv_grid_laea %>% # Plot median profiles
  group_by(depth, IHO_area) %>% # Calculate mean and median Sv profiles per area per year
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                     IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                     IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                     IHO_area == "The Northwestern Passages" ~ "CAA",
                                     IHO_area == "Baffin Bay" ~ "BB",
                                     IHO_area == "Davis Strait" ~ "DS"),
                           levels = c("WAO_BF", "CAA", "BB", "DS", "EAO"))) %>%
  summarise(sv_lin_q0.05_areayear = median(sv_lin_q0.05),
            sv_lin_q0.50_areayear = median(sv_lin_q0.50),
            sv_lin_q0.95_areayear = median(sv_lin_q0.95)) %>%
  mutate(Sv_q0.05_median = 10 * log10(sv_lin_q0.05_areayear), 
         Sv_q0.50_median = 10 * log10(sv_lin_q0.50_areayear),
         Sv_q0.95_median = 10 * log10(sv_lin_q0.95_areayear))

p_Sv_grid_laea <- Sv_grid_laea %>% # Plot median profiles
  group_by(depth, IHO_area) %>% # Calculate mean and median Sv profiles per area per year
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                     IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                     IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                     IHO_area == "The Northwestern Passages" ~ "CAA",
                                     IHO_area == "Baffin Bay" ~ "BB",
                                     IHO_area == "Davis Strait" ~ "DS"),
                           levels = c("WAO_BF", "CAA", "BB", "DS", "EAO"))) %>%
  summarise(sv_lin_q0.05_areayear = median(sv_lin_q0.05),
            sv_lin_q0.25_areayear = median(sv_lin_q0.25),
            sv_lin_q0.50_areayear = median(sv_lin_q0.50),
            sv_lin_q0.75_areayear = median(sv_lin_q0.75),
            sv_lin_q0.95_areayear = median(sv_lin_q0.95)) %>%
  mutate(Sv_q0.05_median = 10 * log10(sv_lin_q0.05_areayear), 
         Sv_q0.25_median = 10 * log10(sv_lin_q0.25_areayear),
         Sv_q0.50_median = 10 * log10(sv_lin_q0.50_areayear),
         Sv_q0.25_median = 10 * log10(sv_lin_q0.25_areayear),
         Sv_q0.75_median = 10 * log10(sv_lin_q0.75_areayear),
         Sv_q0.95_median = 10 * log10(sv_lin_q0.95_areayear)) %>%
  ungroup() %>%
  # Plotting details for allowing geom_ribbon to work
  mutate(Sv_q0.05_median = case_when(Sv_q0.05_median == -999 ~ NaN,
                                     Sv_q0.05_median > -999 & Sv_q0.05_median <= -105 ~ -105,
                                     Sv_q0.05_median > -105 ~ Sv_q0.05_median),
         Sv_q0.25_median = case_when(Sv_q0.25_median == -999 ~ NaN,
                                     Sv_q0.25_median > -999 & Sv_q0.25_median <= -105 ~ -105,
                                     Sv_q0.25_median > -105 ~ Sv_q0.25_median),
         Sv_q0.50_median = case_when(Sv_q0.50_median == -999 ~ NaN,
                                     Sv_q0.50_median > -999 & Sv_q0.50_median <= -105 ~ -105,
                                     Sv_q0.50_median > -105 ~ Sv_q0.50_median),
         Sv_q0.75_median = case_when(Sv_q0.75_median == -999 ~ NaN,
                                     Sv_q0.75_median > -999 & Sv_q0.75_median <= -105 ~ -105,
                                     Sv_q0.75_median > -105 ~ Sv_q0.75_median),
         Sv_q0.95_median = case_when(Sv_q0.95_median == -999 ~ NaN,
                                     Sv_q0.95_median > -999 & Sv_q0.95_median <= -105 ~ -105,
                                     Sv_q0.95_median > -105 ~ Sv_q0.95_median)) %>%
  arrange(IHO_area, depth) %>%
  # Plot
  ggplot() +
  geom_vline(xintercept = 200, lty = 2, col = "grey20") +
  # geom_ribbon(aes(x = depth, ymin = Sv_q0.05_median, ymax = Sv_q0.95_median, fill = as.factor(year), group = year),
  #             alpha = 0.2, na.rm = T) +
  geom_ribbon(aes(x = depth, ymin = Sv_q0.05_median, ymax = Sv_q0.95_median), alpha = 0.2, na.rm = T) +
  geom_line(aes(x = depth, y = Sv_q0.50_median), na.rm = T) +
  # geom_line(aes(x = depth, y = Sv_q0.50_median, col = as.factor(year), group = year), na.rm = T) +
  scale_x_reverse("Depth (m)", breaks = seq(0, 1000, 200)) +
  geom_hline(yintercept = -105, col = "white") +
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 10), expand = c(0, 0)) +
  scale_color_manual(values = col_pal) +
  scale_fill_manual(values = col_pal) +
  coord_flip(ylim = c(-105, -65)) +
  facet_grid(~ IHO_area) +
  theme(legend.title = element_blank(),
        legend.position = c(0.94, 0.275),
        legend.background = element_blank(),
        legend.key = element_blank(), 
        panel.border = element_blank(),
        axis.line = element_line())
# ggsave("plots/Fig2_Sv_profiles_area_year.png", p_Sv_grid_laea, height = 3, width = 6.5, dpi = 600, units = "in")
p_Sv_grid_laea
```

### Lines

```{r, fig.width=6.5, fig.height=3.5}
col_pal <- c("#03051AFF", "#3F1B44FF", "#841E5AFF",
             "#CB1B4FFF", "#F06043FF", "#F6AA82FF") #viridisLite::rocket(n = 7)

# Find cells with no DSL
empty_DSL <- SA_grid_laea %>% 
  group_by(xc, yc, year, empty_clean) %>%
  summarise()
# Calculate median Sv profiles per area
Sv_prof_median <- Sv_grid_laea %>%
  left_join(., empty_DSL, by = c("year", "xc", "yc")) %>% # Add DSL presence
  # filter(empty_clean == F) %>% # Filter for DSL
  mutate(depth_round = rounder(depth, -10)) %>% # round down to nearest 20
  group_by(depth_round, IHO_area) %>%
  summarise(sv_lin50 = median(sv_lin_median),
            sv_lin025 = quantile(sv_lin_median, 0.025),
            sv_lin975 = quantile(sv_lin_median, 0.975)) %>% 
  ungroup() %>%
  mutate(Sv_median = 10 * log10(sv_lin50),
         Sv_025 = 10 * log10(sv_lin025),
         Sv_975 = 10 * log10(sv_lin975),
         IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic\nOcean",
                                     IHO_area == "West Arctic Ocean" ~ "West Arctic\nOcean",
                                     IHO_area == "Beaufort Sea" ~ "Beaufort Sea",
                                     IHO_area == "The Northwestern Passages" ~ "Can. Arctic\nArchipelago",
                                     IHO_area == "Baffin Bay" ~ "Baffin Bay",
                                     IHO_area == "Davis Strait" ~ "Davis Strait"),
                           levels = c("West Arctic\nOcean", "Beaufort Sea", "Can. Arctic\nArchipelago",
                                      "Baffin Bay", "Davis Strait", "East Arctic\nOcean")))
# Calculate center of mass
CM_prof <- Sv_prof_median %>%
  filter(depth_round >= 200) %>%
  group_by(IHO_area) %>%
  summarise(CM = sum(depth_round * sv_lin50) / sum(sv_lin50)) %>% # center of mass in meters 
  ungroup() %>%
  mutate(CM_round = as.character(round(CM, 0))) 

# Plot
p_Sv_prof_lines <- Sv_prof_median %>%
  ggplot() +
  geom_ribbon(aes(x = depth_round, ymin = Sv_025, ymax = Sv_975, fill = IHO_area), alpha = 0.3) + # 95 % of the Sv median
  geom_line(aes(x = depth_round, y = Sv_median, col = IHO_area), size = 0.8) + # Median Sv profile
  geom_vline(xintercept = 200, lty = 3) + # Mesopelagic zone
  geom_vline(data = CM_prof, aes(xintercept = CM), lty = 2) + # Center of mass
  geom_text(data = CM_prof, aes(x = CM -10, y = -70, label = as.character(CM_round)),
            vjust = 0, size = 3, fontface = "italic") + # Label center of mass
  # geom_rect(aes(xmin = 0, xmax = 200, ymin = -Inf, ymax = Inf), col = NA, fill = "grey87", alpha = 0.05) + # Mesopelagic zone
  scale_x_reverse("Depth (m)", breaks = seq(0, 1000, 200)) + 
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 10)) +
  scale_colour_manual(values = col_pal) +
  scale_fill_manual(values = col_pal) +
  # scale_colour_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  # scale_fill_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  coord_flip(ylim = c(-105, -65), xlim = c(1000, 0), expand = F) +
  facet_grid(~ IHO_area) +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(), 
        legend.position = "none")
ggsave("plots/Fig2_Sv_profiles_lines.png", p_Sv_prof_lines, device = agg_png, height = 3.5, width = 6.5, dpi = 600, units = "in")
p_Sv_prof_lines
```

### Points

```{r Fig2-plot, fig.width=7, fig.height=4.5}
p_Sv_prof_points <- Sv_grid_laea %>%
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic Ocean",
                                     IHO_area == "West Arctic Ocean" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "Beaufort Sea" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "The Northwestern Passages" ~ "Canadian Arctic\nArchipelago",
                                     IHO_area == "Baffin Bay" ~ "Baffin Bay",
                                     IHO_area == "Davis Strait" ~ "Davis Strait"),
                           levels = c("West Arctic Ocean\n& Beaufort Sea", "Canadian Arctic\nArchipelago",
                                      "Baffin Bay", "Davis Strait", "East Arctic Ocean"))) %>%
  mutate(depth_round = rounder(depth, -20)) %>% # round down to nearest 20
  group_by(depth_round, IHO_area, year, xc, yc) %>%
  summarise(sv_lin = median(sv_lin_q0.50)) %>%
  ungroup() %>%
  mutate(Sv_median = 10*log10(sv_lin)) %>%
  filter(Sv_median != -999) %>%
  ggplot() +
  geom_vline(xintercept = 200, col = "red", lty = 2) +
  geom_pointrange(mapping = aes(y = Sv_median, x = depth_round, col = depth_round < 200),
                  stat = "summary", fun = median, fun.min = function(z) {quantile(z, 0.05)}, 
                  fun.max = function(z) {quantile(z, 0.95)}, size = 0.2) + 
  scale_x_reverse("Depth (m)", breaks = seq(0, 1000, 100)) + 
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 20)) +
  scale_colour_manual(values = c("black", "grey60")) + 
  coord_flip(ylim = c(-110, -60), xlim = c(800, 20)) +
  facet_rep_grid(~ IHO_area) +
  guides(colour = "none") +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, "in"),
        plot.margin = unit(c(0, 0.1, 0, 0), "in"))
ggsave("plots/Fig2_Sv_profiles_points.png", p_Sv_prof_points, height = 4.5, width = 7, dpi = 600, units = "in")
p_Sv_prof_points
```

### Boxplots

```{r , fig.width=7, fig.height=4.5}
p_Sv_prof_boxplot <- Sv_grid_laea %>%
  filter(depth <= 800) %>%
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic Ocean",
                                     IHO_area == "West Arctic Ocean" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "Beaufort Sea" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "The Northwestern Passages" ~ "Canadian Arctic\nArchipelago",
                                     IHO_area == "Baffin Bay" ~ "Baffin Bay",
                                     IHO_area == "Davis Strait" ~ "Davis Strait"),
                           levels = c("West Arctic Ocean\n& Beaufort Sea", "Canadian Arctic\nArchipelago",
                                      "Baffin Bay", "Davis Strait", "East Arctic Ocean"))) %>%
  mutate(depth_round = rounder(depth, -25)) %>% # round down to nearest 20
  group_by(depth_round, IHO_area, year, xc, yc) %>%
  summarise(sv_lin = median(sv_lin_q0.50)) %>%
  ungroup() %>%
  mutate(Sv_median = 10*log10(sv_lin), 
         depth = factor(depth_round)) %>%
  filter(Sv_median != -999) %>%
  ggplot() +
  geom_vline(xintercept = 200, col = "red", lty = 2) +
  geom_boxplot(aes(x = depth, y = Sv_median, col = depth_round < 200), 
               outlier.size = 0.5, size = 0.5) + 
  scale_x_discrete("Depth (m)", breaks = seq(0, 1000, 100), limits = rev) +
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 20)) +
  scale_colour_manual(values = c("black", "grey60")) +
  coord_flip(ylim = c(-110, -60)) +
  facet_rep_wrap(~ IHO_area, nrow = 1) +
  guides(colour = "none") +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, "in"),
        plot.margin = unit(c(0, 0.1, 0, 0), "in"))
ggsave("plots/Fig2_Sv_profiles_boxplots.png", p_Sv_prof_boxplot, height = 4.5, width = 6.5, dpi = 600, units = "in")
p_Sv_prof_boxplot
```

## Figure 3. Boxplot mesopelagic NASC & Map detections

### Boxplot

```{r fig3-boxplot-NASC, fig.width=6, fig.height=5}
# Map NASC
map_DSL <- SA_grid_laea %>% 
  mutate(NASC_int_d = cut(NASC_int, c(0, 1, 10, 100, 1000, 10000, Inf))) %>%
  ggplot(aes(x = xc,  y = yc)) +
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d)) + # bathy
  scale_fill_grey("Depth (m)", start = 0.85, end = 0.3) +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey20") + # Coast
  geom_point(aes(col = NASC_int_d), size = 0.6) +
  scale_color_viridis_d(option = "plasma", 
                        labels = c("< 1", "1-10", "11-100", "101-1000", 
                                   "1001-10000", "> 10000")) +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
  # coord_fixed(xlim = c(-2600, 1100), ylim = c(-1600, 1900), expand = F) +
  guides(fill = "none",
         colour = guide_legend(override.aes = list(size = 2), 
                               nrow = 1)) + # Increase symbol size in legend
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
# Bxplot SA
# p_boxplot_SA <- 
  SA_grid_laea %>% # Boxplot of SA per region
  mutate(IHO_area = factor(
    case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic\nOcean",
              IHO_area == "West Arctic Ocean" ~ "West Arctic\nOcean",
              IHO_area == "Beaufort Sea" ~ "Beaufort Sea",
              IHO_area == "The Northwestern Passages" ~ "Can. Arctic\nArchipelago",
              IHO_area == "Baffin Bay" ~ "Baffin Bay",
              IHO_area == "Davis Strait" ~ "Davis Strait"),
    levels = c("West Arctic\nOcean", "Beaufort Sea", "Can. Arctic\nArchipelago",
               "Baffin Bay", "Davis Strait", "East Arctic\nOcean"))) %>%
  ggplot(aes(x = IHO_area, y = SA_int)) + 
  geom_boxplot(position = position_dodge(preserve = "single")) +
  scale_y_continuous(expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) +
  theme(panel.border = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(), 
        # legend.position = "none",
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Combine plots
p_map_SA_DSL <- plot_grid(map_DSL, p_boxplot_SA, 
                          ncol = 1, align = "v", axis = "lr") 
# Save and display plots
ggsave("plots/Fig3_map_boxplot_SA.png", p_map_SA_DSL,
       height = 5, width = 6, dpi = 600, units = "in")
p_map_SA_DSL
```

### Points 
```{r fig3-map-points}
map_DSL <- SA_grid_laea %>%  # Map of DSL detections
  mutate(NASC_int_d = cut(NASC_int, c(0, 1, 10, 100, 1000, 10000, Inf))) %>%
  ggplot(aes(x = xc,  y = yc)) +
  geom_raster(data = bathy_laea, 
              aes(x = xc, y = yc, fill = depth_d)) + # bathy
  scale_fill_grey("Depth (m)", start = 0.8, end = 0.3) +
  # new_scale_fill() +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey20") + # Coast
  geom_point(aes(col = NASC_int_d), size = 0.6) +
  scale_color_viridis_d(option = "turbo", 
                        labels = c("< 1", "1-10", "11-100", "101-1000", 
                                   "1001-10000", "> 10000")) +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 600), ylim = c(-1500, 1800), expand = F) +
  # coord_fixed(xlim = c(-2600, 1100), ylim = c(-1600, 1900), expand = F) +
  # Increase symbol size in legend
  guides(fill = "none",
         colour = guide_legend(override.aes = list(size = 2), nrow = 1)) + 
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

pointrange_NASC <- SA_grid_laea %>% # Pointrange of SA per region
  mutate(IHO_area = factor(
    case_when(
    IHO_area == "East Arctic Ocean" ~ "East Arctic\nOcean",
    IHO_area == "West Arctic Ocean" ~ "West Arctic\nOcean",
    IHO_area == "Beaufort Sea" ~ "Beaufort Sea",
    IHO_area == "The Northwestern Passages" ~ "Can. Arctic\nArchipelago",
    IHO_area == "Baffin Bay" ~ "Baffin Bay",
    IHO_area == "Davis Strait" ~ "Davis Strait"),
    levels = c("West Arctic\nOcean", "Beaufort Sea", "Can. Arctic\nArchipelago",
               "Baffin Bay", "Davis Strait", "East Arctic\nOcean"))) %>%
  group_by(IHO_area, year) %>%  # median per year
  summarise(NASC_median = median(NASC_int, na.rm = T),
            NASC_mean = mean(NASC_int, na.rm = T),
            NASC_q025 = quantile(NASC_int, 0.025),
            NASC_q975 = quantile(NASC_int, 0.975)) %>%
  ungroup() %>%
  group_by(IHO_area) %>% # Mean per area
  summarise(NASC_median = mean(NASC_median, na.rm = T),
            NASC_mean = mean(NASC_mean, na.rm = T),
            NASC_q025 = min(NASC_q025, na.rm = T),
            NASC_q975 = max(NASC_q975, na.rm = T)) %>%
  ungroup() %>%
  ggplot(aes(x = IHO_area)) +
  geom_point(aes(y = NASC_mean), shape = 18, size = 4, col = "#F05C22") +
  geom_pointrange(aes(y = NASC_median, ymin = NASC_q025, ymax = NASC_q975),
                  size = 0.25, col = "grey20") +
  scale_y_continuous(
    expression("s"[A]*" (m"^2*" nmi"^-2*")"), 
    breaks = c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000, 50000),
    trans = "log10") +
  theme(panel.border = element_blank(),
        panel.grid.major.y = element_line(colour = "grey90"),
        axis.title.x = element_blank(),
        axis.line = element_line(),
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Combine plots
p_map_pointrange_NASC <- plot_grid(map_DSL, pointrange_NASC, 
                                   ncol = 1, align = "v", axis = "lr") 
# Save and display plot
ggsave("plots/Fig3_map_pointrange_NASC.png", p_map_pointrange_NASC, 
       height = 5, width = 6, dpi = 600, units = "in")
p_map_pointrange_NASC
```

## Table 1. Abundance mesopelagic fish

```{r table1-heatmap-abundance}
trawl_area <- trawl %>%
  # Find IHO area for each trawl deployment
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(arctic_latlon), remove = F) %>%
  st_join(., IHO_sf_latlon, join = st_within) %>% # Append IHO region
  st_drop_geometry() %>%
  mutate(name = if_else(name == "The Northwestern Passages" & lon > -90, "Baffin Bay",
                if_else(name == "Arctic Ocean" & name_3 == "West Arctic Ocean", "West Arctic Ocean",
                if_else(name == "Arctic Ocean" & name_3 == "East Arctic Ocean", "East Arctic Ocean", name)))) %>%
  rename(IHO_area = name, area = area.x) %>%
  dplyr::select(-fname, -id, -longitude, -latitude, -min_x, -min_y, -max_x, 
                -max_y, -area.y, -mrgid, -bearings, -name_1, -mrgid_1, -name_2,
                -mrgid_2, -name_3, -mrgid_3) %>%
  # Calculate number of individual for each species per IHO region
  group_by(IHO_area, fish_species) %>% 
  summarise(number_fish = sum(number_fish)) %>%
  ungroup() %>%
  # Calculate total number of fish per IHO region
  group_by(IHO_area) %>%
  mutate(total_fish = sum(number_fish)) %>% 
  ungroup() %>%
  # Calculate relative abundance per station
  mutate(RA = (number_fish / total_fish) * 100) %>%
  mutate(IHO_area = factor(
    case_when(
      IHO_area == "East Arctic Ocean" ~ "East Arctic\nOcean\nn = 464",
      IHO_area == "West Arctic Ocean" ~ "West Arctic\nOcean",
      IHO_area == "Beaufort Sea" ~ "Beaufort Sea\nn = 54",
      IHO_area == "The Northwestern Passages" ~ "Can. Arctic\nArchipelago\nn = 889",
      IHO_area == "Baffin Bay" ~ "Baffin Bay\nn = 211",
      IHO_area == "Davis Strait" ~ "Davis Strait\nn = 21"),
    levels = c("West Arctic\nOcean",
               "Beaufort Sea\nn = 54",
               "Can. Arctic\nArchipelago\nn = 889", 
               "Baffin Bay\nn = 211", 
               "Davis Strait\nn = 21", 
               "East Arctic\nOcean\nn = 464"))) %>%
  # Format species name appropriately
  mutate(fish_species = str_replace(fish_species, pattern = "_", 
                                    replacement = " "),
         fish_species = str_replace(fish_species, pattern = " sp",
                                    replacement = " sp."),
         fish_species = str_to_sentence(fish_species),
         fish_species = if_else(fish_species == "Notolepis rissoi",
                                "Arctozenus risso", fish_species),
         fish_species = factor(fish_species, 
                               levels = c("Icelus bicornis",
                                          "Anarhichas lupus",
                                          "Reinhardtius hippoglossoides",
                                          "Arctozenus risso",
                                          "Melanogrammus aeglefinus",
                                          "Gadus morhua",
                                          "Leptoclinus maculatus",
                                          "Sebastes sp.",
                                          "Myctophidae",
                                          "Liparidae",
                                          "Boreogadus saida")),
         color_text = if_else(RA >= 40, "white", "black")) %>%
  # Plot
  ggplot() +
  geom_tile(aes(x = IHO_area, y = fish_species, fill = RA),
            color = "white", lwd = 0.6) +
  geom_text(aes(x = IHO_area, y = fish_species, 
                label = sprintf("%0.1f", round(RA, 1)),
                color = color_text), size = 3) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(labels = c("Twohorn sculpin",
                              "Atlantic wolffish",
                              "Greenland halibut",
                              "Spotted barracudina",
                              "Haddock",
                              "Atlantic cod",
                              "Daubed shanny",
                              "Redfish",
                              "Lanternfish",
                              "Snailfish",
                              "Polar cod"),
                   expand = c(0, 0)) +
  scale_colour_identity() +
  scale_fill_viridis_c("Relative\nabundance (%)  ", option = "rocket", 
                       breaks = seq(0, 100, 20), limits = c(0, 100), 
                       direction = -1) +
  guides(fill = guide_colorbar(label.position = "top")) +
  theme(axis.title = element_blank(),
        legend.position = "top",
        legend.title = element_text(vjust = 0),
        legend.title.align = 0.5,
        legend.key.height = unit(0.1, "in"),
        legend.key.width = unit(0.3, "in"),
        legend.box.margin = margin(0,0,-5,0))
# Save and display plot
ggsave("plots/Table1_relative_abundance_IHO.png", trawl_area, 
       height = 3.5, width = 5, dpi = 600, units = "in")
trawl_area
```

# Supplementary data

## OLD Figure 3. Map of mesopelagic backscatter hotspots

```{r fig3-map-sa-anomalies, fig.align='center', fig.height=3.25, fig.width=6}
col_pal <- c("#80cdc1",  "#f5f5f5", "#dfc27d", "#a6611a")
# Calculate mean sa anomaly over three years of data per area
map_sa_anomaly <- SA_anomaly_2deg %>%
  group_by(lat, lon, area, region) %>%
  summarise(year_sampled = n(),
            mean_ano_sa_int = mean(anomaly_NASC_int, na.rm = T)) %>%
  ungroup() %>%
  mutate(mean_ano_sa_int_d = factor(case_when(mean_ano_sa_int < -1 ~ "<-1",
                                              mean_ano_sa_int >= -1 & mean_ano_sa_int < -0.5 ~ "[-1; -0.5[",
                                              mean_ano_sa_int >= -0.5 & mean_ano_sa_int <= 0.5 ~ "[-0.5; 0.5]",
                                              mean_ano_sa_int > 0.5 & mean_ano_sa_int <= 1 ~ "]0.5; 1]",
                                              mean_ano_sa_int > 1 ~ ">1"),
                                    levels = c("<-1", "[-1; -0.5[", "[-0.5; 0.5]", "]0.5; 1]", ">1"))) %>%
  ggplot(aes(x = lon, y = lat)) +
  # Longitude lines
  geom_segment(aes(x = -180, xend = -180, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -150, xend = -150, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -120, xend = -120, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -90, xend = -90, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -60, xend = -60, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -30, xend = -30, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 0, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 180, xend = 180, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 150, xend = 150, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 120, xend = 120, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 90, xend = 90, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 60, xend = 60, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 30, xend = 30, y = 60, yend = 90), col = "grey90", size = 0.3) +
  # Latitude lines
  geom_segment(aes(x = -180, xend = 0, y = 60, yend = 60), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 60, yend = 60), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -180, xend = 0, y = 70, yend = 70), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 70, yend = 70), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -180, xend = 0, y = 80, yend = 80), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 80, yend = 80), col = "grey90", size = 0.3) +
  # Plot 500m isobath
  geom_contour(data = bathy_df, aes(x = lon, y = lat, z = depth), breaks = -500, size = 0.25, colour = "black", lty = 3) +
  # Plot coastlines
  geom_polygon(data = coast_10m_latlon, aes(x = lon, y = lat, group = group), fill = "grey70") +
  # Areas of interest
  geom_shape(data = area_BF_CAA_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_BB_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_SV_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  # Arctic circle
  geom_segment(aes(x = -180, xend = 100, y = 66.5, yend = 66.5), col = "#666766", lty = 2, size = 0.3) +
  # Plot data
  geom_tile(aes(fill = mean_ano_sa_int_d), color = "grey30", alpha = 0.8, size = 0.15) +
  scale_fill_manual("2015-2017\nAverage\nbackscatter\nanomaly", values = col_pal) +
  coord_map("azequalarea", ylim = c(66, 90), xlim = c(-160, 30), orientation = c(90, 0, -60)) +
  # Theme
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", 
        legend.title = element_text(hjust = 0.5),
        panel.border = element_rect(fill = NA),
        strip.text.x = element_blank(), 
        strip.background = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
map_sa_anomaly
```

```{r fig3-map-sa-anomalies-laea, fig.align='center', fig.height=4, fig.width=10}
SA_grid_laea %>% 
  ggplot() +
  # Plot bathy
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d)) +
  scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.3) +
  # scale_fill_brewer("Depth (m)", type = "seq", palette = "Greys") +
  guides(fill = "none") + # Remove legend
  new_scale_fill() +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey30") +
  # Plot backscatter anomalies
  geom_tile(aes(x = xc, y = yc, fill = NASC_anomaly_d), color = "grey30", size = 0.15) +
  scale_fill_manual("Normalized sA anomaly", values = rev(brewer.pal(n = 5, name = "BrBG"))) +
  # scale_fill_manual("Normalized sA anomaly", values = rev(brewer.pal(n = 5, name = "RdBu"))) +
  facet_wrap(~ year, ncol = 3) +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

## Table S3. Acoustic settings

```{r tableS3-acoustic-settings, echo=F, warning=F, message=F, fig.align='center'}
summary_MVBS <- MVBS %>%
  group_by(date,process_ID, filename, area, year) %>%
  summarise() %>% # Remove depth component
  ungroup() %>%
  group_by(area,year) %>% # Summarise total amount of files and total number of hours of data
  summarise(n_files=n(),
            duration_min=n_files*10,
            duration_h=round(duration_min/60))

# Create data frame and table
data.frame(year=c(rep(2015,3), rep(2016,3), rep(2017,3)),
           Area=rep(c("Beaufort Sea","Baffin Bay","Svalbard"), 3),
           area=rep(c("BF_CAA","BB","SV"),3),
           Vessel=c("CCGV Amundsen","CCGV Amundsen","RV Polarstern", # 2015
                    "CCGV Amundsen","CCGV Amundsen","RV Helmer Hanssen", # 2016
                    "FV Frosti","CCGV Amundsen","RV Polarstern"), # 2017
           Echosounder=c(rep("EK60",6), rep("EK80",1), rep("EK60",2)),
           Transducer_depth=c(rep(7,2),11,rep(7,2),8,6,7,11),
           Pulse_length=rep(1.024,9),
           Power=c(rep(2000,2),1000,rep(2000,5),1000)) %>%
  left_join(.,summary_MVBS, by=c("area", "year")) %>%
  dplyr::select(year, Area, Vessel, Echosounder, Transducer_depth, Pulse_length,
                Power, duration_h) %>%
  rename("Year"=year,
         "Transducers depth (m)"=Transducer_depth,
         "Pulse length (msec)"=Pulse_length,
         "Power (W)"=Power,
         "Acoustic data duration (h)"=duration_h) %>%
  mutate(Year="" ) %>% # remove year values for a more readable table
  kbl(align=c("l", "l", "l", "c", "c","c","c","c")) %>%
  kable_classic(full_width=F, html_font="Arial") %>%
  pack_rows("2015", 1, 3) %>%
  pack_rows("2016", 4, 6) %>%
  pack_rows("2017", 7, 9)
```
