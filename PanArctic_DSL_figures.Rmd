---
title: "PanArctic DSL - Figures"
author: "[Pierre Priou](mailto:pierre.priou@mi.mun.ca)"
date: "`r format(Sys.time(), '%Y/%m/%d at %H:%M')`"
output: 
  html_document:
    keep_md: yes
    code_folding: hide
  github_document:
    always_allow_html: true
---

# Package and data loading

```{r package-loading, message=FALSE}
# Load packages
library(tidyverse)  # Tidy code
library(lubridate)  # Deal with dates
library(kableExtra) # Pretty tables
library(cowplot)    # Plots on a grid
library(raster)     # Data gridding
library(rgdal)      # Read shapefiles
library(rworldxtra) # Higher resolution coastline data
library(marmap)     # Bathymetry data of the Arctic Ocean
library(ggforce)    # Draw polygons
library(cmocean)    # Pretty color palettes
library(ggpubr)     # Display stats with ggplot
library(RColorBrewer) # Diverging color palette
library(ggnewscale) # Multiple color scales on a single plot
library(lemon)      # Repeated axis on facets
library(DT)         # Interactive tables
library(ragg)       # Fix issues with plotting alpha and coord_cartesian
library(MetBrewer)  # Color palette
library(sf)         # Spatial data
library(fs)         # List files
library(scatterpie) # Pie charts on map
source("R/getNOAA.ice.bathy.R") # Load bathy data from NOAA
source("R/rounder.R")
# Custom figure theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size = 9),
             axis.title = element_text(size = 9),
             strip.text.x = element_text(size = 9, face = "plain",
                                         hjust = 0.5),
             strip.background = element_rect(colour = "transparent", 
                                             fill = "transparent"),
             legend.title = element_text(size = 9),
             legend.margin = margin(0, 0, 0, 0),
             legend.box.margin = margin(0, 0, -8, 0),
             panel.grid = element_blank(), 
             plot.margin = unit(c(0, 0, 0, 0), "in"))
options(dplyr.summarise.inform = F) # Suppress summarise() warning
```

```{r data-loading, message=FALSE}
# Map projection
arctic_latlon <- raster(extent(-155, 35, 66, 85), crs = "EPSG:4326")

# Laea projection for bathy and all other files
cell_res <- 150 # Cell resolution in km
arctic_laea <- raster(extent(-2700, 2700, -2700, 2700), crs = "EPSG:6931") 
projection(arctic_laea) <- gsub("units=m", "units=km", # Convert from m to km
                                projection(arctic_laea)) 
res(arctic_laea) <- c(cell_res, cell_res) # Define cell resolution

# Coastline shapefiles
coast_10m_latlon <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% 
  spTransform(CRSobj = crs(arctic_latlon)) %>% # Verify shapefile proj.
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  fortify() %>% # Convert to a dataframe for ggplot
  rename(lon = long)

# LME regions
LME_sf_laea <- read_sf("data/arctic_regions/LME/LME_2013_polygon.shp") %>%
    st_transform(crs = crs(arctic_laea))
LME_sf_latlon <- read_sf("data/arctic_regions/LME/LME_2013_polygon.shp") %>%
    st_transform(crs = crs(arctic_latlon))
LME <- readOGR("data/arctic_regions/LME/LME_2013_polygon.shp",
               verbose = F) %>% 
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to dataframe for ggplot
  rename(xc = long, yc = lat)

# Sutton 2017 Mesopelagic ecoregions
Sutton2017 <- st_read("data/arctic_regions/Sutton 2017/mmc.shp") %>%
  st_make_valid() %>%
  # Two regions do not have valid shape so I remove them
  mutate(row = seq(1,33,1)) %>%
  filter(!row %in% c(4, 32)) %>%
  # Calculate area in square km
  mutate(area = as.numeric(st_area(geometry))/1000) %>% 
  st_drop_geometry()

# Bathy data
bathy_df <- getNOAA.ice.bathy(lon1 = -180, lon2 = 180, lat1 = 50, lat2 = 90,
                              resolution = 2, keep = T, path = "data/bathy/") %>%
  fortify.bathy() %>%
  rename(lon = x, lat = y, depth = z)

# Arctic circle and areas of interest
arctic_circle_latlon <- data.frame(lon = seq(-180, 180, 0.1)) %>%
  mutate(lat = 66.5)

# Acoustic data
load("data/acoustics/MVBS_2015_2017.RData")
load(paste0("data/acoustics/SA_grids_", "50", "km.RData")) 
SA_grid_50 <- SA_grid_laea
load(paste0("data/acoustics/SA_grids_", cell_res, "km.RData")) 
load(paste0("data/acoustics/Sv_grids_", cell_res, "km.RData")) 
SA_integrated <- SA_integrated %>%
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(arctic_latlon), 
           remove = F) %>%
  # Append LME 
  st_join(., LME_sf_latlon, join = st_within) %>% 
  st_drop_geometry()  %>%
  mutate(LME = case_when(LME == "Beaufort Sea LME" ~ "BF",
                         LME == "Central Arctic LME" ~ "CAO",
                         LME == "Baffin Bay LME" ~ "BB",
                         LME == "Barents Sea LME" ~ "SV",
                         LME == "Northern Canadian Archipelago LME" ~
                           "NAR"),
         LME = factor(if_else(LME == "CAO" & lon >= 0, "SV",
                              if_else(LME == "CAO" & lon < 0, "BF", LME)),
                      levels = c("BF", "NAR", "BB", "SV"))) %>%
  droplevels()
# Location acoustic data
MVBS_laea <- MVBS %>%
  group_by(date, lat, lon) %>% 
  summarise() %>%
  ungroup() %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()

MVBS_latlon <- MVBS %>% # Location of acoustic data
  mutate(lat = round(lat, 1),
         lon = round(lon, 1)) %>%
  group_by(lat,lon) %>%
  summarise(lat = mean(lat), 
            lon = mean(lon)) %>%
  ungroup() 
SA_grid_laea <- SA_grid_laea %>%
  mutate(LME = case_when(LME == "Beaufort Sea LME" ~ "BF",
                         LME == "Central Arctic LME" ~ "CAO",
                         LME == "Baffin Bay LME" ~ "BB",
                         LME == "Barents Sea LME" ~ "SV",
                         LME == "Northern Canadian Archipelago LME" ~
                           "NAR"),
         LME = factor(if_else(LME == "CAO" & yc <= 0, "SV",
                      if_else(LME == "CAO" & yc > 0, "BF", LME)),
                      levels = c("BF", "NAR", "BB", "SV"))) %>%
  droplevels()

# Trawl data
load("data/nets/trawl_mwt_2015_2017.RData")
load("data/nets/trawl_length.RData")
trawl_latlon <- trawl_station %>% # Location of trawls
  group_by(date) %>%
  summarise(lat = mean(lat),
            lon = mean(lon),
            year = year(date))
trawl <- trawl %>%
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(arctic_latlon), 
           remove = F) %>%
  # Append LME 
  st_join(., LME_sf_latlon, join = st_within) %>% 
  st_drop_geometry()  %>%
  mutate(LME = case_when(LME == "Beaufort Sea LME" ~ "BF",
                         LME == "Central Arctic LME" ~ "CAO",
                         LME == "Baffin Bay LME" ~ "BB",
                         LME == "Barents Sea LME" ~ "SV",
                         LME == "Northern Canadian Archipelago LME" ~
                           "NAR"),
         LME = factor(if_else(LME == "CAO" & lon >= 0, "SV",
                              if_else(LME == "CAO" & lon < 0, "BF", LME)),
                      levels = c("BF", "NAR", "BB", "SV"))) %>%
  droplevels()

# Remote sensing data
load(paste0("data/remote_sensing/physics_grids_", cell_res, "km.RData"))
phy_grid_laea_150 <- phy_grid_laea %>%
  st_as_sf(coords = c("xc", "yc"), crs = st_crs(arctic_laea), remove = F) %>% 
  st_join(., LME_sf_laea, join = st_within) %>% # Append LME 
  st_drop_geometry()
 
load(paste0("data/remote_sensing/physics_grids_", "25", "km.RData"))
phy_grid_laea_hd <- phy_grid_laea %>% 
  st_as_sf(coords = c("xc", "yc"), crs = st_crs(arctic_laea), remove = F) %>% 
  st_join(., LME_sf_laea, join = st_within) %>% # Append LME 
  st_drop_geometry()
load(paste0("data/remote_sensing/chl_grids_", cell_res, "km.RData"))
chl_grid_laea_150 <- chl_grid_laea
load(paste0("data/remote_sensing/chl_grids_", "50", "km.RData"))
chl_grid_laea_hd <- chl_grid_laea %>%
  filter(cell_res == 50)

# Statistics
load("data/statistics/LM_results.RData")
SA_lm <- SA_lm %>%
  mutate(shape = factor(if_else(LME == "NAR", 0, 1)),
         LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "North. Barents Sea"),
                      levels = c("Beaufort Sea", "Baffin Bay",
                                 "North. Barents Sea", "Nares Strait")))
LM_area_res <- LM_area_res %>%
    mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "North. Barents Sea"),
                      levels = c("Beaufort Sea", "Baffin Bay",
                                 "North. Barents Sea", "Nares Strait")))
load("data/statistics/LM_BB_results.RData")
load("data/statistics/GAMSA_results.RData")
predSA_I <- predSA_I %>%
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "North. Barents Sea"),
                      levels = c("Beaufort Sea", "Baffin Bay", 
                                 "North. Barents Sea")))
SA_df <- SA_df %>%
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "North. Barents Sea"),
                      levels = c("Beaufort Sea", "Baffin Bay", 
                                 "North. Barents Sea")))
```

I re-project data from the WGS84 projection to the EASE-Grid 2.0 North projection.

```{r data-laea-projection, cache=TRUE}
# Bahty projection: EPSG:6931 with a 5 x 5 km cell resolution
proj_bathy_laea <- raster(extent(-2700, 2700, -2700, 2700), 
                          crs = "EPSG:6931", res = c(5, 5)) # Seaice projection
projection(proj_bathy_laea) <- gsub("units=m", "units=km", # Convert from m to km
                                    projection(arctic_laea)) 

# Project bathymetric data 
bathy_laea <- SpatialPointsDataFrame(SpatialPoints(cbind(bathy_df$lon,
                                                         bathy_df$lat),
                                                   proj4string = CRS("EPSG:4326")),
                                     data.frame(depth = bathy_df$depth)) %>%
  spTransform(., CRSobj = crs(proj_bathy_laea)) %>% # Change projection to laea
  rasterize(., proj_bathy_laea, fun = mean, na.rm = T) %>% # Rasterize data
  dropLayer(1) %>% # Remove ID layer
  rasterToPoints() %>% # Convert raster to data frame
  as.data.frame() %>%
  rename(xc = x, yc = y) %>%
  ungroup() %>%
  mutate(depth_d = factor(
    case_when(between(depth, -100, Inf) ~ "0-100",
              between(depth, -200, -100) ~ "100-200",
              between(depth, -500, -200) ~ "200-500",
              between(depth, -1000, -500) ~ "500-1000",
              between(depth, -2000, -1000) ~ "1000-2000",
              between(depth, -3000, -2000) ~ "2000-3000",
              between(depth, -4000, -3000) ~ "3000-4000",
              between(depth, -Inf, -4000) ~ "> 4000"),
    levels = c(">0", "0-100", "100-200", "200-500", "500-1000",
               "1000-2000", "2000-3000", "3000-4000", "> 4000")))

# Coastline shapefile
coast_10m_laea <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% 
  spTransform(CRSobj = crs(arctic_latlon)) %>% 
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to a dataframe for ggplot
  rename(xc = long, yc = lat)

# Arctic circle and areas of interest
arctic_circle_laea <- SpatialPoints(cbind(arctic_circle_latlon$lon,
                                          arctic_circle_latlon$lat), 
                                    proj4string = CRS("EPSG:4326")) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2) # Rename variables

# IHO regions
# IHO_EAO <- readOGR("data/arctic_regions/IHO/iho_eastern_arctic_ocean.shp",
#                    verbose = F) %>% # Eastern Arctic Ocean
#   spTransform(CRSobj = crs(arctic_latlon)) %>% 
#   spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
#   fortify() %>% # Convert to dataframe for ggplot
#   rename(xc = long, yc = lat)
# IHO_WAO <- readOGR("data/arctic_regions/IHO/iho_western_arctic_ocean.shp",
#                    verbose = F) %>% # Western Arctic Ocean
#   spTransform(CRSobj = crs(arctic_latlon)) %>% 
#   spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
#   fortify() %>% # Convert to dataframe for ggplot
#   rename(xc = long, yc = lat)
# IHO_BF <- readOGR("data/arctic_regions/IHO/iho_beaufort_sea.shp",
#                   verbose = F) %>% # Beaufort Sea
#   spTransform(CRSobj = crs(arctic_latlon)) %>% 
#   spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
#   fortify() %>% # Convert to dataframe for ggplot
#   rename(xc = long, yc = lat)
# IHO_CAA <- readOGR("data/arctic_regions/IHO/iho_northwestern_passages.shp",
#                    verbose = F) %>% # Canadian Arctic Archipelago
#   spTransform(CRSobj = crs(arctic_latlon)) %>% 
#   spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
#   fortify() %>% # Convert to dataframe for ggplot
#   rename(xc = long, yc = lat)
# IHO_BB <- readOGR("data/arctic_regions/IHO/iho_baffin_bay.shp",
#                   verbose = F) %>% # Baffin Bay
#   spTransform(CRSobj = crs(arctic_latlon)) %>% 
#   spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
#   fortify() %>% # Convert to dataframe for ggplot
#   rename(xc = long, yc = lat)
# IHO_DS <- readOGR("data/arctic_regions/IHO/iho_davis_strait.shp", 
#                   verbose = F) %>% # Davis Strait
#   spTransform(CRSobj = crs(arctic_latlon)) %>% 
#   spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
#   fortify() %>% # Convert to dataframe for ggplot
#   rename(xc = long, yc = lat)
# # Combine IHO areas
# IHO_regions <- bind_rows(IHO_EAO, IHO_WAO, IHO_BF, IHO_CAA, IHO_BB, IHO_DS) 
# rm(IHO_EAO, IHO_WAO, IHO_BF, IHO_CAA, IHO_BB, IHO_DS)
# # IHO areas
# IHO_sf_latlon <- dir_ls("data/arctic_regions/IHO", glob = "*.shp") %>% 
#   tibble(fname = .) %>%
#   mutate(data = map(fname, read_sf)) %>%
#   unnest(data) %>%
#   st_as_sf() %>%
#   st_transform(crs = crs(arctic_latlon)) %>%
#   st_make_valid()


# Location of trawls
trawl_laea <- SpatialPointsDataFrame(
  SpatialPoints(cbind(trawl_latlon$lon, trawl_latlon$lat), 
                proj4string = CRS("EPSG:4326")),
  data.frame(year = trawl_latlon$year, 
             lat = trawl_latlon$lat,
             lon = trawl_latlon$lon)) %>%
  spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
  as.data.frame() %>%
  rename(xc = coords.x1, yc = coords.x2) %>%
  st_as_sf(coords = c("xc", "yc"), crs = st_crs(arctic_laea), remove = F) %>%
  st_join(., LME_sf_laea, join = st_within) %>% # Append IHO region
  st_drop_geometry() %>%
  # mutate(name = if_else(name == "The Northwestern Passages" & coords.x2 < 0,
  #                       "Baffin Bay",
  #               if_else(name == "Arctic Ocean" & name_3 == "West Arctic Ocean", 
  #                       "West Arctic Ocean",
  #               if_else(name == "Arctic Ocean" & name_3 == "East Arctic Ocean",
  #                       "East Arctic Ocean", name)))) %>%
  # rename(xc = coords.x1, yc = coords.x2, IHO_area = name) %>%
  dplyr::select(year, LME, lat, lon, xc, yc)

# Location of acoustic data
# MVBS_laea <- SpatialPoints(cbind(MVBS_latlon$lon, MVBS_latlon$lat), 
#                            proj4string = CRS("EPSG:4326")) %>%
#   spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
#   as.data.frame() %>%
#   rename(xc = coords.x1, yc = coords.x2) # Rename variables
```

# Summary statistics

```{r summary-region}
# Calculate median and mean SA across all areas
SA_all_area <- SA_grid_laea %>%
  # filter(empty_clean == F) %>%
  # group_by(year) %>% # per year
  summarise(n = n(),
            NASC_int_median = median(NASC_int, na.rm = T),
            NASC_int_mad = mad(NASC_int, na.rm = T), 
            NASC_int_mean = mean(NASC_int, na.rm = T),
            NASC_int_sd = sd(NASC_int, na.rm = T), 
            NASC_min = min(NASC_int, na.rm = T),
            NASC_max = max(NASC_int, na.rm = T),
            CM_median = median(CM, na.rm = T),
            CM_mad = mad(CM, na.rm = T),
            CM_mean = mean(CM, na.rm = T),
            CM_sd = sd(CM, na.rm = T)) %>%
  # ungroup() %>%
  # summarise(n = sum(n), # Mean across all areas and years
  #           NASC_int_median = round(mean(NASC_int_median, na.rm = T), 1),
  #           NASC_int_mad = round(mean(NASC_int_mad, na.rm = T), 1),
  #           NASC_int_mean = round(mean(NASC_int_mean, na.rm = T), 1),
  #           NASC_int_sd = round(mean(NASC_int_sd, na.rm = T), 1),
  #           CM_median = round(mean(CM_median, na.rm = T)),
  #           CM_mad = round(mean(CM_mad, na.rm = T)),
  #           CM_mean = round(mean(CM_mean, na.rm = T)),
  #           CM_sd = round(mean(CM_sd, na.rm = T))) %>%
  mutate(LME = "All areas")

# Calculate median SA within each area
SA_grid_laea %>%
  mutate(LME == as.character(LME)) %>%
  group_by(LME) %>% # median per year
  summarise(n = n(),
            NASC_int_median = median(NASC_int, na.rm = T),
            NASC_int_mad = mad(NASC_int, na.rm = T), 
            NASC_int_mean = mean(NASC_int, na.rm = T),
            NASC_int_sd = sd(NASC_int, na.rm = T), 
            NASC_min = min(NASC_int, na.rm = T),
            NASC_max = max(NASC_int, na.rm = T),
            CM_median = median(CM, na.rm = T),
            CM_mad = mad(CM, na.rm = T),
            CM_mean = mean(CM, na.rm = T),
            CM_sd = sd(CM, na.rm = T)) %>%
  ungroup() %>%
  # group_by(LME) %>% # Mean per area
  # summarise(n = sum(n), # Mean across all areas and years
  #           NASC_int_median = round(mean(NASC_int_median, na.rm = T), 1),
  #           NASC_int_mad = round(mean(NASC_int_mad, na.rm = T), 1),
  #           NASC_int_mean = round(mean(NASC_int_mean, na.rm = T), 1),
  #           NASC_int_sd = round(mean(NASC_int_sd, na.rm = T), 1),
  #           NASC_mean2 = round(mean(NASC_mean2, na.rm = T), 3),
  #           NASC_sd2 = round(mean(NASC_sd2, na.rm = T), 3),
  #           CM_median = round(mean(CM_median, na.rm = T)),
  #           CM_mad = round(mean(CM_mad, na.rm = T)),
  #           CM_mean = round(mean(CM_mean, na.rm = T)),
  #           CM_sd = round(mean(CM_sd, na.rm = T))) %>%
  # ungroup() %>% 
  bind_rows(., SA_all_area) %>%
  mutate(LME = factor(LME, levels = c("BF", "BB", "SV", "All areas"))) %>%
  kbl() %>%
  kable_classic()
```

# Plots

## Figure 1. Base map with IHO areas reprojcted

```{r map-areas, fig.height=4, fig.width=6}
lat70 <- data.frame(lon = seq(-180, 180, length.out = 1000)) %>%
  mutate(lat = rep(70, 1000)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()
lat80 <- data.frame(lon = seq(-180, 180, length.out = 1000)) %>%
  mutate(lat = rep(80, 1000)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()
lon0 <- data.frame(lon = rep(0, 1000)) %>%
  mutate(lat =  seq(0, 90, length.out = 1000)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()
lon90 <- data.frame(lon = rep(90, 1000)) %>%
  mutate(lat =  seq(0, 90, length.out = 1000)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()
lon180 <- data.frame(lon = rep(180, 1000)) %>%
  mutate(lat =  seq(0, 90, length.out = 1000)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()
lon90e <- data.frame(lon = rep(-90, 1000)) %>%
  mutate(lat =  seq(0, 90, length.out = 1000)) %>%
  st_as_sf(coords = c("lon", "lat"),
           crs = st_crs("EPSG:4326"), remove = F) %>% # Transform into sf
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry()


map_laea <- bathy_laea %>%
  ggplot(aes(x = xc, y = yc)) +
  # Plot bathy
  geom_raster(aes(fill = depth_d), alpha = 0.8) +
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  # guides(fill = "none") + 
  new_scale_fill() +
  # LME
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group),
               col = "black", fill = NA, alpha = 0.2, 
               lwd = 0.5, lty = 1) +
  # Plot coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey30") +
  # Latitudes 
  geom_path(data = lat70, aes(x = xc, y = yc), 
            col = "white", lty = 2, size = 0.4) +
  geom_path(data = lat80, aes(x = xc, y = yc), 
            col = "white", lty = 2, size = 0.4) +
  # Arctic circle
  geom_path(data = arctic_circle_laea, aes(x = xc, y = yc), 
            col = "white", lty = 2, size = 0.4) +
  # coord_fixed(xlim = c(-2450, 1200), ylim = c(-1500, 2000), expand = F) +
  # coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1800), expand = F) +
  coord_fixed(xlim = c(-2500, 1700), ylim = c(-1700, 2200), expand = F) +
  guides(fill = "none") +
  # Acoustics
  geom_point(data = MVBS_laea, aes(x = xc, y = yc), 
             shape = 20, col = "#009E73", alpha = 0.5) +
  # Trawls
  geom_point(data = trawl_laea, aes(x = xc, y = yc),
             shape = 23, fill = "#E69F00", size = 2) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 0.5) +

  theme(legend.position = "right", 
        panel.border = element_rect(fill = NA),
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank())
ggsave("plots/base_map_laea_stations.png",
       map_laea, height = 4, width = 6, dpi = 600, units = "in")
col_pal <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

map_laea_lon <- bathy_laea %>%
  ggplot(aes(x = xc, y = yc)) +
  # Plot bathy
  geom_raster(aes(fill = depth_d), alpha = 0.8) +
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  # guides(fill = "none") +
  new_scale_fill() +
  # LME
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group),
               col = "black", fill = NA, alpha = 0.2, 
               lwd = 0.5, lty = 1) +
  # Plot coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey30") +
  # Latitudes 
  geom_path(data = lat70, aes(x = xc, y = yc), 
            col = "white", lty = 2, size = 0.4, alpha = 0.75) +
  geom_path(data = lat80, aes(x = xc, y = yc), 
            col = "white", lty = 2, size = 0.4, alpha = 0.75) +
  # Longitudes 
  geom_path(data = lon0, aes(x = xc, y = yc), 
            col = "red", lty = 1, size = 0.4, alpha = 0.75) +
  geom_path(data = lon90, aes(x = xc, y = yc), 
            col = "red", lty = 1, size = 0.4, alpha = 0.75) +
  geom_path(data = lon180, aes(x = xc, y = yc), 
            col = "red", lty = 1, size = 0.4, alpha = 0.75) +
  geom_path(data = lon90e, aes(x = xc, y = yc), 
            col = "red", lty = 1, size = 0.4, alpha = 0.75) +
  # Arctic circle
  geom_path(data = arctic_circle_laea, aes(x = xc, y = yc), 
            col = "white", lty = 2, size = 0.4, alpha = 0.75) +
  # coord_fixed(xlim = c(-2450, 1200), ylim = c(-1500, 2000), expand = F) +
  # coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1800), expand = F) +
  coord_fixed(xlim = c(-2500, 1700), ylim = c(-1700, 2200), expand = F) +
  guides(fill = "none") +
  # Acoustics
  geom_point(data = MVBS_laea, aes(x = xc, y = yc), 
             shape = 20, col = "#009E73", alpha = 0.5) +
  # Trawls
  geom_point(data = trawl_laea, aes(x = xc, y = yc),
             shape = 18, col = "#E69F00", size = 2) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 0.5) +

  theme(legend.position = "right", 
        panel.border = element_rect(fill = NA),
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank())
ggsave("plots/base_map_laea_stations_lon.png",
       map_laea_lon, height = 4, width = 6, dpi = 600, units = "in")
```

## Figure 2. Boxplot mesopelagic NASC

```{r boxplot-NASC}
# NASC_all_year <- SA_grid_laea %>%
#   mutate(year = 9999)
# boxplot_NASC <- bind_rows(SA_grid_laea, NASC_all_year) %>%
boxplot_NASC <- SA_grid_laea %>%
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "Northern\nBarents Sea",
                                LME == "All areas" ~ "All areas",),
                      levels = c("Beaufort Sea", "Nares Strait", 
                                 "Baffin Bay", "Northern\nBarents Sea",
                                 "All areas")),
    # year = factor(year, levels = c(2015, 2016, 2017, 9999))) %>%
    year = factor(year)) %>%
  group_by(LME) %>%
  mutate(mean_NASC = mean(NASC_int)) %>%
  ggplot(aes(x = LME)) +
  geom_boxplot(aes(y = 10*log10(NASC_int), col = LME),
               size = 0.4, outlier.size = 0.7,
               alpha = 0.8, position = position_dodge(preserve = "single")) +
  geom_point(aes(y = 10*log10(mean_NASC), fill = LME), shape = 23) + 
  scale_x_discrete(labels = c("BF", "NAR", "BB", "BA")) +
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    position = "left",
    breaks = seq(0, 40, 10),
    sec.axis =
      sec_axis(trans = ~10^(./10),
               name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
               breaks = c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000))) +
  scale_colour_manual(values =  c("#132B69", "grey50", "#03739B", "#93AA43")) +
  scale_fill_manual(values =  c("#132B69", "grey50", "#03739B", "#93AA43")) +
  coord_cartesian(ylim = c(-4, 43)) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.key.width = unit(0.15, "in"),
        legend.key.height = unit(0.15, "in"),
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Save and display plot
ggsave("plots/Fig3_boxplot_SA.png", boxplot_NASC,
       height = 2.5, width = 3.5, dpi = 600, units = "in")
boxplot_NASC
```


## Figure 3. Abundance mesopelagic fish and map

### Data preparation

I prepare the datasets for the table (relative abundance per area) and the map (relative abundance per station).

```{r relative-abundance-area}
trawl_area_df <- trawl %>%
  # Find IHO area for each trawl deployment
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(arctic_latlon), 
           remove = F) %>%
  st_join(., LME_sf_latlon, join = st_within) %>% # Append IHO region
  st_drop_geometry() %>%
  mutate(LME = if_else(LME == "CAO" & lon > 0, "SV",
               if_else(LME == "CAO" & lon < 0, "BF", LME))) %>%
  # Calculate number of individual for each species per IHO region
  group_by(LME, fish_species) %>% 
  summarise(number_fish = sum(number_fish)) %>%
  ungroup() %>%
  # Calculate total number of fish per IHO region
  group_by(LME) %>%
  mutate(total_fish = sum(number_fish)) %>% 
  ungroup() %>%
  # Calculate relative abundance per station
  mutate(RA = (number_fish / total_fish) * 100) %>%
  mutate(LME = factor(
    case_when(
      LME == "Barents Sea LME" ~ "N. Barents Sea\nn = 464",
      LME == "Beaufort Sea LME" ~ "Beaufort Sea\nn = 923",
      LME == "Baffin Bay LME" ~ "Baffin Bay\nn = 232"),
    levels = c("Beaufort Sea\nn = 923",
               "Baffin Bay\nn = 232",
               "N. Barents Sea\nn = 464"))) %>%
  # Format species name appropriately
  mutate(fish_species = str_replace(fish_species, pattern = "_", 
                                    replacement = " "),
         fish_species = str_replace(fish_species, pattern = " sp",
                                    replacement = " sp."),
         fish_species = str_to_sentence(fish_species),
         fish_species = if_else(fish_species == "Notolepis rissoi",
                                "Arctozenus risso", fish_species),
         fish_species = factor(fish_species, 
                               levels = c("Icelus bicornis",
                                          "Anarhichas lupus",
                                          "Reinhardtius hippoglossoides",
                                          "Arctozenus risso",
                                          "Melanogrammus aeglefinus",
                                          "Gadus morhua",
                                          "Leptoclinus maculatus",
                                          "Sebastes sp.",
                                          "Myctophidae",
                                          "Liparidae",
                                          "Boreogadus saida")),
         color_text = if_else(RA >= 40, "white", "black")) 
```

```{r realtive-abundance-station}
trawl_station_df <- trawl %>%
  # Find LME for each trawl deployment
  st_as_sf(coords = c("lon", "lat"), crs = st_crs(arctic_latlon),
           remove = F) %>%
  st_join(., LME_sf_latlon, join = st_within) %>% # Append LME
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry() %>%
  mutate(fish_species2 = case_when(
    fish_species == "boreogadus_saida" ~ "Arctic cod",
    fish_species == "liparidae" ~ "Snailfish",
    fish_species == "myctophidae" ~ "Lanternfish",
    fish_species == "sebastes_sp" ~ "Redfish",
    !fish_species %in% c("boreogadus_saida", "liparidae", 
                         "myctophidae", "sebastes_sp") ~ "Other")) %>%
  # Calculate number of individual for each species per station
  group_by(year, LME, date, station, deployment, lat,
           lon, xc, yc, fish_species2) %>% 
  summarise(number_fish = sum(number_fish)) %>%
  ungroup() %>%
  # Calculate total number of fish per station
  group_by(year, LME, date, station, deployment, lat, lon, xc, yc) %>% 
  mutate(total_fish = sum(number_fish)) %>% 
  ungroup() %>%
  # Calculate relative abundance per station
  mutate(RA = (number_fish / total_fish) * 100) %>%
  dplyr::select(year, LME, xc, yc, RA, fish_species2) %>% 
  pivot_wider(names_from = fish_species2, values_from = RA, 
              values_fill = 0) %>%
  # Jitter coordinates to avoid overplotting
  mutate(row = seq(1, 18, 1),
         xc_jit = case_when(xc == xc[1] & yc == yc[1] ~ xc[1],
                            xc == xc[2] & yc == yc[2] ~ xc[2],
                            xc == xc[3] & yc == yc[3] ~ xc[3] - 25,
                            xc == xc[4] & yc == yc[4] ~ xc[4],
                            xc == xc[5] & yc == yc[5] ~ xc[5] + 25,
                            xc == xc[6] & yc == yc[6] ~ xc[6],
                            xc == xc[7] & yc == yc[7] ~ xc[7],
                            xc == xc[8] & yc == yc[8] ~ xc[8],
                            xc == xc[9] & yc == yc[9] ~ xc[9],
                            xc == xc[10] & yc == yc[10] ~ xc[10],
                            xc == xc[11] & yc == yc[11] ~ xc[11],
                            xc == xc[12] & yc == yc[12] ~ xc[12] + 130,
                            xc == xc[13] & yc == yc[13] ~ xc[13],
                            xc == xc[14] & yc == yc[14] ~ xc[14] - 130,
                            xc == xc[15] & yc == yc[15] ~ xc[15],
                            xc == xc[16] & yc == yc[16] ~ xc[16] + 75,
                            xc == xc[17] & yc == yc[17] ~ xc[17],
                            xc == xc[18] & yc == yc[18] ~ xc[18]),
         yc_jit = case_when(xc == xc[1] & yc == yc[1] ~ yc[1] - 25,
                            xc == xc[2] & yc == yc[2] ~ yc[2] + 25,
                            xc == xc[3] & yc == yc[3] ~ yc[3],
                            xc == xc[4] & yc == yc[4] ~ yc[4] - 60,
                            xc == xc[5] & yc == yc[5] ~ yc[5] - 25,
                            xc == xc[6] & yc == yc[6] ~ yc[6],
                            xc == xc[7] & yc == yc[7] ~ yc[7] + 25,
                            xc == xc[8] & yc == yc[8] ~ yc[8] - 50,
                            xc == xc[9] & yc == yc[9] ~ yc[9] + 25,
                            xc == xc[10] & yc == yc[10] ~ yc[10] + 50,
                            xc == xc[11] & yc == yc[11] ~ yc[11] + 60,
                            xc == xc[12] & yc == yc[12] ~ yc[12] + 35,
                            xc == xc[13] & yc == yc[13] ~ yc[13],
                            xc == xc[14] & yc == yc[14] ~ yc[14] - 35,
                            xc == xc[15] & yc == yc[15] ~ yc[15],
                            xc == xc[16] & yc == yc[16] ~ yc[16] - 125,
                            xc == xc[17] & yc == yc[17] ~ yc[17],
                            xc == xc[18] & yc == yc[18] ~ yc[18] - 50))
```

### Plot

Plot the the heatmap and map together.

```{r heatmap-map-trawl}
# Heatmap
heatmap_RA <- trawl_area_df %>%
  ggplot() +
  geom_tile(aes(x = LME, y = fish_species, fill = RA),
            color = "white", lwd = 0.6) +
  geom_text(aes(x = LME, y = fish_species, 
                label = sprintf("%0.1f", round(RA, 1)),
                color = color_text), size = 3) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(labels = c("Twohorn sculpin",
                              "Atlantic wolffish",
                              "Greenland halibut",
                              "Spotted barracudina",
                              "Haddock",
                              "Atlantic cod",
                              "Daubed shanny",
                              "Redfish",
                              "Lanternfish",
                              "Snailfish",
                              "Polar cod"),
                   expand = c(0, 0)) +
  scale_colour_identity() +
  scale_fill_viridis_c("Relative\nabundance (%)  ", option = "mako",
                       breaks = seq(0, 100, 20), limits = c(0, 100),
                       direction = -1) +
  guides(fill = guide_colorbar(label.position = "top")) +
  theme(axis.title = element_blank(),
        legend.position = "top",
        legend.title = element_text(vjust = 0),
        legend.title.align = 0.5,
        legend.key.height = unit(0.1, "in"),
        legend.key.width = unit(0.25, "in"),
        legend.box.margin = margin(0, 0, -5, 0),
        plot.margin = unit(c(0, 0.1, 0.01, 0), "in"))

map_RA <- trawl_station_df %>%
  ggplot() +
  # Bathymetry
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d),
              alpha = 0.8) + 
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  guides(fill = "none") + 
  new_scale_fill() + 
  # LME 
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group), 
               col = "black", fill = NA, lwd = 0.3, alpha = 1) + # LME
  # Coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey25") + # Coast
  # Abundance
  geom_scatterpie(data = trawl_station_df, aes(x = xc_jit,  y = yc_jit),
                  cols = c("Arctic cod", 
                           "Snailfish",
                           "Lanternfish",
                           "Redfish",
                           "Other"),
                  alpha = 0.9, pie_scale = 1.5, legend_name = "Species", 
                  colour = "white", size = 0.2) +
  # geom_text(aes(x = xc_jit, y = yc_jit, label = row), size = 2,
  # col = "green") +
  scale_fill_manual(values = met.brewer("Johnson", n = 5, direction = -1)) +
  coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1850), expand = F) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 1) +
  guides(fill = guide_legend(nrow = 2, byrow = T)) +
  theme(legend.position = "top", 
        legend.title = element_blank(),
        legend.key.height = unit(0.1, "in"), 
        legend.key.width = unit(0.1, "in"), 
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        plot.margin = unit(c(0.01, 0, 0.29, 0), "in"))

# Combine plots
table1_RA <- plot_grid(heatmap_RA, map_RA, ncol = 2, rel_widths = c(1, 0.7),
                       labels = "auto", label_size = 9)
# Save and display plot
ggsave("plots/Table1_RA_map.png", table1_RA, 
       height = 3.25, width = 6.5, dpi = 600, units = "in")
table1_RA
```

## Figure 4. Linear regression latitude and map

```{r map-lm}
# Map
map_DSL <- SA_grid_laea %>%
  mutate(NASC_int_d = cut(NASC_int, c(0, 1, 10, 100, 500, 1000, Inf))) %>%
  ggplot(aes(x = xc,  y = yc)) +
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d), 
              alpha = 0.8) + # bathy
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  guides(fill = "none") + 
  new_scale_fill() + 
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group), 
               col = "black", fill = NA, lwd = 0.3, alpha = 1) + # LME
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey25") + # Coast
  geom_tile(aes(fill = NASC_int_d), size = 0.2, col = "white") +
  scale_fill_viridis_d(expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
                       option = "viridis",
                       labels = c("< 1", "1-10", "11-100", "101-500",
                                  "501-1000", "> 1000")) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 0.5) +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1850), expand = F) +
  theme(legend.position = "right",
        legend.key.height = unit(0.15, "in"),
        legend.key.width = unit(0.15, "in"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
# LM
col_pal <- c("#132B69", "#03739B", "#93AA43", "black")
lm_SA_lat <- LM_area_res %>%
  ggplot() + 
  geom_point(data = SA_lm, aes(x = lat, y = SA_int, col = LME, shape = shape),
             alpha = 0.7, size = 1) +
  geom_line(aes(x = lat, y = .fitted, col = LME), size = 0.6) + 
  geom_ribbon(aes(x = lat, ymin = .lower, ymax = .upper,
                  group = LME, fill = LME),
              alpha = 0.15) +
  scale_x_continuous("Latitude (°N)", breaks = seq(0, 90, 2)) + 
  # scale_y_continuous(expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) + 
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    position = "left",
    sec.axis = 
      sec_axis(trans = ~10^(./10), 
               name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
               breaks = c(1, 10, 100, 1000, 10000))) +
  scale_shape_manual(values = c(17, 16)) +
  scale_colour_manual("LME", values = col_pal) +
  scale_fill_manual("LME", values = col_pal) +
  coord_cartesian(ylim = c(-4.5, 44.5)) +
  guides(fill = "none", shape = "none") +
  theme(legend.position = "top", 
        legend.title = element_blank(),
        legend.key.height = unit(0.15, "in"), 
        legend.key.width = unit(0.15, "in"), 
        panel.border = element_blank(),
        axis.line = element_line())
# Combine plots
p_map_NASC_LM <- plot_grid(map_DSL, lm_SA_lat, rel_heights = c(1, 1),
                           ncol = 1, align = "v", axis = "lr",
                           labels = "auto", label_size = 9, 
                           label_y = c(0.9, 0.975)) 
# Save and display plot
ggsave("plots/Fig3_map_LM_NASC.png", p_map_NASC_LM, 
       height = 5, width = 6.5, dpi = 600, units = "in")
p_map_NASC_LM
```

## Figure 5. HGAM

```{r HGAM-plot}
# GAM velocity
GAMSAI_velo <- predSA_I %>%
  filter(var == "v") %>%
  ggplot() +
  # geom_point(data = SA_df, aes(x = v, y = SA_int, col = LME), alpha = 0.5) +
  # geom_line(aes(x = v, y = fitted, col = LME, linetype = LME), 
  geom_line(aes(x = v, y = fitted, col = LME), 
            size = 0.6) +
  geom_ribbon(aes(x = v, ymin = lwr_ci, ymax = upr_ci, fill = LME), 
              alpha = 0.1) +
  scale_colour_manual(name = "LME",
                      values = met.brewer("Johnson", n = 6, direction = -1)) +
  scale_fill_manual(name = "LME",
                    values = met.brewer("Johnson", n = 6, direction = -1)) +
  coord_cartesian(xlim = c(-0.05, 4.55), ylim = c(-2, 32), expand = F) +
  scale_x_continuous(breaks = seq(0, 10, 0.5)) +
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    position = "left",
    sec.axis = sec_axis(trans = ~10^(./10), 
                        name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
                        breaks = c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000))) +
  scale_linetype_manual(name = "LME", values = c(2, 2, 1)) +
  labs(x = expression("Mean velocity at 318 m (cm s"^-1*")"),
       y = expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) +
  # facet_wrap(~ LME) +
  # guides(linetype = "none") +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(),
        legend.position = "top",
        plot.margin = unit(c(0, 0, 0, 0), "in"))
# Save and display plot
ggsave("plots/Figure_HGAM_SAI3.png", GAMSAI_velo, 
       height = 3, width = 6.5, dpi = 600, units = "in")
GAMSAI_velo
```

# Supplementary data

## Map myctophid distribution

```{r map-myctohpid}
col_pal <- c("#999999", "#E69F00", "#56B4E9", "#009E73",
          "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

mycto_trawl <- trawl_station %>% 
  filter(fish_species == "myctophidae") %>%
  mutate(var = if_else(area == "BB", "This study", "Geoffroy et al. 2019")) %>%
  dplyr::select(lon, lat, var)

map_mycto <- data.frame(
  lon = c(133 + (32.27/60), # AWI 1995
          133 + (34.9/60), # AWI 1995
          -179.99, # Zhang 2022
          25.5, # Snoeijs Leijonmalm et al. 2022
          -122.357, # Frosti 2021
          -117.90, # Frosti 2021
          -117.088, # Frosti 2021
          -135, # Majewski 2017 approximate location
          15.2937, # Gjosaeter 2017
          14.9276, # Gjosaeter 2017
          5.1679, # Gjosaeter 2017
          15.2468, # Gjosaeter 2017
          15.0405, # Gjosaeter 2017
          5.8664, # Gjosaeter 2017
          7.5160), # Gjosaeter 2017
  lat = c(78 + (06.02/60), # AWI 1995
          77 + (54.83/60), # AWI 1995
          75.04, # Zhang 2022
          88.0, # Snoeijs Leijonmalm et al. 20221
          70.896, # Frosti 2021
          70.342, # Frosti 2021
          70.332, # Frosti 2021
          70.5, # Majewski 2017 approximate location)
          81.5606, # Gjosaeter 2017
          81.3716, # Gjosaeter 2017
          79.6945, # Gjosaeter 2017
          81.3636, # Gjosaeter 2017
          80.9763, # Gjosaeter 2017
          79.6613, # Gjosaeter 2017
          79.6689), # Gjosaeter 2017
  var = c(rep("Chernova & Neyelov 1995", 2), 
          "Zhang et al. 2022", 
          "Snoeijs Leijonmalm et al. 2022", 
          rep("Frosti 2021", 3),
          "Majewski et al. 2017\n(approximate location)",
          rep("Gjøsaeter et al. 2017", 7))) %>% 
  bind_rows(., mycto_trawl) %>%
  # Reorder studies
  mutate(var = 
           factor(var,
                  levels = c("Chernova & Neyelov 1995",
                             "Gjøsaeter et al. 2017",
                             "Majewski et al. 2017\n(approximate location)",
                             "Geoffroy et al. 2019",
                             "Frosti 2021",
                             "Snoeijs Leijonmalm et al. 2022",
                             "Zhang et al. 2022",
                             "This study"))) %>%
  st_as_sf(coords = c("lon", "lat"), crs = crs(arctic_latlon), remove = F) %>%
  st_transform(crs = st_crs(arctic_laea)) %>% # Change projection
  mutate(xc = st_coordinates(.)[,1],
         yc = st_coordinates(.)[,2]) %>%
  st_drop_geometry() %>%
  ggplot(aes(x = xc, y = yc)) +
  # Plot bathy
  geom_raster(data = bathy_laea, aes(fill = depth_d), alpha = 0.8) +
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  guides(fill = "none") +
  new_scale_fill() +
  # Plot LME
  # geom_polygon(data = LME, aes(x = xc, y = yc, group = group),
  #              col = "black", fill = NA, alpha = 0.2,
  #              lwd = 0.35, lty = 1) +
  # Plot coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group),
               fill = "grey30") +
  # Plot locations of myctophids
  geom_point(aes(x = xc, y = yc, fill = var), shape = 21,
             size = 2.5, alpha = 0.8) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 1) +
  coord_fixed(xlim = c(-2450, 1200), ylim = c(-1500, 2000), expand = F) +
  scale_fill_manual(values = col_pal) +
  # guides(fill = "none") +
  theme(legend.position = "right", 
        legend.title = element_blank(),
        panel.border = element_rect(fill = NA),
        axis.text = element_blank(),
        axis.ticks = element_blank(), 
        axis.title = element_blank())
# Save and display plots
ggsave("plots/map_myctophid.png", map_mycto,
       height = 4, width = 6, dpi = 600, units = "in")
map_mycto
```

## Figure SX boxplot WMD

```{r WMD-boxplot}
boxplot_WMD <- bind_rows(SA_grid_laea) %>%
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "Northern\nBarents Sea",
                                LME == "All areas" ~ "All areas",),
                      levels = c("Beaufort Sea", "Nares Strait", 
                                 "Baffin Bay", "Northern\nBarents Sea",
                                 "All areas")),
    year = factor(year, levels = c(2015, 2016, 2017, 9999))) %>%
  ggplot(aes(x = LME)) +
  geom_boxplot(aes(y = CM, col = LME),
               size = 0.4, outlier.size = 0.7,
               alpha = 0.8, position = position_dodge(preserve = "single")) +
  scale_x_discrete(labels = c("BF", "NAR", "BB", "BA")) +
  scale_y_reverse() +
  scale_colour_manual(values =  c("#132B69", "grey50", "#03739B", "#93AA43"),
                      labels = c("2015", "2016", "2017", "All years")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.key.width = unit(0.15, "in"),
        legend.key.height = unit(0.15, "in"),
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Save and display plot
ggsave("plots/boxplot_WMD.png", boxplot_WMD,
       height = 2.5, width = 3.5, dpi = 600, units = "in")
boxplot_WMD
```

## Map WMD

```{r WMD-map}
col_pal <- c("(250,300]" = "#F0F921FF",
             "(300,350]" = "#FDB32FFF",
             "(350,400]" = "#ED7953FF",
             "(400,450]" = "#CC4678FF",
             "(450,500]" = "#9C179EFF",
             "(500,550]" = "#5D01A6FF",
             "(550,600]" = "#0D0887FF")

map_WMD <- SA_grid_laea %>%
  mutate(CM_d = cut(CM, seq(250,600,50)),
         CM_d = if_else(CM > 550, "(550,600]", as.character(CM_d))) %>%
  ggplot(aes(x = xc,  y = yc)) +
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d), 
              alpha = 0.8) + # bathy
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  guides(fill = "none") + 
  new_scale_fill() + 
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group), 
               col = "black", fill = NA, lwd = 0.3, alpha = 1) + # LME
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey25") + # Coast
  geom_tile(aes(fill = CM_d), size = 0.2, col = "white") +
  # scale_fill_viridis_d("CM (m)", option = "plasma", direction = -1,
  #                      labels = c("250-300", "301-350", "351-400", 
  #                                 "401-450", "451-500", "501-550", 
  #                                 "551-600")) +
  scale_fill_manual("WMD (m)", 
                    limits = c("(250,300]", "(300,350]", 
                               "(350,400]", "(400,450]", 
                               "(450,500]", "(500,550]", 
                               "(550,600]"),
                    values = col_pal,
                    labels = c("< 301", "301-350", "351-400", 
                                  "401-450", "451-500", "501-550", 
                                  "> 550")) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 0.5) +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1850), expand = F) +
  theme(legend.title = element_text(hjust = 0.5),
        legend.key.width = unit(0.1, "in"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
# Save and display plot
ggsave("plots/map_WMD.png", map_WMD,
       height = 2.5, width = 6.5, dpi = 600, units = "in")
```

## Figure SX Map current velocity

```{r map-velo}
# Map current velocity
map_velo <- phy_grid_laea_hd %>%
  filter(depth == 318) %>%
  ggplot() +
  # Bathymetry
  # geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d),
  #             alpha = 0.8) +
  # scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  # guides(fill = "none") +
  # new_scale_fill() +
  # Velocity
  geom_tile(aes(x = xc, y = yc, fill = v_mean * 100)) + 
  scale_fill_cmocean(expression("Velocity\n(cm s"^-1*")"),
                       name = "speed", limits = c(0, 4.5), 
                       na.value = "#172313FF") +
  # LME
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group), 
               col = "black", fill = NA, lwd = 0.3) + 
  # Coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey25") + 
  coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1850), expand = F) +
  # Plot North Pole
  geom_point(aes(x = 0, y = 0), shape = 4, stroke = 0.5) +
  # Coords 
  geom_tile(data = SA_df, aes(x = xc, y = yc), fill = NA,
            colour = "red", size = 0.3) + 
  # Facets
  facet_wrap(~ year) +

  theme(legend.title = element_text(hjust = 0.5),
        legend.key.width = unit(0.1, "in"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

# Save and display plot
ggsave("plots/Figure_map_velo.png", map_velo, 
       height = 2.5, width = 6.5, dpi = 600, units = "in")
# map_velo
```

## Figure SX. LM BB & size distribution

```{r LM_histograms}
# Histogram
trawl_BB_meta <- trawl %>%
  group_by(date, year, station, deployment, LME, bottom_depth_trawl, 
           max_sampling_depth, tow_type) %>%
  summarise() %>%
  ungroup() %>%
  filter(LME == "BB") %>%
  dplyr::select(date) 
BB_length <- trawl_Amundsen_length_weight %>%
  filter(date %in% trawl_BB_meta$date & fish_species == "boreogadus_saida") %>%
  mutate(lat_d = cut(lat, seq(0, 90, 2)),
         SL_cm = SL_mm_lab / 10) %>%
  ggplot() +
  geom_histogram(aes(x = SL_cm, fill = lat_d),
                 col = "white", bins = 50, na.rm = T) + # 0.5 cm bins 
  scale_fill_viridis_d("Latitude (°N)", option = "mako", 
                       begin = 0.1, end = 0.8, direction = -1) +
  scale_x_continuous("Standard length (cm)", limits = c(5, 15),
                     breaks = seq(0, 20, 1)) +
  scale_y_continuous("Count", breaks = seq(0, 20, 2), expand = c(0, 0),
                     limits = c(0, 13)) +
  theme(panel.border = element_blank(),
        legend.key.width = unit(0.15, "in"),
        legend.key.height = unit(0.15, "in"),
        axis.line = element_line())

# Linear regression
SA_BB_mycto <- SA_BB %>%
  filter(mycto_TF == F) %>%
  mutate(mycto_excluded = T)

LM_BB <- SA_BB %>%
  mutate(mycto_excluded = F) %>%
  bind_rows(., SA_BB_mycto) %>%
  ggplot(aes(x = lat, y = SA_int, col = mycto_excluded)) +
  geom_point() +
  geom_smooth(method = "lm", se = F) +
  scale_x_continuous("Latitude (°N)", breaks = seq(0, 90, 2)) + 
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    position = "left",
    breaks = seq(5, 25, 5),
    sec.axis = 
      sec_axis(trans = ~10^(./10), 
               name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
               breaks = round(10^(c(5, 10, 15, 20, 25)/10), 1))) +
  scale_colour_viridis_d("Myctophid removed", 
                         option = "mako", begin = 0.3, end = 0.7) +
  # scale_fill_manual("LME", values = col_pal) +
  # coord_cartesian(ylim = c(-4.5, 44.5)) +
  guides(fill = "none", shape = "none") +
  theme(legend.position = "top", 
        panel.border = element_blank(),
        axis.line = element_line())

# Combine plots
BB_LM_hist <- plot_grid(LM_BB, BB_length, ncol = 1, align = "hv", axis = "tblr",
                        labels = "auto", label_size = 9)
# Save and display plot
ggsave("plots/Baffin_Bay_LM_length.png", BB_LM_hist, 
       height = 5, width = 6.5, dpi = 600, units = "in")
BB_LM_hist
```

## Table S1. Acoustic settings

```{r tableS1-acoustic-settings, echo=F, warning=F, message=F, fig.align='center'}
summary_MVBS <- MVBS %>%
  group_by(date,process_ID, filename, area, year) %>%
  summarise() %>% # Remove depth component
  ungroup() %>%
  group_by(area,year) %>% # Summarise total amount of files and total number of hours of data
  summarise(n_files=n(),
            duration_min=n_files*10,
            duration_h=round(duration_min/60))

# Create data frame and table
data.frame(year=c(rep(2015,3), rep(2016,3), rep(2017,3)),
           Area=rep(c("Beaufort Sea","Baffin Bay","Svalbard"), 3),
           area=rep(c("BF_CAA","BB","SV"),3),
           Vessel=c("CCGV Amundsen","CCGV Amundsen","RV Polarstern", # 2015
                    "CCGV Amundsen","CCGV Amundsen","RV Helmer Hanssen", # 2016
                    "FV Frosti","CCGV Amundsen","RV Polarstern"), # 2017
           Echosounder=c(rep("EK60",6), rep("EK80",1), rep("EK60",2)),
           Transducer_depth=c(rep(7,2),11,rep(7,2),8,6,7,11),
           Pulse_length=rep(1.024,9),
           Power=c(rep(2000,2),1000,rep(2000,5),1000)) %>%
  left_join(.,summary_MVBS, by=c("area", "year")) %>%
  dplyr::select(year, Area, Vessel, Echosounder, Transducer_depth, Pulse_length,
                Power, duration_h) %>%
  rename("Year"=year,
         "Transducers depth (m)"=Transducer_depth,
         "Pulse length (msec)"=Pulse_length,
         "Power (W)"=Power,
         "Acoustic data duration (h)"=duration_h) %>%
  mutate(Year="" ) %>% # remove year values for a more readable table
  kbl(align=c("l", "l", "l", "c", "c","c","c","c")) %>%
  kable_classic(full_width=F, html_font="Arial") %>%
  pack_rows("2015", 1, 3) %>%
  pack_rows("2016", 4, 6) %>%
  pack_rows("2017", 7, 9)
```

## Table S2. Trawl summary

```{r tableS1-acoustic-settings, echo=F, warning=F, message=F, fig.align='center'}
trawl_summary <- trawl %>%
  group_by(date, year, station, deployment, LME, bottom_depth_trawl, 
           max_sampling_depth, tow_type) %>%
  summarise() 
```




# OLD PLOTS
## LM map DSL

```{r LM-SA-latitude}
col_pal <- c("#132B69", "#03739B", "#93AA43", "black")
lm_SA_lat <- LM_area_res %>%
  ggplot() + 
  geom_point(data = SA_lm, aes(x = lat, y = SA_int, col = LME, shape = shape,
                               size = shape),
             alpha = 0.7) +
  geom_line(aes(x = lat, y = .fitted, col = LME), size = 0.6) + 
  geom_ribbon(aes(x = lat, ymin = .lower, ymax = .upper,
                  group = LME, fill = LME),
              alpha = 0.15) +
  scale_x_continuous("Latitude (°N)", breaks = seq(0, 90, 2)) + 
  # scale_y_continuous(expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) + 
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    position = "left",
    sec.axis = 
      sec_axis(trans = ~10^(./10), 
               name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
               breaks = c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000))) +
  scale_shape_manual(values = c(17, 16)) +
  scale_size_manual(values = c(1.5, 1)) +
  scale_colour_manual("LME", values = col_pal) +
  scale_fill_manual("LME", values = col_pal) +
  coord_cartesian(ylim = c(-3, 42)) +
  guides(fill = "none", shape = "none", size = "none") +
  theme(legend.position = "right", 
        legend.title = element_blank(),
        legend.key.height = unit(0.15, "in"), 
        legend.key.width = unit(0.15, "in"), 
        panel.border = element_blank(),
        axis.line = element_line())
# Save and display plot
ggsave("plots/Figure_LM_SA_lat.png", lm_SA_lat, 
       height = 2.5, width = 6.5, dpi = 600, units = "in")
lm_SA_lat
```

```{r}
SA_grid_50 %>%
  ggplot(aes(x = lat, y = SA_int, col = LME)) + 
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm")
```

## Map and Boxplot

```{r fig3-boxplot-NASC, fig.width=6, fig.height=5}
# Map NASC
map_DSL <- SA_grid_laea %>% 
  mutate(NASC_int_d = cut(NASC_int, c(0, 1, 10, 100, 1000, 10000, Inf))) %>%
  ggplot(aes(x = xc,  y = yc)) +
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d),
              alpha = 0.8) + # bathy
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  guides(fill = "none") + 
  new_scale_fill() + 
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group), 
               col = "black", fill = NA, lwd = 0.3, alpha = 1) + # LME
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey25") + # Coast
  # geom_point(aes(col = NASC_int_d), size = 0.6) +
  # scale_color_viridis_d(option = "plasma", 
  #                       labels = c("< 1", "1-10", "11-100", "101-1000", 
  #                                  "1001-10000", "> 10000")) +
  geom_tile(aes(fill = NASC_int_d), size = 0.2, alpha = 0.8, col = "white") +
  scale_fill_viridis_d(option = "viridis", 
                       labels = c("< 1", "1-10", "11-100", "101-1000", 
                                  "1001-10000", "> 10000")) +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1850), expand = F) +
  guides(fill = guide_legend(override.aes = list(size = 2), 
                               nrow = 1)) + 
  # guides(fill = "none",
  #        colour = guide_legend(override.aes = list(size = 2), 
  #                              nrow = 1)) + # Increase symbol size in legend
  theme(legend.position = "top",
        legend.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
# Bxplot SA
p_boxplot_SA <-
  SA_grid_laea %>% # Boxplot of SA per region
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "Barents Sea"),
                      levels = c("Beaufort Sea", "Nares Strait", 
                                 "Baffin Bay", "Barents Sea"))) %>%
  ggplot(aes(x = LME, y = SA_int)) + 
  geom_boxplot(position = position_dodge(preserve = "single")) +
  scale_y_continuous(expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")")) +
  theme(panel.border = element_blank(),
        axis.title.x = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(), 
        # legend.position = "none",
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Combine plots
p_map_SA_DSL <- plot_grid(map_DSL, p_boxplot_SA, 
                          ncol = 1, align = "v", axis = "lr",
                          labels = "auto", label_size = 9) 
# Save and display plots
ggsave("plots/Fig3_map_boxplot_SA.png", p_map_SA_DSL,
       height = 5, width = 6, dpi = 600, units = "in")
p_map_SA_DSL
```

## Map and Points

```{r fig3-map-points}
map_DSL <- SA_grid_laea %>% 
  mutate(NASC_int_d = cut(NASC_int, c(0, 1, 10, 100, 500, 1000, Inf))) %>%
  ggplot(aes(x = xc,  y = yc)) +
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d), 
              alpha = 0.8) + # bathy
  scale_fill_grey("Depth (m)", start = 0.9, end = 0.3) +
  guides(fill = "none") + 
  new_scale_fill() + 
  geom_polygon(data = LME, aes(x = xc, y = yc, group = group), 
               col = "black", fill = NA, lwd = 0.3, alpha = 1) + # LME
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), 
               fill = "grey25") + # Coast
  geom_tile(aes(fill = NASC_int_d), size = 0.2, col = "white") +
  scale_fill_viridis_d(expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
                       option = "viridis",
                       labels = c("< 1", "1-10", "11-100", "101-500",
                                  "501-1000", "> 1000")) +
  geom_point(aes(x = 0, y = 0), size = 0.05) +
  facet_wrap(~ year) +
  coord_fixed(xlim = c(-2450, 650), ylim = c(-1500, 1850), expand = F) +
  theme(legend.position = "right",
        legend.key.height = unit(0.15, "in"),
        legend.key.width = unit(0.15, "in"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())

pointrange_NASC <- SA_grid_laea %>% # Pointrange of SA per region
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "Barents Sea"),
                      levels = c("Beaufort Sea", "Nares Strait", 
                                 "Baffin Bay", "Barents Sea"))) %>%
  group_by(LME, year) %>% # Median per year
  summarise(NASC_median = median(NASC_int, na.rm = T),
            NASC_mean = mean(NASC_int, na.rm = T),
            NASC_q025 = quantile(NASC_int, 0.025),
            NASC_q975 = quantile(NASC_int, 0.975)) %>%
  ungroup() %>%
  group_by(LME) %>% # Mean per area
  summarise(NASC_median = mean(NASC_median, na.rm = T),
            NASC_mean = mean(NASC_mean, na.rm = T),
            NASC_q025 = min(NASC_q025, na.rm = T),
            NASC_q975 = max(NASC_q975, na.rm = T)) %>%
  ungroup() %>%
  ggplot(aes(x = LME)) +
  geom_point(aes(y = 10 * log10(NASC_mean)), 
             shape = 18, size = 4.5, col = "black") +
  geom_pointrange(aes(y = 10 * log10(NASC_median),
                      ymin = 10 * log10(NASC_q025), 
                      ymax = 10 * log10(NASC_q975)),
                  col = "black", fill = "white", shape = 21) +
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    sec.axis = 
      sec_axis(trans = ~10^(./10), 
               name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
               breaks = c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000, 50000))) +
  theme(axis.title.x = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Combine plots
p_map_pointrange_NASC <- plot_grid(pointrange_NASC, map_DSL,
                                   ncol = 1, align = "v", axis = "lr",
                                   labels = "auto", label_size = 9) 
# Save and display plot
ggsave("plots/Fig3_map_pointrange_NASC.png", p_map_pointrange_NASC, 
       height = 5, width = 6.5, dpi = 600, units = "in")
p_map_pointrange_NASC
```

## Just points

```{r fig3-points}
pointrange_NASC <- SA_grid_laea %>% # Pointrange of SA per region
  dplyr::select(year, LME, NASC_int) %>%
  mutate(LME = factor(case_when(LME == "BF" ~ "Beaufort Sea",
                                LME == "NAR" ~ "Nares Strait",
                                LME == "BB" ~ "Baffin Bay",
                                LME == "SV" ~ "Northern\nBarents Sea"),
                      levels = c("Beaufort Sea", "Nares Strait",
                                 "Baffin Bay", "Northern\nBarents Sea")),
         year = factor(year)) %>%
  group_by(LME, year) %>% # Median per year
  summarise(NASC_median = median(NASC_int, na.rm = T),
            NASC_mean = mean(NASC_int, na.rm = T),
            NASC_q025 = quantile(NASC_int, 0.025),
            NASC_q975 = quantile(NASC_int, 0.975)) %>%
  ungroup() %>%
  group_by(LME) %>% # Mean per area
  summarise(NASC_median = mean(NASC_median, na.rm = T),
            NASC_mean = mean(NASC_mean, na.rm = T),
            NASC_q025 = min(NASC_q025, na.rm = T),
            NASC_q975 = max(NASC_q975, na.rm = T)) %>%
  ungroup() %>%
  ggplot(aes(x = LME)) +
  geom_point(aes(y = 10 * log10(NASC_mean), col = LME),
             shape = 18, size = 4.5) +
  geom_pointrange(aes(y = 10 * log10(NASC_median),
                      ymin = 10 * log10(NASC_q025),
                      ymax = 10 * log10(NASC_q975), 
                      col = LME),
                  fill = "white", shape = 21) +
  scale_y_continuous(
    expression("S"[A]*" (dB re 1 m"^2*" nmi"^-2*")"),
    position = "left",
    sec.axis = 
      sec_axis(trans = ~10^(./10), 
               name = expression("s"[A]*" ( m"^2*" nmi"^-2*")"),
               breaks = c(1, 5, 10, 50, 100, 500, 1000, 5000, 10000))) +
  scale_colour_manual(values =  c("#132B69", "black", "#03739B", "#93AA43")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0, 0), "in"))
# Save and display plot
ggsave("plots/Fig3_pointrange_NASC.png", pointrange_NASC,
       height = 2.5, width = 4.5, dpi = 600, units = "in")
pointrange_NASC
```

## OLD Figure 1. Bathy map with sampling locations

Careful this map takes forever to compute (\> 18 h) when bathy has to be drawn.

```{r fig1-map-station-original, eval=FALSE, fig.align='center', fig.height=3.25, fig.width=6}
MVBS %>%
  mutate(lat = round(lat, 1),
         lon = round(lon, 1)) %>%
  group_by(lat,lon) %>%
  summarise(lat = mean(lat), 
            lon = mean(lon)) %>%
  ungroup() %>%
  ggplot(aes(x = lon, y = lat)) +
  # Plot bathy
  # geom_tile(data = bathy_df, aes(x = lon, y = lat, fill = depth_d)) +
  # scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.6) +
  # Plot coastlines
  geom_polygon(data = coast_10m_latlon, aes(x = lon, y = lat, group = group), fill = "grey70") +
  # Arctic circle
  geom_segment(aes(x = -180, xend = 0, y = 66.5, yend = 66.5), col = "grey40", lty = 2, size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 66.5, yend = 66.5), col = "grey40", lty = 2, size = 0.3) +
  # Areas of interest
  geom_shape(data = area_BF_CAA_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_BB_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_SV_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  # Acoustic data
  geom_point(size = 0.7, shape = 4, color = "black") +
  # Trawl locations
  geom_point(data = trawl_latlon, aes(x = lon, y = lat), shape = 23, size = 1.4, color = "black", fill = "orange") +
  # Change projection
  coord_map("azequalarea", ylim = c(66, 90), xlim = c(-160, 70), orientation = c(90,0,-60)) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", panel.border = element_rect(fill = NA), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank())
```

To overcome that, I project the bathy data on the EASE-Grid 2.0 North, prior to plotting. This results in a much quicker plotting time.

```{r fig1-map-station-laea, fig.align='center', fig.height=4, fig.width=6}
# Bathymetric map of the Arctic with location of acoustic and trawl
p_MVBS_laea <- MVBS_laea %>%
  ggplot(aes(x = xc, y = yc)) +
  # Plot bathy
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d)) +
  scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.6) +
  # Areas of interest
  geom_polygon(data = IHO_WAO, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_BF, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_CAA, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_BB, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_DS, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  geom_shape(data = IHO_EAO, aes(x = xc, y = yc, group = group), fill = NA, col = "black", lwd = 0.3, lty = 1) +
  # Plot coastlines
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey30") +
  # Arctic circle
  geom_path(data = arctic_circle_laea, aes(x = xc, y = yc), col = "grey10", lty = 2, size = 0.3) +
  # Acoustic data
  geom_point(size = 0.7, shape = 4, color = "black") +
  # Trawl locations
  geom_point(data = trawl_laea, aes(x = xc, y = yc), shape = 23, size = 1.4, color = "black", fill = "orange") +
  coord_fixed(xlim = c(-2700, 1500), ylim = c(-1900, 2000), expand = F) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", panel.border = element_rect(fill = NA), axis.text = element_blank(),
        axis.ticks = element_blank(), axis.title = element_blank())
# ggsave("plots/Fig1_map_stations.png", p_MVBS_laea, height = 4, width = 6.5, dpi = 600, units = "in")
p_MVBS_laea
```

## OLD Figure 2. Vertical S\~V\~ profiles

### Old plot

```{r fig2-Sv-profiles-area-year, fig.align='center', fig.width=6.5, fig.height=3}
col_pal <- c("#80CBB1", "#347BA5", "#302346") # Custom colour palette

Sv_prof_mean <- Sv_grid_laea %>% # Plot median profiles
  group_by(depth, IHO_area) %>% # Calculate mean and median Sv profiles per area per year
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                     IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                     IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                     IHO_area == "The Northwestern Passages" ~ "CAA",
                                     IHO_area == "Baffin Bay" ~ "BB",
                                     IHO_area == "Davis Strait" ~ "DS"),
                           levels = c("WAO_BF", "CAA", "BB", "DS", "EAO"))) %>%
  summarise(sv_lin_q0.05_areayear = median(sv_lin_q0.05),
            sv_lin_q0.50_areayear = median(sv_lin_q0.50),
            sv_lin_q0.95_areayear = median(sv_lin_q0.95)) %>%
  mutate(Sv_q0.05_median = 10 * log10(sv_lin_q0.05_areayear), 
         Sv_q0.50_median = 10 * log10(sv_lin_q0.50_areayear),
         Sv_q0.95_median = 10 * log10(sv_lin_q0.95_areayear))

p_Sv_grid_laea <- Sv_grid_laea %>% # Plot median profiles
  group_by(depth, IHO_area) %>% # Calculate mean and median Sv profiles per area per year
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "EAO",
                                     IHO_area == "West Arctic Ocean" ~ "WAO_BF",
                                     IHO_area == "Beaufort Sea" ~ "WAO_BF",
                                     IHO_area == "The Northwestern Passages" ~ "CAA",
                                     IHO_area == "Baffin Bay" ~ "BB",
                                     IHO_area == "Davis Strait" ~ "DS"),
                           levels = c("WAO_BF", "CAA", "BB", "DS", "EAO"))) %>%
  summarise(sv_lin_q0.05_areayear = median(sv_lin_q0.05),
            sv_lin_q0.25_areayear = median(sv_lin_q0.25),
            sv_lin_q0.50_areayear = median(sv_lin_q0.50),
            sv_lin_q0.75_areayear = median(sv_lin_q0.75),
            sv_lin_q0.95_areayear = median(sv_lin_q0.95)) %>%
  mutate(Sv_q0.05_median = 10 * log10(sv_lin_q0.05_areayear), 
         Sv_q0.25_median = 10 * log10(sv_lin_q0.25_areayear),
         Sv_q0.50_median = 10 * log10(sv_lin_q0.50_areayear),
         Sv_q0.25_median = 10 * log10(sv_lin_q0.25_areayear),
         Sv_q0.75_median = 10 * log10(sv_lin_q0.75_areayear),
         Sv_q0.95_median = 10 * log10(sv_lin_q0.95_areayear)) %>%
  ungroup() %>%
  # Plotting details for allowing geom_ribbon to work
  mutate(Sv_q0.05_median = case_when(Sv_q0.05_median == -999 ~ NaN,
                                     Sv_q0.05_median > -999 & Sv_q0.05_median <= -105 ~ -105,
                                     Sv_q0.05_median > -105 ~ Sv_q0.05_median),
         Sv_q0.25_median = case_when(Sv_q0.25_median == -999 ~ NaN,
                                     Sv_q0.25_median > -999 & Sv_q0.25_median <= -105 ~ -105,
                                     Sv_q0.25_median > -105 ~ Sv_q0.25_median),
         Sv_q0.50_median = case_when(Sv_q0.50_median == -999 ~ NaN,
                                     Sv_q0.50_median > -999 & Sv_q0.50_median <= -105 ~ -105,
                                     Sv_q0.50_median > -105 ~ Sv_q0.50_median),
         Sv_q0.75_median = case_when(Sv_q0.75_median == -999 ~ NaN,
                                     Sv_q0.75_median > -999 & Sv_q0.75_median <= -105 ~ -105,
                                     Sv_q0.75_median > -105 ~ Sv_q0.75_median),
         Sv_q0.95_median = case_when(Sv_q0.95_median == -999 ~ NaN,
                                     Sv_q0.95_median > -999 & Sv_q0.95_median <= -105 ~ -105,
                                     Sv_q0.95_median > -105 ~ Sv_q0.95_median)) %>%
  arrange(IHO_area, depth) %>%
  # Plot
  ggplot() +
  geom_vline(xintercept = 200, lty = 2, col = "grey20") +
  # geom_ribbon(aes(x = depth, ymin = Sv_q0.05_median, ymax = Sv_q0.95_median, fill = as.factor(year), group = year),
  #             alpha = 0.2, na.rm = T) +
  geom_ribbon(aes(x = depth, ymin = Sv_q0.05_median, ymax = Sv_q0.95_median), alpha = 0.2, na.rm = T) +
  geom_line(aes(x = depth, y = Sv_q0.50_median), na.rm = T) +
  # geom_line(aes(x = depth, y = Sv_q0.50_median, col = as.factor(year), group = year), na.rm = T) +
  scale_x_reverse("Depth (m)", breaks = seq(0, 1000, 200)) +
  geom_hline(yintercept = -105, col = "white") +
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 10), expand = c(0, 0)) +
  scale_color_manual(values = col_pal) +
  scale_fill_manual(values = col_pal) +
  coord_flip(ylim = c(-105, -65)) +
  facet_grid(~ IHO_area) +
  theme(legend.title = element_blank(),
        legend.position = c(0.94, 0.275),
        legend.background = element_blank(),
        legend.key = element_blank(), 
        panel.border = element_blank(),
        axis.line = element_line())
# ggsave("plots/Fig2_Sv_profiles_area_year.png", p_Sv_grid_laea, height = 3, width = 6.5, dpi = 600, units = "in")
p_Sv_grid_laea
```

### Lines

```{r, fig.width=6.5, fig.height=3.5}
col_pal <- c("#03051AFF", "#3F1B44FF", "#841E5AFF",
             "#CB1B4FFF", "#F06043FF", "#F6AA82FF") #viridisLite::rocket(n = 7)

# Find cells with no DSL
empty_DSL <- SA_grid_laea %>% 
  group_by(xc, yc, year, empty_clean) %>%
  summarise()
# Calculate median Sv profiles per area
Sv_prof_median <- Sv_grid_laea %>%
  left_join(., empty_DSL, by = c("year", "xc", "yc")) %>% # Add DSL presence
  # filter(empty_clean == F) %>% # Filter for DSL
  mutate(depth_round = rounder(depth, -10)) %>% # round down to nearest 20
  group_by(depth_round, IHO_area) %>%
  summarise(sv_lin50 = median(sv_lin_median),
            sv_lin025 = quantile(sv_lin_median, 0.025),
            sv_lin975 = quantile(sv_lin_median, 0.975)) %>% 
  ungroup() %>%
  mutate(Sv_median = 10 * log10(sv_lin50),
         Sv_025 = 10 * log10(sv_lin025),
         Sv_975 = 10 * log10(sv_lin975),
         IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic\nOcean",
                                     IHO_area == "West Arctic Ocean" ~ "West Arctic\nOcean",
                                     IHO_area == "Beaufort Sea" ~ "Beaufort Sea",
                                     IHO_area == "The Northwestern Passages" ~ "Can. Arctic\nArchipelago",
                                     IHO_area == "Baffin Bay" ~ "Baffin Bay",
                                     IHO_area == "Davis Strait" ~ "Davis Strait"),
                           levels = c("West Arctic\nOcean", "Beaufort Sea", "Can. Arctic\nArchipelago",
                                      "Baffin Bay", "Davis Strait", "East Arctic\nOcean")))
# Calculate center of mass
CM_prof <- Sv_prof_median %>%
  filter(depth_round >= 200) %>%
  group_by(IHO_area) %>%
  summarise(CM = sum(depth_round * sv_lin50) / sum(sv_lin50)) %>% # center of mass in meters 
  ungroup() %>%
  mutate(CM_round = as.character(round(CM, 0))) 

# Plot
p_Sv_prof_lines <- Sv_prof_median %>%
  ggplot() +
  geom_ribbon(aes(x = depth_round, ymin = Sv_025, ymax = Sv_975, fill = IHO_area), alpha = 0.3) + # 95 % of the Sv median
  geom_line(aes(x = depth_round, y = Sv_median, col = IHO_area), size = 0.8) + # Median Sv profile
  geom_vline(xintercept = 200, lty = 3) + # Mesopelagic zone
  geom_vline(data = CM_prof, aes(xintercept = CM), lty = 2) + # Center of mass
  geom_text(data = CM_prof, aes(x = CM -10, y = -70, label = as.character(CM_round)),
            vjust = 0, size = 3, fontface = "italic") + # Label center of mass
  # geom_rect(aes(xmin = 0, xmax = 200, ymin = -Inf, ymax = Inf), col = NA, fill = "grey87", alpha = 0.05) + # Mesopelagic zone
  scale_x_reverse("Depth (m)", breaks = seq(0, 1000, 200)) + 
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 10)) +
  scale_colour_manual(values = col_pal) +
  scale_fill_manual(values = col_pal) +
  # scale_colour_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  # scale_fill_manual(values = met.brewer("Johnson", n = 6, direction = -1)) +
  coord_flip(ylim = c(-105, -65), xlim = c(1000, 0), expand = F) +
  facet_grid(~ IHO_area) +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        legend.title = element_blank(), 
        legend.position = "none")
ggsave("plots/Fig2_Sv_profiles_lines.png", p_Sv_prof_lines, device = agg_png, height = 3.5, width = 6.5, dpi = 600, units = "in")
p_Sv_prof_lines
```

### Points

```{r Fig2-plot, fig.width=7, fig.height=4.5}
p_Sv_prof_points <- Sv_grid_laea %>%
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic Ocean",
                                     IHO_area == "West Arctic Ocean" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "Beaufort Sea" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "The Northwestern Passages" ~ "Canadian Arctic\nArchipelago",
                                     IHO_area == "Baffin Bay" ~ "Baffin Bay",
                                     IHO_area == "Davis Strait" ~ "Davis Strait"),
                           levels = c("West Arctic Ocean\n& Beaufort Sea", "Canadian Arctic\nArchipelago",
                                      "Baffin Bay", "Davis Strait", "East Arctic Ocean"))) %>%
  mutate(depth_round = rounder(depth, -20)) %>% # round down to nearest 20
  group_by(depth_round, IHO_area, year, xc, yc) %>%
  summarise(sv_lin = median(sv_lin_q0.50)) %>%
  ungroup() %>%
  mutate(Sv_median = 10 * log10(sv_lin)) %>%
  filter(Sv_median != -999) %>%
  ggplot() +
  geom_vline(xintercept = 200, col = "red", lty = 2) +
  geom_pointrange(mapping = aes(y = Sv_median, x = depth_round, col = depth_round < 200),
                  stat = "summary", fun = median, fun.min = function(z) {quantile(z, 0.05)}, 
                  fun.max = function(z) {quantile(z, 0.95)}, size = 0.2) + 
  scale_x_reverse("Depth (m)", breaks = seq(0, 1000, 100)) + 
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 20)) +
  scale_colour_manual(values = c("black", "grey60")) + 
  coord_flip(ylim = c(-110, -60), xlim = c(800, 20)) +
  facet_rep_grid(~ IHO_area) +
  guides(colour = "none") +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, "in"),
        plot.margin = unit(c(0, 0.1, 0, 0), "in"))
ggsave("plots/Fig2_Sv_profiles_points.png", p_Sv_prof_points, height = 4.5, width = 7, dpi = 600, units = "in")
p_Sv_prof_points
```

### Boxplots

```{r , fig.width=7, fig.height=4.5}
p_Sv_prof_boxplot <- Sv_grid_laea %>%
  filter(depth <= 800) %>%
  mutate(IHO_area = factor(case_when(IHO_area == "East Arctic Ocean" ~ "East Arctic Ocean",
                                     IHO_area == "West Arctic Ocean" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "Beaufort Sea" ~ "West Arctic Ocean\n& Beaufort Sea",
                                     IHO_area == "The Northwestern Passages" ~ "Canadian Arctic\nArchipelago",
                                     IHO_area == "Baffin Bay" ~ "Baffin Bay",
                                     IHO_area == "Davis Strait" ~ "Davis Strait"),
                           levels = c("West Arctic Ocean\n& Beaufort Sea", "Canadian Arctic\nArchipelago",
                                      "Baffin Bay", "Davis Strait", "East Arctic Ocean"))) %>%
  mutate(depth_round = rounder(depth, -25)) %>% # round down to nearest 20
  group_by(depth_round, IHO_area, year, xc, yc) %>%
  summarise(sv_lin = median(sv_lin_q0.50)) %>%
  ungroup() %>%
  mutate(Sv_median = 10 * log10(sv_lin), 
         depth = factor(depth_round)) %>%
  filter(Sv_median != -999) %>%
  ggplot() +
  geom_vline(xintercept = 200, col = "red", lty = 2) +
  geom_boxplot(aes(x = depth, y = Sv_median, col = depth_round < 200), 
               outlier.size = 0.5, size = 0.5) + 
  scale_x_discrete("Depth (m)", breaks = seq(0, 1000, 100), limits = rev) +
  scale_y_continuous(expression("S"[V]*" (dB re 1 m"^-1*")"), breaks = seq(-200, 0, 20)) +
  scale_colour_manual(values = c("black", "grey60")) +
  coord_flip(ylim = c(-110, -60)) +
  facet_rep_wrap(~ IHO_area, nrow = 1) +
  guides(colour = "none") +
  theme(panel.border = element_blank(),
        axis.line = element_line(),
        panel.spacing = unit(0, "in"),
        plot.margin = unit(c(0, 0.1, 0, 0), "in"))
ggsave("plots/Fig2_Sv_profiles_boxplots.png", p_Sv_prof_boxplot, height = 4.5, width = 6.5, dpi = 600, units = "in")
p_Sv_prof_boxplot
```



## OLD Figure 3. Map of mesopelagic backscatter hotspots

```{r fig3-map-sa-anomalies, fig.align='center', fig.height=3.25, fig.width=6}
col_pal <- c("#80cdc1",  "#f5f5f5", "#dfc27d", "#a6611a")
# Calculate mean sa anomaly over three years of data per area
map_sa_anomaly <- SA_anomaly_2deg %>%
  group_by(lat, lon, area, region) %>%
  summarise(year_sampled = n(),
            mean_ano_sa_int = mean(anomaly_NASC_int, na.rm = T)) %>%
  ungroup() %>%
  mutate(mean_ano_sa_int_d = factor(case_when(mean_ano_sa_int < -1 ~ "<-1",
                                              mean_ano_sa_int >= -1 & mean_ano_sa_int < -0.5 ~ "[-1; -0.5[",
                                              mean_ano_sa_int >= -0.5 & mean_ano_sa_int <= 0.5 ~ "[-0.5; 0.5]",
                                              mean_ano_sa_int > 0.5 & mean_ano_sa_int <= 1 ~ "]0.5; 1]",
                                              mean_ano_sa_int > 1 ~ ">1"),
                                    levels = c("<-1", "[-1; -0.5[", "[-0.5; 0.5]", "]0.5; 1]", ">1"))) %>%
  ggplot(aes(x = lon, y = lat)) +
  # Longitude lines
  geom_segment(aes(x = -180, xend = -180, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -150, xend = -150, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -120, xend = -120, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -90, xend = -90, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -60, xend = -60, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -30, xend = -30, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 0, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 180, xend = 180, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 150, xend = 150, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 120, xend = 120, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 90, xend = 90, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 60, xend = 60, y = 60, yend = 90), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 30, xend = 30, y = 60, yend = 90), col = "grey90", size = 0.3) +
  # Latitude lines
  geom_segment(aes(x = -180, xend = 0, y = 60, yend = 60), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 60, yend = 60), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -180, xend = 0, y = 70, yend = 70), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 70, yend = 70), col = "grey90", size = 0.3) +
  geom_segment(aes(x = -180, xend = 0, y = 80, yend = 80), col = "grey90", size = 0.3) +
  geom_segment(aes(x = 0, xend = 180, y = 80, yend = 80), col = "grey90", size = 0.3) +
  # Plot 500m isobath
  geom_contour(data = bathy_df, aes(x = lon, y = lat, z = depth), breaks = -500, size = 0.25, colour = "black", lty = 3) +
  # Plot coastlines
  geom_polygon(data = coast_10m_latlon, aes(x = lon, y = lat, group = group), fill = "grey70") +
  # Areas of interest
  geom_shape(data = area_BF_CAA_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_BB_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  geom_shape(data = area_SV_latlon, aes(x = lon, y = lat), fill = NA, col = "black", lwd = 0.2, lty = 1) +
  # Arctic circle
  geom_segment(aes(x = -180, xend = 100, y = 66.5, yend = 66.5), col = "#666766", lty = 2, size = 0.3) +
  # Plot data
  geom_tile(aes(fill = mean_ano_sa_int_d), color = "grey30", alpha = 0.8, size = 0.15) +
  scale_fill_manual("2015-2017\nAverage\nbackscatter\nanomaly", values = col_pal) +
  coord_map("azequalarea", ylim = c(66, 90), xlim = c(-160, 30), orientation = c(90, 0, -60)) +
  # Theme
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", 
        legend.title = element_text(hjust = 0.5),
        panel.border = element_rect(fill = NA),
        strip.text.x = element_blank(), 
        strip.background = element_blank(), 
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())
map_sa_anomaly
```

```{r fig3-map-sa-anomalies-laea, fig.align='center', fig.height=4, fig.width=10}
SA_grid_laea %>% 
  ggplot() +
  # Plot bathy
  geom_raster(data = bathy_laea, aes(x = xc, y = yc, fill = depth_d)) +
  scale_fill_cmocean("Depth (m)", name = "deep", discrete = T, na.value = NA, alpha = 0.3) +
  # scale_fill_brewer("Depth (m)", type = "seq", palette = "Greys") +
  guides(fill = "none") + # Remove legend
  new_scale_fill() +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey30") +
  # Plot backscatter anomalies
  geom_tile(aes(x = xc, y = yc, fill = NASC_anomaly_d), color = "grey30", size = 0.15) +
  scale_fill_manual("Normalized sA anomaly", values = rev(brewer.pal(n = 5, name = "BrBG"))) +
  # scale_fill_manual("Normalized sA anomaly", values = rev(brewer.pal(n = 5, name = "RdBu"))) +
  facet_wrap(~ year, ncol = 3) +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) +
  guides(fill = guide_legend(keywidth = 0.2, keyheight = 0.2, default.unit = "in"), color = "none") +
  theme(legend.position = "right", axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

