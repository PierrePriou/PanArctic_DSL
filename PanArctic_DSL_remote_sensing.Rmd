---
title: "PanArctic DSL - Remote sensing"
author: "[Pierre Priou](mailto:pierre.priou@mi.mun.ca)"
date: "`r format(Sys.time(), '%Y/%m/%d at %H:%M')`"
output: github_document
always_allow_html: true
---

# Package loading

```{r package-loading, message=FALSE}
# Load packages
library(tidyverse)  # Tidy code
library(lubridate)  # Deal with dates
library(tidync)     # Read NetCDF
library(ncmeta)     # Metadata NetCDF
library(sf)         # Spatial data
library(raster)     # Rasterize data
library(rgdal)      # Read shapefiles
library(ecmwfr)     # Download Copernicus data
library(cowplot)    # Plots on a grid
library(cmocean)    # Oceanographic colour palettes
library(metR)
# Custom figure theme
theme_set(theme_bw())
theme_update(axis.text = element_text(size = 9),
             axis.title = element_text(size = 9),
             strip.text.x = element_text(size = 9, face = "plain", hjust = 0.5),
             strip.background = element_rect(colour = "transparent", fill = "transparent"),
             legend.title = element_text(size = 9, vjust = 1),
             legend.margin = margin(0, 0, 0, 0),
             legend.box.margin = margin(0, 0, -8, 0),
             panel.grid = element_blank(), 
             plot.margin = unit(c(0.02, 0.02, 0.02, 0.02), "in"),
             plot.title = element_text(size = 9, face = "bold"))
options(dplyr.summarise.inform = F) # Suppress summarise() warning
```

# Sea ice data

Code that downloads sea ice data from the [Copernicus Climate website]( https://cds.climate.copernicus.eu/cdsapp#!/dataset/satellite-sea-ice-concentration?tab=overview). We use the daily sea ice concentration derived from satellite observations from ECMWF. Data is downloaded in two batches because ECMWF changed their Climate Data Record (CDR) on 2016-01-01. I changed the sea ice data projection from Lambert's azimuthal Equal Area (EPSG:6931) to WGS84 (EPSG:4326) and match the resolution to that of backscatter anomalies (2 deg longitude * 1 deg latitude).

## CDR data 2015-01-01 - 2015-12-31

Download "raw" data that I only crop to match the area of interest to reduce the file size. 

```{r download-seaice-CDR, eval=FALSE, message=FALSE}
# Date range of interest
dates <- seq(ymd("2015-01-01"), ymd("2015-12-31"), 1)
# Download data
for (d in dates) {
  # Format years, month, and day to be correctly read in the request
  year = as.character(year(as.Date(d, origin = "1970-01-01")))
  month = if_else(as.numeric(month(as.Date(d, origin =" 1970-01-01"))) < 10,
                  paste0("0", as.character(month(as.Date(d, origin = "1970-01-01")))),
                  as.character(month(as.Date(d, origin = "1970-01-01"))))
  day = if_else(as.numeric(day(as.Date(d, origin = "1970-01-01"))) < 10,
                paste0("0", as.character(day(as.Date(d, origin = "1970-01-01")))),
                as.character(day(as.Date(d, origin = "1970-01-01"))))
  request <- list(version = "v2", # Create request
                  variable = "all",
                  format = "zip",
                  origin = "eumetsat_osi_saf",
                  region = "northern_hemisphere",
                  cdr_type = "cdr",
                  year = year,
                  month = month,
                  day = day,
                  dataset_short_name = "satellite-sea-ice-concentration",
                  target = "download.zip")
  print(paste0("Downloading ", request$dataset_short_name, " from ", year, "-", month, "-", day))
  tmp_raw <- wf_request(user = "113650", # Download requested file
                        request = request, 
                        transfer = T, 
                        verbose = F,
                        path = "data/remote_sensing/sea_ice/tmp") %>%
    unzip(exdir = "data/remote_sensing/sea_ice/tmp") %>%  # Unzip file
    tidync() %>% 
    activate("D2,D3") %>%
    hyper_filter(xc = xc >= -2700 & xc <= 2700, yc = yc >= -2700 & yc <= 2700) # Crop data to fit area of interest
  tmp_coord <- tmp_raw %>% # Extract latlon and laea coordinates
    activate("D2,D3") %>%
    hyper_tibble()
  tmp_seaice <- tmp_raw %>%
    activate("D2,D3,D0") %>%
    hyper_tibble() %>%
    left_join(., tmp_coord, by = c("xc", "yc")) %>% # Join latlon coordinates to sea ice data
    mutate(date = ymd(format(as_datetime(time, origin = "1978-01-01", tz = "UTC"), format = "%Y%m%d"))) 
  write_csv(tmp_seaice, file = paste0("data/remote_sensing/sea_ice/", year, month, day, "_laea_ice_conc.csv")) # Save as a csv file
  file.remove(list.files("data/remote_sensing/sea_ice/tmp", full.names = T)) # Delete temporary netcdf and zip files
}
rm(request, tmp_raw, tmp_coord, tmp_seaice) # Remove unused variables
```

## ICDR data 2016-01-01 - 2017-12-31

```{r download-seaice-ICDR, eval=FALSE, message=FALSE}
# Date range of interest
dates <- seq(ymd("2016-01-10"), ymd("2017-12-31"), 1)
# Download data
for (d in dates) {
  # Format years, month, and day to be correctly read in the request
  year = as.character(year(as.Date(d, origin = "1970-01-01")))
  month = if_else(as.numeric(month(as.Date(d, origin =" 1970-01-01"))) < 10,
                  paste0("0", as.character(month(as.Date(d, origin = "1970-01-01")))),
                  as.character(month(as.Date(d, origin = "1970-01-01"))))
  day = if_else(as.numeric(day(as.Date(d, origin = "1970-01-01"))) < 10,
                paste0("0", as.character(day(as.Date(d, origin = "1970-01-01")))),
                as.character(day(as.Date(d, origin = "1970-01-01"))))
  request <- list(version = "v2", # Create request
                  variable = "all",
                  format = "zip",
                  origin = "eumetsat_osi_saf",
                  region = "northern_hemisphere",
                  cdr_type = "icdr",
                  year = year,
                  month = month,
                  day = day,
                  dataset_short_name = "satellite-sea-ice-concentration",
                  target = "download.zip")
  print(paste0("Downloading ", request$dataset_short_name, " from ", year, "-", month, "-", day))
  tmp_raw <- wf_request(user = "113650", # Download requested file
                        request = request, 
                        transfer = T, 
                        verbose = F,
                        path = "data/remote_sensing/sea_ice/tmp") %>%
    unzip(exdir = "data/remote_sensing/sea_ice/tmp") %>%  # Unzip file
    tidync() %>% 
    activate("D2,D3") %>%
    hyper_filter(xc = xc >= -2700 & xc <= 2700, yc = yc >= -2700 & yc <= 2700) # Crop data to fit area of interest
  tmp_coord <- tmp_raw %>% # Extract latlon and laea coordinates
    activate("D2,D3") %>%
    hyper_tibble()
  tmp_seaice <- tmp_raw %>%
    activate("D2,D3,D0") %>%
    hyper_tibble() %>%
    left_join(., tmp_coord, by = c("xc", "yc")) %>% # Join latlon coordinates to sea ice data
    mutate(date = ymd(format(as_datetime(time, origin = "1978-01-01", tz = "UTC"), format = "%Y%m%d"))) 
  write_csv(tmp_seaice, file = paste0("data/remote_sensing/sea_ice/", year, month, day, "_laea_ice_conc.csv")) # Save as a csv file
  file.remove(list.files("data/remote_sensing/sea_ice/tmp", full.names = T)) # Delete temporary netcdf and zip files
}
rm(request, tmp_raw, tmp_coord, tmp_seaice) # Remove unused variables
```

## Data tidying and gridding 

First, I plot data to see if download worked.

```{r plot-seaice-latlon-cdr, fig.height=4.5, fig.width=8, message=FALSE}
plot_grid(read_csv("data/remote_sensing/sea_ice/20151231_laea_ice_conc.csv") %>%
            ggplot(aes(x = xc, y = yc, fill = ice_conc)) + 
            geom_tile() + 
            scale_fill_cmocean("Ice concentration (%)", name = "ice") +
            ggtitle("2015-02-12 - CDR") + 
            coord_fixed(expand = F) +
            theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in")),
          read_csv("data/remote_sensing/sea_ice/20170212_laea_ice_conc.csv") %>%
            ggplot(aes(x = xc, y = yc, fill = ice_conc)) + 
            geom_tile() + 
            scale_fill_cmocean("Ice concentration (%)", name = "ice") +
            ggtitle("2017-02-12 - ICDR") + 
            coord_fixed(expand = F) +
            theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in")),
          ncol = 2, align = "hv", axis = "tblr")
```

I calculate sea ice and open-water duration, and mean sea ice concentration for each cell per year. We define a cell being ice-covered when the mean sea ice concentration is above 15 % [(as per NSIDC Sea Ice Index)](https://nsidc.org/cryosphere/glossary/term/ice-extent).

```{r seaice-tidying, message=FALSE, cache=TRUE}
seaice_year <- data.frame() # Empty dataframe that will be filled with gridded sea ice data

for (i in seq(2015, 2017, 1)) { # Loop through data per year
  seaice_tmp <- list.files("data/remote_sensing/sea_ice", # List files in folder
                            pattern = paste0(i),
                            full.names = T) %>%
    map_dfr(.f = ~ read_csv(.)) %>% # Read sea ice files
    mutate(date = ymd(date),
           year = year(date),
           ice_covered_day = if_else(ice_conc > 15, 1, 0)) %>% #  > 15% ice cover = ice covered day
    filter(status_flag != c(1, 2, 16)) %>% # Remove data from land (1), lakes (2), and possible false ice (16)
    group_by(year, xc, yc, lat, lon) %>% # Calculate metrics for each cell per year
    summarise(total_day_year = n(), # Total days per year (2016 was a leap year)
              seaice_duration = sum(ice_covered_day), # Duration of sea ice cover
              openwater_duration = total_day_year - seaice_duration, # Duration of open water
              mean_ice_conc = round(mean(ice_conc, na.rm = T), 2)) %>% # Mean ice concentration
    ungroup()
  seaice_year <- bind_rows(seaice_year, seaice_tmp)
}
rm(seaice_tmp, i) # Remove temporary data
save(seaice_year, file = "data/remote_sensing/remote_sensing_seaice_year.RData") # Save data
```

To match sea ice records with acoustic data, I rasterized sea ice data on the same grid as the acoustic data. I tried two different grids; the WGS84 projection (EPSG:4326) with grid cells of 2°lon * 1°lat, and the EASE-Grid 2.0 North (EPSG:6931) which is the default grid for sea-ice data. For each cell I calculated the mean ice concentration, open water and sea ice duration. 

### EPSG:6931 - EASE-Grid 2.0 North (Lambert's equal-area, azimuthal)

More info on this projection can be found on the [NSIDC website](https://nsidc.org/data/ease/). Because "raw" sea ice data has a 25 km * 25 km resolution, I match that resolution to the final projection (150 km * 150 km).

```{r EPSG-6931-seaice-grid}
cell_res <- 50 # Cell resolution in km
arctic_laea <- raster(extent(-2700, 2700, -2700, 2700), crs = "EPSG:6931") # Seaice projection
projection(arctic_laea) <- gsub("units=m", "units=km", projection(arctic_laea)) # Convert proj unit from m to km
res(arctic_laea) <- c(cell_res, cell_res) # Define the 100 km cell resolution

seaice_grid_laea <- data.frame() # Empty dataframe that will be filled with gridded CTD data

for (i in seq(2015, 2017, 1)) { # Data gridding
  seaice_tmp <- seaice_year %>%
    filter(year == i) 
  # Rasterize data in latlon
  seaice_tmp_laea <- SpatialPointsDataFrame(SpatialPoints(cbind(seaice_tmp$xc, seaice_tmp$yc), 
                                                          proj4string = CRS("EPSG:6931")),
                                            data.frame(lat = seaice_tmp$lat,
                                                       lon = seaice_tmp$lon,
                                                       seaice_duration = seaice_tmp$seaice_duration,
                                                       openwater_duration = seaice_tmp$openwater_duration,
                                                       mean_ice_conc = seaice_tmp$mean_ice_conc)) %>%
    rasterize(., arctic_laea, fun = mean, na.rm = T) %>% # Rasterize data in laea
    dropLayer(1) %>% # Remove ID layer
    rasterToPoints() %>% # Convert raster to data frame
    as.data.frame() %>%
    rename(xc = x, yc = y) %>% # Rename variables
    mutate(year = i, 
           area = factor(case_when(lon > -155 & lon <= -95 & lat > 65 & lat <= 82 ~ "BF_CAA",
                                   lon > -95 & lon <= -50 & lat > 66 & lat <= 82 ~ "BB",
                                   lon >= -25 & lon <= 145 & lat > 77 & lat <= 90 ~ "SV"),
                         levels = c("BF_CAA", "BB", "SV"))) %>%
    dplyr::select(year, area, lat, lon, xc, yc, seaice_duration, openwater_duration, mean_ice_conc)
  seaice_grid_laea <- bind_rows(seaice_grid_laea, seaice_tmp_laea)
}
seaice_grid_laea <- seaice_grid_laea %>%
  mutate(cell_res = cell_res) # Add cell resolution to dataframe

rm(seaice_tmp, seaice_tmp_laea, i, cell_res) # Remove temporary data
```

Plot mean ice concentration and open water duration per year with the EASE-Grid 2.0 - North projection.

```{r EPSG-6931-map-seaice, message=FALSE, fig.width=8, fig.height=7}
coast_10m_laea <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% # Coastline in laea
  spTransform(CRSobj = crs("EPSG:4326")) %>% # Make sure that the shapefile is in the right projection
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to a dataframe for ggplot
  rename(xc = long, yc = lat)

plot_grid(seaice_grid_laea %>% # Map mean ice concentration
            filter(is.na(mean_ice_conc) == F) %>% # Remove land
            ggplot() +
            geom_tile(aes(x = xc, y = yc, fill = mean_ice_conc)) +
            scale_fill_cmocean("EPSG:6931 - Mean ice concentration (%)", name = "ice") +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
            facet_wrap(~ year, ncol = 3) +
            coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
            theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in"),
                  axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()),
          seaice_grid_laea %>% # Map openwater duration
            filter(is.na(mean_ice_conc) == F) %>% # Remove land
            ggplot() +
            geom_tile(aes(x = xc, y = yc, fill = openwater_duration)) +
            scale_fill_viridis_c("EPSG:6931 - Open water duration (days)", direction = -1) +
            geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
            facet_wrap(~ year, ncol = 3) +
            coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
            theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in"),
                  axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()),
          ncol = 1, align = "hv", axis = "tblr")
```

### EPSG:4326 - WGS84 projection 

```{r EPSG-4326-seaice-grid}
arctic_latlon <- raster(extent(-155, 35, 66, 85), # Base projection for acoustic and CTD data
                        crs = "EPSG:4326", 
                        res = c(2, 1)) # cells of 2 degree longitude per 1 degree latitude

seaice_grid_latlon <- data.frame() # Empty dataframe that will be filled with gridded CTD data

for (i in seq(2015, 2017, 1)) { # Data gridding
  seaice_tmp <- seaice_year %>%
    filter(year == i) 
  # Rasterize data in latlon
  seaice_tmp_latlon <- SpatialPointsDataFrame(SpatialPoints(cbind(seaice_tmp$lon, seaice_tmp$lat), 
                                                            proj4string = CRS("EPSG:4326")),
                                            data.frame(seaice_duration = seaice_tmp$seaice_duration,
                                                       openwater_duration = seaice_tmp$openwater_duration,
                                                       mean_ice_conc = seaice_tmp$mean_ice_conc)) %>%
    rasterize(., arctic_latlon, fun = mean, na.rm = T) %>% # Rasterize data in latlon
    dropLayer(1) %>% # Remove ID layer
    rasterToPoints() %>% # Convert raster to data frame
    as.data.frame() %>%
    rename(lon = x, lat = y) %>% # Rename variables
    mutate(year = i, 
           area = factor(case_when(lon > -155 & lon <= -95 & lat > 65 & lat <= 82 ~ "BF_CAA",
                                   lon > -95 & lon <= -50 & lat > 66 & lat <= 82 ~ "BB",
                                   lon >= -25 & lon <= 145 & lat > 77 & lat <= 90 ~ "SV"),
                         levels = c("BF_CAA", "BB", "SV"))) %>%
    dplyr::select(year, area, lat, lon, seaice_duration, openwater_duration, mean_ice_conc)
  seaice_grid_latlon <- bind_rows(seaice_grid_latlon, seaice_tmp_latlon)
}
rm(seaice_tmp, seaice_tmp_latlon, i) # Remove temporary data
```

Plot mean ice concentration and open water duration per year with the WGS84 projection.

```{r EPSG-4326-map-seaice, message=FALSE, fig.width=10, fig.height=6}
coast_10m_latlon <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% # Coastline in latlon
  spTransform(CRSobj = crs(arctic_latlon)) %>% # Make sure that the shapefile is in the right projection
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  fortify() %>% # Convert to a dataframe for ggplot
  rename(lon = long)

plot_grid(seaice_grid_latlon %>% # Map mean ice concentration
            filter(is.na(mean_ice_conc) == F) %>% # Remove land
            ggplot() +
            geom_tile(aes(x = lon, y = lat, fill = mean_ice_conc)) +
            scale_fill_cmocean("EPSG:4326 - Mean ice concentration (%)", name = "ice") +
            geom_polygon(data = coast_10m_latlon, aes(x = lon, y = lat, group = group), fill = "grey80") +
            facet_wrap(~ year, ncol = 1) +
            coord_cartesian(xlim = c(-155, 40), ylim = c(65, 85), expand = F)  +
            theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in")),
          seaice_grid_latlon %>% # Map absolute salinity
            filter(is.na(mean_ice_conc) == F) %>% # Remove land
            ggplot() +
            geom_tile(aes(x = lon, y = lat, fill = openwater_duration)) +
            scale_fill_viridis_c("EPSG:4326 - Open water duration (days)", direction = -1) +
            geom_polygon(data = coast_10m_latlon, aes(x = lon, y = lat, group = group), fill = "grey80") +
            facet_wrap(~ year, ncol = 1) +
            coord_cartesian(xlim = c(-155, 40), ylim = c(65, 85), expand = F)  +
            theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in")),
          ncol = 2, align = "hv", axis = "tblr")
```

# Arctic Ocean Physics Reanalysis 

The [Arctic Ocean Physics Reanalysis](https://resources.marine.copernicus.eu/product-detail/ARCTIC_MULTIYEAR_PHY_002_003/INFORMATION) dataset was downloaded using a Jupyter notebook. The dataset has a 12.5 km^2^ grid resolution and a specific polar stereographic projection. Because PROJ4 strings are not have been replaced by WKT2 strings in `rgdal`, I need to convert the PROJ4 custom projection of Copernicus into a WKT2 string. I need to verify if the `st_crs` function converts the proj4 string into a WKT2 string correctly.

The variables are: 

* thetao: Temperature degree Celsius
* so: Salinity psu
* vxo: Zonal velocity m/s (x)
* vyo: Meridional velocity m/s (y)
* x: x-coordinate (not longitude, need to be reprojected)
* y: y-coordinate (not latitude, need to be reprojected)
* mlotst: mixed layer thickness (m)
* siconc: sea ice concentration (1)
* sithick: sea ice thickness (m)
* depth: depth in meters
* time: time in hours since 1950-01-01 00:00:00
* latitude: latitude
* longitude: longitude

## Exploratory code

```{r processing-trial-sf}
test_ice <- tidync("data/remote_sensing/physics/20150115_222m_phy_CMEMS.nc") %>% # Read sea ice data and mixed layer depth
  activate("D0,D1,D2") %>%
  hyper_tibble() 
test_oce <- tidync("data/remote_sensing/physics/20150115_222m_phy_CMEMS.nc") %>% # Read temperature, salinity, and current velocity
  activate("D0,D1,D3,D2") %>% # D0 = x, D1 = y, D3 = depth, D2 = time
  hyper_tibble()
test_meta <- tidync("data/remote_sensing/physics/20150115_222m_phy_CMEMS.nc") %>% # Read sea ice data and mixed layer depth
  activate("D0,D1") %>%
  hyper_tibble()

test <- left_join(test_ice, test_oce, by = c("x", "y", "time")) %>% # Combine data
  left_join(., test_meta, by = c("x", "y")) %>%
  filter(is.na(depth) == F) %>% # Remove data from land or below seafloor
  mutate(date = as.POSIXct(time*3600, origin = "1950-01-01 00:00:00", tz = "UTC")) %>% # Calculate date
  rename(lat = latitude, lon = longitude) %>%
  dplyr::select(-time)

proj_original <- "+proj=stere +a=6378273.0 +b=6378273.0 +lon_0=-45.0 +lat_0=90.0 +lat_ts=90.0 +ellps=sphere +units=m" # Define projection

test_sf <- st_as_sf(test, coords = c("x", "y"), crs = proj_original) # Convert dataframe to sf
plot(test_sf["vxo"], axes = TRUE)

test_sf2 <- st_as_sf(test, coords = c("x", "y"), crs = proj_original) %>% # Convert dataframe to sf
  st_transform(., crs = "EPSG:4326") # Transform to EPSG:4326
plot(test_sf2["vxo"], axes = TRUE) # Not working

test_sf3 <- st_as_sf(test, coords = c("lon", "lat"), crs = "EPSG:4326") # Convert dataframe to sf with correct CRS
plot(test_sf3["vxo"], axes = TRUE) # Work

test_sf4 <- st_as_sf(test, coords = c("lon", "lat"), crs = "EPSG:4326") %>% # Convert dataframe to sf with correct CRS
  st_transform(., crs = "EPSG:6931") # Convert to EPSG:6931
plot(test_sf4["vxo"], axes = TRUE) # Work

rm(test_ice, test_meta, test_oce, test_sf, test_sf2, test_sf3, test_sf4, test)
```

Batch processing of Arctic Ocean Physics Reanalysis data. For convenience, all NetCDF data is combined per year and saved as csv. 

```{r physics-csv, eval=FALSE}
for (y in seq(2015, 2017, 1)) { # Loop through data per year
  phy_year <-  data.frame() # Empty dataframe that will be filled with gridded sea ice data
  file_list <- list.files("data/remote_sensing/physics", pattern = paste0(y), full.names = T) # List files per year
  for (i in file_list) { # Loop through each file
    # Read NetCDF 
    phy_ice_tmp <- tidync(i) %>%
      activate("D0,D1,D2") %>% # sea ice data and mixed layer depth
      hyper_tibble()
    phy_oce_tmp <- tidync(i) %>%
      activate("D0,D1,D3,D2") %>% # temperature, salinity, depth, and current velocity
      hyper_tibble()
    phy_coord_tmp <- tidync(i) %>%
      activate("D0,D1") %>% # latitude and longitude
      hyper_tibble()
    # Combine datasets
    phy_tmp <- left_join(phy_ice_tmp, phy_oce_tmp, by = c("x", "y", "time")) %>%
      left_join(., phy_coord_tmp, by = c("x", "y")) %>%
      filter(is.na(depth) == F) %>% # Remove data from land or below seafloor
      mutate(date = as.POSIXct(time * 3600, origin = "1950-01-01 00:00:00", tz = "UTC")) %>% # Calculate date
      rename(lat = latitude, lon = longitude)
    # Append data together
    phy_year <- bind_rows(phy_year, phy_tmp)
  }
  # Write one csv per year
  write_csv(phy_year, file = paste0("data/remote_sensing/physics/physics_reanalysis_", y, ".csv")) 
  print(paste0("Processing of ", y, " data finished."))
}
rm(phy_coord_tmp, phy_ice_tmp, phy_oce_tmp, phy_tmp, phy_year)
```

Tidy csv data and calculate current velocity and angle. I also calculate the annual average of each variable. The annual average dataset will be used for comparison with acoustic data.

```{r physics-tidy, message=FALSE}
phy <- list.files("data/remote_sensing/physics", pattern = "*.csv", full.names = T) %>% # List files
  map_dfr(.f = ~ read_csv(.)) %>% # Read files 
  mutate(year = year(date),
         month = month(date),
         velocity = sqrt(vxo ^ 2 + vyo ^ 2), # current velocity
         v_angle = atan(vyo / vxo) * (180 / pi)) # current direction

phy_year <- phy %>% 
  dplyr::select(- date, - month) %>%
  group_by(year, x, y, depth) %>% # Group by cell by year by depth
  summarise_all(mean) %>% # Calculate annual average for each variable
  ungroup()
```

Plot to check whether calculations worked. This is East Svalbard.

```{r plot-current}
phy %>%
  filter(year == 2015 & month == 2 & depth == 222 & between(x, 7, 15) & between(y, -10, -6)) %>%
  ggplot() +
  geom_raster(aes(x = x, y = y, fill = velocity)) + 
  geom_vector(aes(x = x, y = y, dx = vxo, dy = vyo, mag = velocity),
              arrow.angle = 30, arrow.type = "open", arrow.length = .5,
              pivot = 0, preserve.dir = TRUE, direction = "ccw") +
  scale_fill_cmocean(name = "speed") +
  coord_cartesian()
```

### EPSG:6931 - EASE-Grid 2.0 North (Lambert's equal-area, azimuthal)

Data is projected on the EPSG:6931 projection. 

```{r EPSG-6931-physics-grid}
cell_res <- 50 # Cell resolution in km
arctic_laea <- raster(extent(-2700, 2700, -2700, 2700), crs = "EPSG:6931") # Seaice projection
projection(arctic_laea) <- gsub("units=m", "units=km", projection(arctic_laea)) # Convert proj unit from m to km
res(arctic_laea) <- c(cell_res, cell_res) # Define the 100 km cell resolution

phy_grid_laea <- data.frame() # Empty dataframe

for (i in seq(2015, 2017, 1)) { # Loop through each year
  for (j in c(0, 222, 380, 644, 1062)) { # Loop through each depth bin
    phy_year_tmp <- phy_year %>%
      filter(year == i & depth == j) # Select depth bin
    # Rasterize data in laea
    phy_tmp_laea <- SpatialPointsDataFrame(SpatialPoints(cbind(phy_year_tmp$lon, phy_year_tmp$lat),
                                                         proj4string = CRS("EPSG:4326")), 
                                           data.frame(lat = phy_year_tmp$lat,
                                                      lon = phy_year_tmp$lon,
                                                      depth = phy_year_tmp$depth,
                                                      mlotst = phy_year_tmp$mlotst,
                                                      siconc = phy_year_tmp$siconc,
                                                      sithick = phy_year_tmp$sithick,
                                                      thetao = phy_year_tmp$thetao,
                                                      so = phy_year_tmp$so,
                                                      velocity = phy_year_tmp$velocity,
                                                      vxo = phy_year_tmp$vxo,
                                                      vyo = phy_year_tmp$vyo)) %>%
      spTransform(., CRSobj = crs(arctic_laea)) %>% # Change projection to EPSG:6931
      rasterize(., arctic_laea, fun = mean, na.rm = T) %>% # Rasterize on the arctic_laea grid (with correct grid resolution)
      dropLayer(1) %>% # Remove ID layer
      rasterToPoints() %>% # Convert raster to data frame
      as.data.frame() %>%
      rename(xc = x, yc = y) %>% # Rename variables
      mutate(year = i, 
             depth = j,
             area = factor(case_when(lon > -155 & lon <= -95 & lat > 65 & lat <= 82 ~ "BF_CAA",
                                     lon > -95 & lon <= -50 & lat > 66 & lat <= 82 ~ "BB",
                                     lon >= -25 & lon <= 145 & lat > 77 & lat <= 90 ~ "SV"),
                           levels = c("BF_CAA", "BB", "SV"))) %>%
      dplyr::select(year, area, lat, lon, xc, yc, depth, mlotst, siconc, sithick, thetao, so, velocity, vxo, vyo) 
    phy_grid_laea <- bind_rows(phy_grid_laea, phy_tmp_laea)
  }
}

rm(phy_year_tmp, phy_tmp_laea, i, j) # Remove temporary data

phy_grid_laea <- phy_grid_laea %>%
  mutate(cell_res = cell_res) # Add cell resolution to dataframe
```

Gridding worked correctly.

```{r EPSG-6931-map-physics, message=FALSE, fig.height=10, fig.width=6}
coast_10m_laea <- readOGR("data/bathy/ne_10m_land.shp", verbose = F) %>% # Coastline in laea
  spTransform(CRSobj = crs("EPSG:4326")) %>% # Make sure that the shapefile is in the right projection
  crop(extent(-180, 180, 0, 90)) %>% # Crop shapefile
  spTransform(CRSobj = crs(arctic_laea)) %>% # Project shapefile in laea
  fortify() %>% # Convert to a dataframe for ggplot
  rename(xc = long, yc = lat)

phy_grid_laea %>% # Map current velocity at 222 m
  # filter(depth == 222) %>% # Select depth bin
  ggplot() +
  geom_tile(aes(x = xc, y = yc, fill = velocity)) +
  scale_fill_cmocean("EPSG:6931 - Current velocity(m/s)", name = "speed") +
  geom_polygon(data = coast_10m_laea, aes(x = xc, y = yc, group = group), fill = "grey80") +
  facet_grid(depth ~ year) +
  coord_fixed(xlim = c(-2600, 1100), ylim = c(-1800, 1900), expand = F) + 
  theme(legend.position = "top", legend.key.height = unit(0.1, "in"), legend.key.width = unit(0.3, "in"),
        axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

# Save data 

```{r save-data}
save(seaice_grid_laea, seaice_grid_latlon, file = "data/remote_sensing/seaice_grids.RData") # Save data
save(phy_grid_laea, file = "data/remote_sensing/physics_grids.RData") # Save data
```